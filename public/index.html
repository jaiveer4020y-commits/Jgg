<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />

<title>Art Player</title>

<!-- ArtPlayer -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/artplayer/dist/artplayer.css" />
<script src="https://cdn.jsdelivr.net/npm/artplayer/dist/artplayer.js"></script>

<!-- HLS -->
<script src="https://cdn.jsdelivr.net/npm/hls.js@1.5.15/dist/hls.min.js"></script>

<style>
html, body {
    margin: 0;
    padding: 0;
    background: #000;
    height: 100%;
    overflow: hidden;
}

#player {
    width: 100vw;
    height: 100vh;
    background: #000;
}

/* Netflix spinner */
.art-loading::after {
    content: '';
    width: 50px;
    height: 50px;
    border: 4px solid rgba(255,255,255,.2);
    border-top-color: #fff;
    border-radius: 50%;
    animation: spin 1s linear infinite;
}

@keyframes spin {
    to { transform: rotate(360deg); }
}

/* Jump buttons */
.jump-btn {
    width: 28px;
    height: 28px;
}
</style>
</head>

<body>
<div id="player"></div>

<script>
/* -------------------------------
   URL PARAMS
-------------------------------- */
const params = new URLSearchParams(location.search);

const title   = params.get('title');    // REQUIRED
const imdbId  = params.get('id');       // for subtitles
const season  = params.get('season');
const episode = params.get('episode');

if (!title) {
    document.body.innerHTML = '<h2 style="color:white;text-align:center">Missing title</h2>';
    throw new Error('Title missing');
}

/* -------------------------------
   API ENDPOINTS
-------------------------------- */
const STREAM_API = `https://u-1-1azw.onrender.com/api/get-stream?title=${encodeURIComponent(title)}`;
const PROXY = 'https://workingg.vercel.app/api/proxy?url=';

/* -------------------------------
   FETCH STREAM
-------------------------------- */
async function getStream() {
    const res = await fetch(STREAM_API);
    const data = await res.json();
    if (!data?.url) throw new Error('Stream not found');
    return PROXY + encodeURIComponent(data.url);
}

/* -------------------------------
   FETCH SUBTITLES
-------------------------------- */
async function getSubtitles() {
    if (!imdbId) return [];

    let subUrl;
    if (season && episode) {
        subUrl = `https://sub.wyzie.ru/search?id=${imdbId}&season=${season}&episode=${episode}`;
    } else {
        subUrl = `https://sub.wyzie.ru/search?id=${imdbId}`;
    }

    const res = await fetch(PROXY + encodeURIComponent(subUrl));
    const data = await res.json();
    return Array.isArray(data) ? data : [];
}

/* -------------------------------
   INIT PLAYER
-------------------------------- */
(async () => {

const streamUrl = await getStream();
const subtitles = await getSubtitles();

let hls;

/* ArtPlayer */
const art = new Artplayer({
    container: '#player',
    url: streamUrl,
    type: 'm3u8',
    autoplay: true,
    autoSize: true,
    fullscreen: true,
    fullscreenWeb: true,
    airplay: true,
    pip: true,
    setting: true,
    playbackRate: true,
    aspectRatio: true,
    subtitleOffset: true,
    miniProgressBar: true,
    mutex: true,
    fastForward: true,
    autoOrientation: true,
    autoPlayback: true,
    lock: true,
    controls: [
        {
            name: 'backward',
            position: 'left',
            html: `<img class="jump-btn" src="https://rivestream.org/images/player/backward.svg">`,
            click: () => art.currentTime -= 10
        },
        {
            name: 'play',
            position: 'left',
            html: `<img class="jump-btn" src="https://rivestream.org/images/player/play.svg">`,
            click: () => art.toggle()
        },
        {
            name: 'forward',
            position: 'left',
            html: `<img class="jump-btn" src="https://rivestream.org/images/player/forward.svg">`,
            click: () => art.currentTime += 10
        }
    ],
    customType: {
        m3u8(video, url) {
            if (Hls.isSupported()) {
                hls = new Hls({
                    enableWorker: true,
                    backBufferLength: 90,
                });
                hls.loadSource(url);
                hls.attachMedia(video);
            } else {
                video.src = url;
            }
        }
    }
});

/* -------------------------------
   SETTINGS: QUALITY / AUDIO / SUBS
-------------------------------- */
art.on('ready', () => {

    /* QUALITY */
    if (hls?.levels?.length) {
        art.setting.add({
            name: 'Quality',
            selector: [
                { html: 'Auto', value: -1 },
                ...hls.levels.map((l, i) => ({
                    html: `${l.height}p`,
                    value: i
                }))
            ],
            onSelect(item) {
                hls.currentLevel = item.value;
                return item.html;
            }
        });
    }

    /* AUDIO (NO AUDIO BUTTON, SETTINGS ONLY) */
    if (hls?.audioTracks?.length > 1) {
        art.setting.add({
            name: 'Audio',
            selector: hls.audioTracks.map((t, i) => ({
                html: t.name || `Track ${i+1}`,
                value: i
            })),
            onSelect(item) {
                hls.audioTrack = item.value;
                return item.html;
            }
        });
    }

    /* SUBTITLES */
    if (subtitles.length) {
        art.setting.add({
            name: 'Subtitles',
            selector: subtitles.map((s, i) => ({
                html: s.lang || s.language || `Sub ${i+1}`,
                value: i
            })),
            onSelect(item) {
                const s = subtitles[item.value];
                art.subtitle = {
                    url: s.url,
                    type: s.url.endsWith('.srt') ? 'srt' : 'vtt',
                    encoding: 'utf-8'
                };
                return item.html;
            }
        });
    }
});

/* -------------------------------
   ERROR HANDLING
-------------------------------- */
art.on('error', err => {
    console.error('Player error', err);
});

})();
</script>
</body>
</html>
