<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Final Stable Player</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/artplayer@5/dist/artplayer.css">

<style>
html, body {
    margin: 0;
    padding: 0;
    background: #000;
    height: 100%;
}

#player {
    width: 100%;
    max-width: 960px;
    height: 540px;
    margin: auto;
    background: #000;
    position: relative;
}

/* ===== Center Controls ===== */
.center-ui {
    position: absolute;
    inset: 0;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 120px;
    opacity: 0;
    transition: opacity .25s ease;
    z-index: 20;
    pointer-events: none;
}

.art-state-show .center-ui {
    opacity: 1;
    pointer-events: auto;
}

.center-ui img {
    width: 64px;
    height: 64px;
    opacity: .9;
}

.center-ui .play img {
    width: 90px;
    height: 90px;
}

/* ===== Subtitle ===== */
.art-subtitle {
    font-size: 22px !important;
    background: rgba(0,0,0,.45);
    padding: 4px 10px;
    border-radius: 4px;
    text-shadow: 2px 2px 6px #000;
}
</style>
</head>

<body>

<div id="player"></div>

<script src="https://cdn.jsdelivr.net/npm/hls.js@1.5.15"></script>
<script src="https://cdn.jsdelivr.net/npm/artplayer@5/dist/artplayer.js"></script>

<script>
(async () => {

    /* =========================
       CONFIG
    ========================= */
    const PROXY = 'https://workingg.vercel.app/api/proxy?url=';

    const params = new URLSearchParams(location.search);
    const title = params.get('title');

    if (!title) {
        document.body.innerHTML = '<h2 style="color:white;text-align:center">Missing title</h2>';
        return;
    }

    /* =========================
       FETCH STREAM
    ========================= */
    const streamRes = await fetch(
        PROXY + encodeURIComponent(
            'https://u-1-1azw.onrender.com/api/get-stream?title=' + title
        )
    );

    const stream = await streamRes.json();
    if (!stream?.m3u8_url) {
        alert('Stream error');
        return;
    }

    const M3U8 = PROXY + encodeURIComponent(stream.m3u8_url);

    /* =========================
       FETCH SUBTITLE (VTT)
    ========================= */
    let subtitleVtt = null;

    if (stream.imdb) {
        try {
            const subRes = await fetch(
                PROXY + encodeURIComponent(
                    'https://sub.wyzie.ru/search?id=' + stream.imdb
                )
            );
            const sub = await subRes.json();

            // MUST BE VTT
            subtitleVtt = sub?.subtitles?.find(s => s.format === 'vtt')?.url || null;
        } catch {}
    }

    /* =========================
       INIT PLAYER
    ========================= */
    let hlsInstance;

    const art = new Artplayer({
        container: '#player',
        url: M3U8,
        type: 'm3u8',

        autoplay: true,
        muted: true,   // iOS REQUIRED
        volume: 1,

        setting: true,
        playbackRate: true,
        aspectRatio: true,
        fullscreen: true,
        fullscreenWeb: true,

        subtitle: subtitleVtt ? {
            url: subtitleVtt,
            type: 'vtt',
            encoding: 'utf-8',
            style: true
        } : null,

        layers: [{
            name: 'center-ui',
            html: `
            <div class="center-ui">
                <div class="btn back"><img src="https://rivestream.org/images/player/backward.svg"></div>
                <div class="btn play"><img src="https://rivestream.org/images/player/play.svg"></div>
                <div class="btn forward"><img src="https://rivestream.org/images/player/forward.svg"></div>
            </div>`
        }],

        customType: {
            m3u8(video, url) {
                if (hlsInstance) return; // PREVENT RECONNECT LOOP

                if (Hls.isSupported()) {
                    hlsInstance = new Hls({
                        enableWorker: true,
                        maxBufferLength: 30,
                        maxMaxBufferLength: 60,
                        fragLoadingMaxRetry: 2,
                        levelLoadingMaxRetry: 2
                    });

                    hlsInstance.loadSource(url);
                    hlsInstance.attachMedia(video);

                    hlsInstance.on(Hls.Events.MANIFEST_PARSED, () => {
                        const qualities = hlsInstance.levels.map((l, i) => ({
                            html: l.height + 'p',
                            level: i
                        }));

                        art.setting.add({
                            name: 'quality',
                            html: 'Quality',
                            selector: qualities,
                            onSelect(item) {
                                hlsInstance.currentLevel = item.level;
                                return item.html;
                            }
                        });
                    });
                } else {
                    video.src = url;
                }
            }
        }
    });

    /* =========================
       CENTER CONTROLS
    ========================= */
    art.on('ready', () => {
        const play = document.querySelector('.btn.play');
        const back = document.querySelector('.btn.back');
        const forward = document.querySelector('.btn.forward');

        play.onclick = () => {
            art.toggle();
            art.muted = false; // AUDIO UNLOCK
        };

        back.onclick = () => art.seek = art.currentTime - 10;
        forward.onclick = () => art.seek = art.currentTime + 10;
    });

})();
</script>

</body>
</html>
