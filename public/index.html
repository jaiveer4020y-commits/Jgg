<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>CINEMA QUANTUM ENGINE | V9.0 ENTERPRISE</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    
    <link rel="stylesheet" href="https://unpkg.com/artplayer@5.3.0/dist/artplayer.css">
    <script src="https://unpkg.com/hls.js@1.5.17/dist/hls.min.js"></script>
    <script src="https://unpkg.com/artplayer@5.3.0/dist/artplayer.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800;900&display=swap" rel="stylesheet">

    <style>
        /* ================================================================
        1. MASTER DESIGN SYSTEM (CSS VARIABLES)
        ================================================================
        */
        :root {
            --nf-red: #E50914;
            --nf-black: #050505;
            --nf-dark-grey: #141414;
            --nf-mid-grey: #2f2f2f;
            --nf-light-grey: #b3b3b3;
            --glass-bg: rgba(20, 20, 20, 0.7);
            --blur-standard: blur(25px);
            --transition-smooth: cubic-bezier(0.4, 0, 0.2, 1);
            --rive-elastic: cubic-bezier(0.68, -0.6, 0.32, 1.6);
            --shadow-xl: 0 25px 50px -12px rgba(0, 0, 0, 0.7);
        }

        /* ================================================================
        2. GLOBAL RESET & SCROLLBARS
        ================================================================
        */
        * { box-sizing: border-box; -webkit-font-smoothing: antialiased; }
        body, html {
            margin: 0; padding: 0; width: 100vw; height: 100vh;
            background-color: var(--nf-black); color: #fff;
            font-family: 'Inter', sans-serif; overflow: hidden;
        }

        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: #111; }
        ::-webkit-scrollbar-thumb { background: var(--nf-red); border-radius: 10px; }

        /* ================================================================
        3. CINEMA DASHBOARD (DESKTOP & MOBILE)
        ================================================================
        */
        #quantum-dashboard {
            position: fixed; inset: 0; z-index: 100;
            background: radial-gradient(circle at top, #1e1e1e 0%, #050505 100%);
            display: flex; align-items: center; justify-content: center;
            transition: transform 0.8s var(--transition-smooth), opacity 0.5s;
        }

        .dashboard-hidden { transform: translateY(-100%); opacity: 0; pointer-events: none; }

        .quantum-card {
            width: 92%; max-width: 500px; padding: 45px;
            background: var(--glass-bg); backdrop-filter: var(--blur-standard);
            border: 1px solid rgba(255,255,255,0.08); border-radius: 16px;
            box-shadow: var(--shadow-xl); position: relative;
        }

        .brand-logo {
            font-size: 2.8rem; font-weight: 900; color: var(--nf-red);
            text-align: center; margin-bottom: 35px; letter-spacing: -2px;
            text-transform: uppercase; text-shadow: 0 0 25px rgba(229, 9, 20, 0.3);
        }

        /* Mode Selector */
        .mode-selector {
            display: flex; gap: 10px; margin-bottom: 25px;
            background: rgba(0,0,0,0.4); padding: 5px; border-radius: 10px;
        }
        .mode-btn {
            flex: 1; padding: 12px; border: none; border-radius: 8px;
            background: transparent; color: var(--nf-light-grey);
            font-weight: 700; font-size: 13px; cursor: pointer;
            transition: all 0.3s;
        }
        .mode-btn.active { background: var(--nf-red); color: #fff; box-shadow: 0 5px 15px rgba(229, 9, 20, 0.4); }

        .input-wrap { margin-bottom: 20px; position: relative; }
        .input-wrap label {
            display: block; font-size: 10px; font-weight: 800; color: var(--nf-red);
            text-transform: uppercase; margin-bottom: 8px; letter-spacing: 1.5px;
        }

        .main-input {
            width: 100%; padding: 18px; background: #0a0a0a; border: 1px solid #222;
            border-radius: 8px; color: #fff; font-size: 16px; font-weight: 500;
            transition: border-color 0.4s var(--transition-smooth);
        }
        .main-input:focus { border-color: var(--nf-red); outline: none; }

        .grid-inputs { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; }

        .launch-action {
            width: 100%; padding: 20px; background: var(--nf-red); color: #fff;
            border: none; border-radius: 8px; font-weight: 900; font-size: 18px;
            cursor: pointer; text-transform: uppercase; letter-spacing: 1px;
            margin-top: 15px; transition: transform 0.2s;
        }
        .launch-action:hover { transform: scale(1.02); }

        /* ================================================================
        4. TMDB SEARCH ENGINE OVERLAY
        ================================================================
        */
        #search-results-overlay {
            position: absolute; top: 100%; left: 0; right: 0;
            background: #111; border: 1px solid #333; border-radius: 8px;
            margin-top: 10px; max-height: 350px; overflow-y: auto;
            z-index: 5000; display: none; box-shadow: 0 10px 30px rgba(0,0,0,0.8);
        }
        .search-node {
            display: flex; gap: 15px; padding: 12px; border-bottom: 1px solid #222;
            cursor: pointer; transition: background 0.2s;
        }
        .search-node:hover { background: #1a1a1a; }
        .search-node img { width: 45px; height: 68px; object-fit: cover; border-radius: 4px; }
        .search-node .info { display: flex; flex-direction: column; justify-content: center; }
        .search-node h5 { margin: 0; font-size: 14px; color: #fff; }
        .search-node p { margin: 4px 0 0; font-size: 11px; color: #777; }

        /* ================================================================
        5. QUANTUM LOADING SCREEN (DYNAMIC)
        ================================================================
        */
        #quantum-loader {
            position: fixed; inset: 0; z-index: 900; background: #000;
            display: none; align-items: center; justify-content: center;
        }
        
        #loader-backdrop {
            position: absolute; inset: 0; width: 100%; height: 100%;
            object-fit: cover; opacity: 0; transition: opacity 2s;
        }

        .loader-ui {
            z-index: 10; text-align: center; max-width: 80%;
        }

        .netflix-spinner {
            width: 80px; height: 80px;
            background: url('https://assets.nflxext.com/en_us/pages/wiplayer/site-spinner.png') no-repeat;
            background-size: contain; margin: 0 auto 30px;
            animation: nf-spin 1.2s steps(12) infinite;
        }

        #meta-title { font-size: 32px; font-weight: 900; margin-bottom: 5px; color: #fff; }
        #meta-status { font-size: 12px; color: var(--nf-red); font-weight: 700; text-transform: uppercase; letter-spacing: 3px; }

        @keyframes nf-spin { 100% { transform: rotate(360deg); } }

        /* ================================================================
        6. ARTPLAYER QUANTUM UI (NETFLIX CLONE)
        ================================================================
        */
        #viewport { position: fixed; inset: 0; background: #000; z-index: 1000; display: none; }

        /* Custom Layer: Netflix Centered Icons */
        .art-layer-netflix-hub {
            position: absolute; inset: 0; display: flex; align-items: center;
            justify-content: center; gap: 12vw; pointer-events: none;
            opacity: 0; transition: opacity 0.4s var(--transition-smooth);
        }

        /* Show hub when player is hovered or paused */
        .art-hover .art-layer-netflix-hub,
        .art-state-paused .art-layer-netflix-hub { opacity: 1; }

        .quantum-icon-circle {
            width: 70px; height: 70px; border-radius: 50%;
            background: rgba(0,0,0,0.5); border: 1.5px solid rgba(255,255,255,0.15);
            display: flex; align-items: center; justify-content: center;
            cursor: pointer; pointer-events: auto; backdrop-filter: blur(10px);
            transition: transform 0.3s var(--rive-elastic), background 0.3s;
        }
        .quantum-icon-circle:hover { transform: scale(1.15); background: rgba(255, 255, 255, 0.1); border-color: #fff; }
        .quantum-icon-circle:active { transform: scale(0.9); }
        .quantum-icon-circle svg { width: 32px; height: 32px; fill: #fff; }

        .play-main { width: 90px; height: 90px; }
        .play-main svg { width: 45px; height: 45px; }

        /* Subtitle Positioning */
        #sub-container {
            position: absolute; bottom: 15%; width: 100%;
            display: flex; justify-content: center; pointer-events: none;
            z-index: 1500;
        }
        #sub-render {
            background: rgba(0,0,0,0.75); color: #fff; padding: 5px 20px;
            font-size: clamp(18px, 4vw, 30px); font-weight: 500;
            border-radius: 4px; text-shadow: 0 2px 4px #000;
            line-height: 1.4; text-align: center; display: none;
        }

        /* Overrides */
        .art-loading-icon { display: none !important; }
        .art-loading-layer { display: block !important; }
        .art-loading .netflix-spinner { display: block; position: absolute; top:50%; left:50%; transform:translate(-50%,-50%); }

        .back-nav {
            position: absolute; top: 25px; left: 25px; z-index: 10001;
            cursor: pointer; background: rgba(0,0,0,0.4); padding: 12px;
            border-radius: 50%; border: 1px solid rgba(255,255,255,0.1);
            transition: background 0.3s;
        }
        .back-nav:hover { background: var(--nf-red); }

    </style>
</head>
<body>

<div id="quantum-dashboard">
    <div class="quantum-card">
        <div class="brand-logo">Cinema Pro</div>
        
        <div class="mode-selector">
            <button class="mode-btn active" id="mode-tv" onclick="switchMode('tv')">SERIES</button>
            <button class="mode-btn" id="mode-movie" onclick="switchMode('movie')">MOVIE</button>
        </div>

        <div class="input-wrap">
            <label>Master Search</label>
            <input type="text" id="engine-search" class="main-input" placeholder="Start typing title..." autocomplete="off">
            <div id="search-results-overlay"></div>
        </div>

        <div id="se-logic-container">
            <div class="grid-inputs">
                <div class="input-wrap">
                    <label>Season</label>
                    <input type="number" id="season-val" class="main-input" value="1">
                </div>
                <div class="input-wrap">
                    <label>Episode</label>
                    <input type="number" id="episode-val" class="main-input" value="1">
                </div>
            </div>
        </div>

        <button class="launch-action" onclick="bootstrapStream()">Launch Quantum Player</button>
    </div>
</div>

<div id="quantum-loader">
    <img id="loader-backdrop" src="">
    <div class="loader-ui">
        <div class="netflix-spinner"></div>
        <div id="meta-title">STREAMS FOUND</div>
        <div id="meta-status">Initializing Proxy Tunner...</div>
    </div>
</div>

<div id="viewport">
    <div class="back-nav" onclick="killEngine()">
        <svg viewBox="0 0 24 24" width="24" height="24" fill="white"><path d="M20 11H7.83l5.59-5.59L12 4l-8 8 8 8 1.41-1.41L7.83 13H20v-2z"/></svg>
    </div>
    <div id="art-target" style="width:100%; height:100%;"></div>
    <div id="sub-container"><div id="sub-render"></div></div>
</div>

<script>
/**
 * CINEMA QUANTUM CORE ENGINE v9.0
 * Logic: Resolver Matrix, AirPlay Support, GlassUI, Pro Settings
 */

const CORE = {
    KEY: '463dcd7993ab31d92eb586802fdeee6a',
    PROXY: (u) => `https://workingg.vercel.app/api/proxy?url=${encodeURIComponent(u)}`,
    MODE: 'tv',
    SELECTED_ID: null,
    SELECTED_TITLE: '',
    SELECTED_YEAR: '',
    PLAYER: null,
    CUES: [],
    SUB_SYNC: 0
};

// 1. DYNAMIC SEARCH & TMDB BRIDGE
const searchBar = document.getElementById('engine-search');
const overlay = document.getElementById('search-results-overlay');

searchBar.addEventListener('input', async (e) => {
    const val = e.target.value;
    if(val.length < 2) { overlay.style.display = 'none'; return; }

    try {
        const r = await fetch(`https://api.themoviedb.org/3/search/multi?api_key=${CORE.KEY}&query=${encodeURIComponent(val)}`);
        const data = await r.json();
        
        overlay.innerHTML = '';
        if(data.results) {
            overlay.style.display = 'block';
            data.results.slice(0, 8).forEach(m => {
                if(m.media_type !== 'tv' && m.media_type !== 'movie') return;
                
                const year = (m.release_date || m.first_air_date || '').split('-')[0];
                const node = document.createElement('div');
                node.className = 'search-node';
                node.innerHTML = `
                    <img src="https://image.tmdb.org/t/p/w92${m.poster_path}" onerror="this.src='https://via.placeholder.com/92x138/111/fff?text=No+Img'">
                    <div class="info">
                        <h5>${m.title || m.name}</h5>
                        <p>${m.media_type.toUpperCase()} â€¢ ${year}</p>
                    </div>
                `;
                node.onclick = () => {
                    CORE.SELECTED_ID = m.id;
                    CORE.SELECTED_TITLE = m.title || m.name;
                    CORE.SELECTED_YEAR = year;
                    CORE.MODE = m.media_type;
                    
                    searchBar.value = CORE.SELECTED_TITLE;
                    updateDashboardMode(CORE.MODE);
                    overlay.style.display = 'none';
                };
                overlay.appendChild(node);
            });
        }
    } catch(err) { console.error("Search Error"); }
});

function updateDashboardMode(m) {
    CORE.MODE = m;
    document.querySelectorAll('.mode-btn').forEach(b => b.classList.remove('active'));
    document.getElementById(`mode-${m}`).classList.add('active');
    document.getElementById('se-logic-container').style.display = m === 'tv' ? 'block' : 'none';
}

function switchMode(m) {
    updateDashboardMode(m);
    searchBar.value = '';
    CORE.SELECTED_ID = null;
}

// 2. QUANTUM RESOLVER (THE FIX)
async function bootstrapStream() {
    if(!CORE.SELECTED_ID) return alert("Please select a title first");
    
    const s = document.getElementById('season-val').value;
    const e = document.getElementById('episode-val').value;

    // Show Loader with Backdrop
    document.getElementById('quantum-loader').style.display = 'flex';
    document.getElementById('meta-title').innerText = CORE.SELECTED_TITLE;
    
    const metaRaw = await fetch(`https://api.themoviedb.org/3/${CORE.MODE}/${CORE.SELECTED_ID}?api_key=${CORE.KEY}`).then(r=>r.json());
    if(metaRaw.backdrop_path) {
        const bg = document.getElementById('loader-backdrop');
        bg.src = `https://image.tmdb.org/t/p/original${metaRaw.backdrop_path}`;
        bg.style.opacity = '0.4';
    }

    // SLUG MATRIX GENERATION
    const clean = (t) => t.toLowerCase().replace(/[^a-z0-9\s]/gi, '').trim().replace(/\s+/g, '.');
    const baseSlug = clean(CORE.SELECTED_TITLE);
    
    const slugs = [];
    if(CORE.MODE === 'tv') {
        const padS = s.toString().padStart(2, '0');
        const padE = e.toString().padStart(2, '0');
        slugs.push(`${baseSlug}.s${padS}.e${padE}`); // Standard: title.s01.e01
        slugs.push(`${baseSlug}.s${s}.e${e}`);       // Short: title.s1.e1
        slugs.push(`${baseSlug}.season.${s}.episode.${e}`); // Long
    } else {
        slugs.push(`${baseSlug}.${CORE.SELECTED_YEAR}`);
        slugs.push(baseSlug);
    }

    let finalStream = null;
    for(let slug of slugs) {
        document.getElementById('meta-status').innerText = `Probing: ${slug}`;
        try {
            const api = `https://u-1-1azw.onrender.com/api/get-stream?title=${encodeURIComponent(slug)}&id=${CORE.SELECTED_ID}&season=${s}&episode=${e}`;
            const res = await fetch(CORE.PROXY(api)).then(r=>r.json());
            if(res.m3u8_url) { finalStream = res; break; }
        } catch(e) {}
    }

    if(!finalStream) {
        alert("Quantum Resolution Failed. No streams found for these parameters.");
        document.getElementById('quantum-loader').style.display = 'none';
        return;
    }

    // SUBTITLE FETCH
    document.getElementById('meta-status').innerText = "Inlining Subtitles...";
    let subUrl = `https://sub.wyzie.ru/search?id=${CORE.SELECTED_ID}`;
    if(CORE.MODE === 'tv') subUrl += `&season=${s}&episode=${e}`;
    const subRes = await fetch(CORE.PROXY(subUrl)).then(r=>r.json()).catch(()=>[]);

    initializeQuantumPlayer(CORE.PROXY(finalStream.m3u8_url), subRes);
}

// 3. ARTPLAYER QUANTUM CORE
function initializeQuantumPlayer(m3u8, subs) {
    document.getElementById('viewport').style.display = 'block';
    document.getElementById('quantum-loader').style.display = 'none';
    document.getElementById('quantum-dashboard').classList.add('dashboard-hidden');

    CORE.PLAYER = new Artplayer({
        container: '#art-target',
        url: m3u8,
        type: 'm3u8',
        autoplay: true,
        autoSize: true,
        fullscreen: true,
        setting: true,
        theme: '#E50914',
        lock: true,
        fastForward: true,
        autoPlayback: true,
        airplay: true, // NATIVE APPLE SUPPORT
        pip: true,
        
        layers: [
            {
                name: 'netflix-hub',
                html: `
                    <div class="art-layer-netflix-hub">
                        <div class="quantum-icon-circle" onclick="CORE.PLAYER.backward=10">
                            <svg viewBox="0 0 24 24"><path d="M12.5 8c-2.65 0-5.05 1.05-6.9 2.75L2 7v9h9l-3.62-3.62c1.39-1.2 3.16-1.88 5.12-1.88 3.54 0 6.55 2.31 7.6 5.5l2.37-.78C21.08 11.03 17.15 8 12.5 8z"/></svg>
                        </div>
                        <div class="quantum-icon-circle play-main" onclick="CORE.PLAYER.toggle()">
                            <svg viewBox="0 0 24 24" id="play-state-icon"><path d="M8 5v14l11-7z"/></svg>
                        </div>
                        <div class="quantum-icon-circle" onclick="CORE.PLAYER.forward=10">
                            <svg viewBox="0 0 24 24"><path d="M11.5 8c2.65 0 5.05 1.05 6.9 2.75L22 7v9h-9l3.62-3.62c-1.39-1.2-3.16-1.88-5.12-1.88-3.54 0-6.55 2.31-7.6 5.5l-2.37-.78C2.92 11.03 6.85 8 11.5 8z"/></svg>
                        </div>
                    </div>
                `
            },
            {
                name: 'loading-spinner',
                html: `<div class="netflix-spinner" style="display:none"></div>`
            }
        ],

        customType: {
            m3u8: function(video, url) {
                if (Hls.isSupported()) {
                    const hls = new Hls({
                        capLevelToPlayerSize: true,
                        enableWorker: true,
                        lowLatencyMode: true,
                        backBufferLength: 90
                    });
                    hls.loadSource(url);
                    hls.attachMedia(video);
                    
                    hls.on(Hls.Events.MANIFEST_PARSED, () => {
                        // QUALITY HUB
                        const levels = hls.levels.map((l, i) => ({
                            html: `${l.height}p`,
                            level: i
                        }));
                        CORE.PLAYER.setting.add({
                            name: 'quality',
                            html: 'Video Quality',
                            selector: [{html: 'Auto', level: -1, default: true}, ...levels],
                            onSelect: (item) => { hls.currentLevel = item.level; return item.html; }
                        });

                        // AUDIO TRACKS HUB
                        if(hls.audioTracks.length > 0) {
                            CORE.PLAYER.setting.add({
                                name: 'audio',
                                html: 'Audio Track',
                                selector: hls.audioTracks.map((t, i) => ({
                                    html: t.name || t.lang || `Track ${i+1}`,
                                    index: i
                                })),
                                onSelect: (item) => { hls.audioTrack = item.index; return item.html; }
                            });
                        }
                    });
                } else if (video.canPlayType('application/vnd.apple.mpegurl')) {
                    // NATIVE SAFARI/APPLE PLAYER
                    video.src = url;
                }
            }
        }
    });

    // Subtitle Setup
    CORE.PLAYER.on('ready', () => {
        if(subs.length > 0) {
            CORE.PLAYER.setting.add({
                name: 'subtitle',
                html: 'Subtitles',
                selector: [
                    {html: 'Off', url: null, default: true},
                    ...subs.map(s => ({html: s.lang || s.language, url: CORE.PROXY(s.url)}))
                ],
                onSelect: async (item) => {
                    if(!item.url) { CORE.CUES = []; document.getElementById('sub-render').style.display = 'none'; return 'Off'; }
                    const txt = await fetch(item.url).then(r=>r.text());
                    CORE.CUES = parseQuantumVTT(txt);
                    document.getElementById('sub-render').style.display = 'inline-block';
                    return item.html;
                }
            });

            CORE.PLAYER.setting.add({
                name: 'sub-delay',
                html: 'Subtitle Sync',
                selector: [
                    {html: '-2.0s', v: -2}, {html: '-0.5s', v: -0.5},
                    {html: 'Sync', v: 0, default: true},
                    {html: '+0.5s', v: 0.5}, {html: '+2.0s', v: 2}
                ],
                onSelect: (item) => { CORE.SUB_SYNC = item.v; return item.html; }
            });
        }
    });

    // Subtitle Engine (Time Tracking)
    CORE.PLAYER.on('video:timeupdate', () => {
        if(!CORE.CUES.length) return;
        const now = CORE.PLAYER.currentTime + CORE.SUB_SYNC;
        const match = CORE.CUES.find(c => now >= c.start && now <= c.end);
        document.getElementById('sub-render').innerHTML = match ? match.text : '';
    });

    // Play/Pause Icon Swap
    CORE.PLAYER.on('play', () => {
        document.getElementById('play-state-icon').innerHTML = '<path d="M6 19h4V5H6v14zm8-14v14h4V5h-4z"/>';
    });
    CORE.PLAYER.on('pause', () => {
        document.getElementById('play-state-icon').innerHTML = '<path d="M8 5v14l11-7z"/>';
    });
}

// 4. PARSER UTILITIES
function parseQuantumVTT(vtt) {
    const list = [];
    const segments = vtt.split(/\n\s*\n/);
    segments.forEach(s => {
        const lines = s.split('\n').filter(l => l.trim() !== '');
        if(lines.length >= 2 && lines[0].includes('-->')) {
            const t = lines[0].split('-->');
            list.push({ start: timeToSec(t[0]), end: timeToSec(t[1]), text: lines.slice(1).join('<br>') });
        } else if(lines.length >= 3 && lines[1].includes('-->')) {
            const t = lines[1].split('-->');
            list.push({ start: timeToSec(t[0]), end: timeToSec(t[1]), text: lines.slice(2).join('<br>') });
        }
    });
    return list;
}

function timeToSec(str) {
    const p = str.trim().split(':');
    let h=0, m=0, s=0;
    if(p.length === 3) { [h, m, s] = p; } else { [m, s] = p; }
    return (+h) * 3600 + (+m) * 60 + parseFloat(s);
}

function killEngine() {
    if(CORE.PLAYER) CORE.PLAYER.destroy();
    document.getElementById('viewport').style.display = 'none';
    document.getElementById('quantum-dashboard').classList.remove('dashboard-hidden');
}

</script>
</body>
</html>
