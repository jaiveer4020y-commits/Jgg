<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Netflix Player</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<link rel="stylesheet" href="https://unpkg.com/artplayer@5.3.0/dist/artplayer.css">

<style>
html,body{
    margin:0;
    padding:0;
    background:#000;
}

/* PLAYER */
#player{
    width:100%;
    max-width:980px;
    height:560px;
    margin:40px auto;
    position:relative;
    background:#000;
}

/* NETFLIX SPINNER */
.loading-spinner-container{
    display:flex;
    align-items:center;
    justify-content:center;
    width:64px;
    height:64px;
}
.loading-spinner-container img{
    width:64px;
    height:64px;
    animation:spin 1.1s linear infinite;
}
@keyframes spin{
    from{transform:rotate(0deg)}
    to{transform:rotate(360deg)}
}

/* ===== MANUAL SUBTITLE OVERLAY ===== */
#subtitle-overlay{
    position:absolute;
    bottom:15%; /* Lifted slightly to clear progress bar */
    left:50%;
    transform:translateX(-50%);
    width:90%;
    text-align:center;
    z-index:100; /* High z-index inside Artplayer */
    pointer-events:none;
}

#subtitle-overlay p{
    display:inline-block;
    padding:4px 12px;
    font-size:23px;
    color:rgb(252,244,244);
    background:rgba(0,0,0,0.6); /* Slightly darker for better readability */
    text-shadow:0 2px 4px rgba(0,0,0,0.9);
    border-radius:3px;
    white-space:pre-wrap;
    margin:0;
}
</style>
</head>

<body>

<div id="player">
    <div id="subtitle-overlay" style="display:none">
        <p id="subtitle-text"></p>
    </div>
</div>

<script src="https://unpkg.com/hls.js@1.5.17/dist/hls.min.js"></script>
<script src="https://unpkg.com/artplayer@5.3.0/dist/artplayer.js"></script>

<script>
/* ===============================
   URL PARAMS
================================ */
const q = new URLSearchParams(location.search);
const TITLE   = q.get('title');
const IMDB_ID = q.get('id');
const SEASON  = q.get('season');
const EPISODE = q.get('episode');

if(!TITLE){
    alert("Missing title param");
    throw new Error("No title");
}

/* ===============================
   PROXY
================================ */
const proxy = u => 'https://workingg.vercel.app/api/proxy?url=' + encodeURIComponent(u);

/* ===============================
   FETCH STREAM
================================ */
async function getStream(){
    const r = await fetch(proxy(`https://u-1-1azw.onrender.com/api/get-stream?title=${TITLE}`));
    const j = await r.json();
    if(!j.m3u8_url) throw "No stream";
    return proxy(j.m3u8_url);
}

/* ===============================
   FETCH SUBTITLES
================================ */
async function getSubtitles(){
    if(!IMDB_ID) return [];
    let u = `https://sub.wyzie.ru/search?id=${IMDB_ID}`;
    if(SEASON && EPISODE) u += `&season=${SEASON}&episode=${EPISODE}`;
    const r = await fetch(proxy(u));
    return await r.json();
}

/* ===============================
   PARSE VTT / SRT
================================ */
function parseSub(text){
    const cues=[];
    // Clean text and handle WEBVTT header
    const cleanText = text.replace('WEBVTT', '').trim();
    const blocks=cleanText.replace(/\r/g,'').split('\n\n');
    
    for(const b of blocks){
        const lines=b.split('\n');
        if(lines.length<2) continue;
        
        const timeIndex = lines[0].includes('-->') ? 0 : (lines[1].includes('-->') ? 1 : -1);
        if(timeIndex === -1) continue;

        const time=lines[timeIndex];
        const content=lines.slice(timeIndex + 1).join('\n');
        
        try {
            const [s,e]=time.split('-->').map(t=>{
                const p=t.trim().replace(',','.');
                const parts = p.split(':');
                let h=0, m=0, rest='';
                
                if(parts.length === 3) [h, m, rest] = parts;
                else [m, rest] = parts;

                const [sec,ms]=rest.split('.');
                return (+h)*3600+(+m)*60+(+sec)+(+ms||0)/1000;
            });
            cues.push({s,e,t:content});
        } catch(e) { continue; }
    }
    return cues;
}

/* ===============================
   INIT PLAYER
================================ */
(async()=>{
const m3u8=await getStream();
const subs=await getSubtitles();

const subtitleOverlay=document.getElementById('subtitle-overlay');
const subtitleText=document.getElementById('subtitle-text');
let subtitleCues=[];
let activeSub=null;

const art=new Artplayer({
    container:'#player',
    url:m3u8,
    type:'m3u8',
    autoplay:true,
    setting:true,
    fullscreen:true,
    fullscreenWeb:true,
    pip:true,
    playbackRate:true,
    aspectRatio:true,
    screenshot:true,
    miniProgressBar:true,
    mutex:true,
    backdrop:true,
    playsInline:true,
    resume:true,
    lock:true,
    fastForward:true,
    theme:'#e50914',
    icons:{
        loading:`
        <div class="loading-spinner-container">
            <img src="https://assets.nflxext.com/en_us/pages/wiplayer/site-spinner.png">
        </div>`
    },
    customType:{
        m3u8(video,url){
            if(Hls.isSupported()){
                const hls=new Hls();
                hls.loadSource(url);
                hls.attachMedia(video);
                art.hls=hls;

                hls.on(Hls.Events.MANIFEST_PARSED,()=>{
                    art.setting.add({
                        name:'quality',
                        html:'Quality',
                        selector:[
                            {html:'Auto',level:-1,default:true},
                            ...hls.levels.map((l,i)=>({html:l.height+'p',level:i}))
                        ],
                        onSelect:i=>{
                            hls.currentLevel=i.level;
                            return i.html;
                        }
                    });
                });

                hls.on(Hls.Events.AUDIO_TRACKS_UPDATED,(_,d)=>{
                    if(d.audioTracks.length>1){
                        art.setting.add({
                            name:'audio',
                            html:'Audio',
                            selector:d.audioTracks.map((t,i)=>({
                                html:t.name||t.lang||`Track ${i}`,
                                index:i,
                                default:i===hls.audioTrack
                            })),
                            onSelect:s=>{
                                hls.audioTrack=s.index;
                                return s.html;
                            }
                        });
                    }
                });
            }
        }
    }
});

// CRITICAL: Move the subtitle overlay inside Artplayer's UI layers
art.on('ready', () => {
    const layers = art.template.$layers;
    layers.appendChild(subtitleOverlay);
});

/* ===== SUBTITLE MENU ===== */
if(subs.length){
    art.setting.add({
        name:'subtitle',
        html:'Subtitles',
        selector:[
            {html:'Off',url:null,default:true},
            ...subs.map(s=>({
                html:s.lang||s.language||'Subtitle',
                url:proxy(s.url)
            }))
        ],
        onSelect:async i=>{
            if(!i.url){
                subtitleOverlay.style.display='none';
                subtitleCues=[];
                return 'Off';
            }
            try {
                const t=await fetch(i.url).then(r=>r.text());
                subtitleCues=parseSub(t);
                subtitleOverlay.style.display='block';
                return i.html;
            } catch (err) {
                console.error("Failed to load subtitle", err);
                return 'Error';
            }
        }
    });
}

/* ===== SYNC SUBTITLES (Using Video TimeUpdate for better sync) ===== */
art.on('video:timeupdate', () => {
    if(!subtitleCues.length) return;
    const t=art.currentTime;
    const cue=subtitleCues.find(c=>t>=c.s && t<=c.e);
    
    if(cue){
        if(cue !== activeSub) {
            // Replace <br> tags or other formatting if necessary
            subtitleText.innerHTML = cue.t.replace(/\n/g, '<br>');
            activeSub=cue;
        }
    } else {
        subtitleText.innerHTML='';
        activeSub=null;
    }
});

})();
</script>
</body>
</html>
