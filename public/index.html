<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<title>Netflix Style ArtPlayer</title>

<style>
body {
    margin: 0;
    background: #000;
    font-family: Helvetica, Arial, sans-serif;
}

/* PLAYER WRAPPER */
.artplayer-app {
    max-width: 900px;
    height: 506px;
    margin: 40px auto;
    background: #000;
    position: relative;
}

/* NETFLIX CENTER OVERLAY */
.netflix-overlay {
    position: absolute;
    inset: 0;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 120px;
    opacity: 0;
    pointer-events: none;
    transition: opacity 0.3s;
    z-index: 20;
}
.art-state-show .netflix-overlay {
    opacity: 1;
    pointer-events: auto;
}

.netflix-btn img {
    width: 64px;
    height: 64px;
    opacity: 0.9;
}
.netflix-btn.play img {
    width: 96px;
    height: 96px;
}

/* SUBTITLE STYLE */
.art-subtitle {
    font-size: 22px !important;
    color: #fff !important;
    text-shadow: 2px 2px 6px #000;
    background: rgba(0,0,0,.4);
    padding: 4px 10px;
    border-radius: 4px;
}

/* LOADING SPINNER */
.netflix-spinner {
    width: 64px;
    height: 64px;
    animation: spin 1s linear infinite;
}
@keyframes spin {
    from { transform: rotate(0deg); }
    to { transform: rotate(360deg); }
}
</style>
</head>

<body>

<div class="artplayer-app"></div>

<script src="https://cdn.jsdelivr.net/npm/@swarmcloud/hls/hls.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/artplayer@5/dist/artplayer.js"></script>

<script>
(async () => {
    const params = new URLSearchParams(location.search);
    const title = params.get('title');
    if (!title) return alert('Missing ?title=');

    /* 1️⃣ FETCH STREAM INFO (RENDER API) */
    const streamRes = await fetch(
        'https://workingg.vercel.app/api/proxy?url=' +
        encodeURIComponent(`https://u-1-1azw.onrender.com/api/get-stream?title=${title}`)
    );
    const streamJson = await streamRes.json();
    if (!streamJson.m3u8_url) return alert('Stream not found');

    const videoUrl =
        'https://workingg.vercel.app/api/proxy?url=' +
        encodeURIComponent(streamJson.m3u8_url);

    /* 2️⃣ SUBTITLE FETCH */
    let subtitleUrl = null;
    try {
        const subApi =
            'https://workingg.vercel.app/api/proxy?url=' +
            encodeURIComponent(`https://sub.wyzie.ru/search?id=${streamJson.imdb}`);
        const subRes = await fetch(subApi);
        const subJson = await subRes.json();
        subtitleUrl = subJson?.subtitles?.[0]?.url || null;
    } catch {}

    /* 3️⃣ INIT ARTPLAYER */
    const art = new Artplayer({
        container: '.artplayer-app',
        url: videoUrl,
        type: 'm3u8',
        autoplay: true,
        autoSize: true,
        setting: true,
        playbackRate: true,
        aspectRatio: true,
        fullscreen: true,
        fullscreenWeb: true,
        pip: true,
        airplay: true,
        lock: true,
        theme: '#e50914',
        icons: {
            loading: '<img class="netflix-spinner" src="https://assets.nflxext.com/en_us/pages/wiplayer/site-spinner.png">'
        },
        layers: [{
            name: 'center',
            html: `
            <div class="netflix-overlay">
                <div class="netflix-btn back"><img src="https://rivestream.org/images/player/backward.svg"></div>
                <div class="netflix-btn play"><img src="https://rivestream.org/images/player/play.svg"></div>
                <div class="netflix-btn forward"><img src="https://rivestream.org/images/player/forward.svg"></div>
            </div>`
        }],
        subtitle: subtitleUrl ? {
            url: subtitleUrl,
            type: 'vtt',
            encoding: 'utf-8',
            style: true
        } : null,
        customType: {
            m3u8(video, url, art) {
                if (!Hls.isSupported()) return;
                const hls = new Hls({
                    fragLoadingMaxRetry: 3,
                    levelLoadingMaxRetry: 3,
                    manifestLoadingMaxRetry: 2
                });
                hls.loadSource(url);
                hls.attachMedia(video);
                art.hls = hls;

                hls.once(Hls.Events.MANIFEST_PARSED, () => {
                    art.setting.add({
                        name: 'quality',
                        html: 'Quality',
                        selector: hls.levels.map((l, i) => ({
                            html: l.height + 'p',
                            level: i
                        })),
                        onSelect: item => {
                            hls.currentLevel = item.level;
                            return item.html;
                        }
                    });
                });
            }
        }
    });

    /* 4️⃣ CONTROLS */
    art.on('ready', () => {
        const playBtn = document.querySelector('.netflix-btn.play');
        const backBtn = document.querySelector('.netflix-btn.back');
        const forwardBtn = document.querySelector('.netflix-btn.forward');

        playBtn.onclick = () => art.toggle();
        backBtn.onclick = () => art.seek = art.currentTime - 10;
        forwardBtn.onclick = () => art.seek = art.currentTime + 10;

        art.on('play', () => {
            playBtn.innerHTML = `<img src="https://rivestream.org/images/player/play.svg">`;
        });
        art.on('pause', () => {
            playBtn.innerHTML = `<img src="https://rivestream.org/images/player/play.svg">`;
        });
    });
})();
</script>

</body>
</html>
