<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Ultimate Cinema Engine | Pro v3.5</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">

    <link rel="stylesheet" href="https://unpkg.com/artplayer@5.3.0/dist/artplayer.css">
    <script src="https://unpkg.com/hls.js@1.5.17/dist/hls.min.js"></script>
    <script src="https://unpkg.com/artplayer@5.3.0/dist/artplayer.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;700;900&display=swap" rel="stylesheet">

    <style>
        :root {
            --n-red: #e50914;
            --n-black: #000;
            --n-grey: #121212;
            --accent: #007bff;
        }

        body, html {
            margin: 0; padding: 0; background: var(--n-black);
            color: #fff; font-family: 'Roboto', sans-serif;
            height: 100vh; width: 100vw; overflow-x: hidden;
        }

        /* --- VIDSRC STYLE UI --- */
        #vidsrc-container {
            max-width: 1000px; margin: 20px auto; padding: 15px;
            background: #1a1a1a; border-radius: 12px; border: 1px solid #333;
        }

        .url-bar-container {
            display: flex; background: #000; padding: 10px; border-radius: 8px;
            border: 1px solid #444; margin-bottom: 20px; align-items: center;
        }

        .url-bar-container span { color: #888; font-size: 14px; margin-right: 10px; font-weight: bold; }

        input#clean-url-display {
            flex: 1; background: transparent; border: none; color: var(--accent);
            font-size: 14px; font-family: monospace; outline: none; pointer-events: none;
        }

        /* --- DASHBOARD --- */
        #dashboard { padding: 20px; text-align: center; }
        .hero-logo { font-size: 3rem; font-weight: 900; color: var(--n-red); margin-bottom: 20px; }
        
        .input-group { 
            display: flex; flex-direction: column; gap: 15px; max-width: 500px; margin: 0 auto; 
            background: var(--n-grey); padding: 30px; border-radius: 15px; border: 1px solid #222;
        }

        input, select {
            padding: 15px; background: #000; border: 1px solid #444; border-radius: 8px;
            color: #fff; font-size: 1rem; outline: none; transition: 0.3s;
        }

        input:focus { border-color: var(--n-red); }

        .btn-main {
            padding: 18px; background: var(--n-red); color: white; border: none;
            border-radius: 8px; font-weight: bold; cursor: pointer; text-transform: uppercase;
        }

        /* --- IFRAME / PLAYER AREA --- */
        #player-frame-area {
            width: 100%; aspect-ratio: 16/9; background: #000;
            border-radius: 8px; overflow: hidden; position: relative;
            box-shadow: 0 10px 40px rgba(0,0,0,0.8);
        }

        /* --- CORNER SPINNER (SCREENSHOT STYLE) --- */
        .corner-spinner {
            position: absolute; top: 20px; left: 20px; z-index: 1000;
            width: 60px; height: 60px; border: 4px solid rgba(229, 9, 20, 0.2);
            border-top: 4px solid var(--n-red); border-radius: 50%;
            animation: spin 1s linear infinite; display: none;
        }

        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        /* --- PLAYER OVERLAYS --- */
        .exit-layer {
            position: absolute; top: 20px; right: 20px; z-index: 1001;
            background: rgba(0,0,0,0.6); border: 2px solid #fff; border-radius: 50%;
            width: 45px; height: 45px; display: flex; align-items: center;
            justify-content: center; cursor: pointer;
        }

        /* Center Play/Pause Icons */
        .art-center-icons {
            display: flex; gap: 60px; pointer-events: none; opacity: 0; transition: 0.3s;
        }
        .art-state-show .art-center-icons { opacity: 1; }
        .icon-btn { 
            background: rgba(0,0,0,0.5); border-radius: 50%; width: 80px; height: 80px;
            display: flex; align-items: center; justify-content: center; pointer-events: auto;
        }
        .icon-btn svg { fill: #fff; width: 40px; }

        /* SUBTITLE BOX */
        #sub-render-box {
            position: absolute; bottom: 10%; width: 100%; text-align: center;
            pointer-events: none; z-index: 50;
        }
        #sub-text {
            display: inline-block; background: rgba(0,0,0,0.8); padding: 5px 20px;
            border-radius: 5px; color: #fff; font-size: 24px; text-shadow: 2px 2px 2px #000;
        }

        /* HIDE DEFAULT SPINNER */
        .art-loading .art-loading-icon { display: none !important; }
        .art-loading .corner-spinner { display: block !important; }

        /* SEARCH DROPDOWN */
        #search-drop {
            background: #111; border: 1px solid #333; position: absolute;
            width: 100%; top: 100%; left: 0; z-index: 2000; max-height: 300px;
            overflow-y: auto; border-radius: 0 0 10px 10px; display: none;
        }
        .search-item { display: flex; align-items: center; padding: 10px; cursor: pointer; border-bottom: 1px solid #222; }
        .search-item:hover { background: #222; }
        .search-item img { width: 40px; height: 60px; margin-right: 15px; border-radius: 4px; }
    </style>
</head>
<body>

<div id="dashboard">
    <div class="hero-logo">MoviesGod.API</div>
    
    <div class="input-group">
        <div style="position:relative; width:100%;">
            <input type="text" id="smart-search" placeholder="Type Movie or Series Name..." style="width:100%;">
            <div id="search-drop"></div>
        </div>

        <select id="media-type" onchange="toggleInputs()">
            <option value="movie">Movie Mode</option>
            <option value="tv">Series Mode</option>
        </select>

        <input type="text" id="id-input" placeholder="TMDB ID (Auto-filled)">

        <div id="series-meta" style="display:none; grid-template-columns: 1fr 1fr; gap: 10px;">
            <input type="number" id="s-num" value="1" placeholder="Season">
            <input type="number" id="e-num" value="1" placeholder="Episode">
        </div>

        <button class="btn-main" onclick="bootPlayer()">Initialize Source</button>
    </div>
</div>

<div id="vidsrc-container" style="display:none;">
    <div class="url-bar-container">
        <span>SOURCE:</span>
        <input type="text" id="clean-url-display" value="">
    </div>

    <div id="player-frame-area">
        <div class="corner-spinner"></div>
        <div class="exit-layer" onclick="closePlayer()">âœ•</div>
        <div id="artplayer"></div>
    </div>
</div>

<script>
/** ENGINE CONFIG **/
const TMDB_KEY = '463dcd7993ab31d92eb586802fdeee6a';
const PROXY = (u) => `https://workingg.vercel.app/api/proxy?url=${encodeURIComponent(u)}`;

let art;
let subCues = [];
let activeCue = null;

/** DYNAMIC SEARCH **/
const searchInp = document.getElementById('smart-search');
const drop = document.getElementById('search-drop');

searchInp.addEventListener('input', async () => {
    const q = searchInp.value;
    if (q.length < 2) { drop.style.display = 'none'; return; }

    const res = await fetch(`https://api.themoviedb.org/3/search/multi?api_key=${TMDB_KEY}&query=${encodeURIComponent(q)}`);
    const data = await res.json();
    
    drop.innerHTML = "";
    if (data.results) {
        drop.style.display = 'block';
        data.results.slice(0, 5).forEach(item => {
            if (!item.poster_path) return;
            const div = document.createElement('div');
            div.className = 'search-item';
            div.innerHTML = `<img src="https://image.tmdb.org/t/p/w92${item.poster_path}"><div><strong>${item.title || item.name}</strong><br><small>${((item.release_date || item.first_air_date || '')).split('-')[0]}</small></div>`;
            div.onclick = () => selectItem(item);
            drop.appendChild(div);
        });
    }
});

function selectItem(item) {
    searchInp.value = item.title || item.name;
    document.getElementById('id-input').value = item.id;
    const type = (item.media_type === 'tv' || item.name) ? 'tv' : 'movie';
    document.getElementById('media-type').value = type;
    toggleInputs();
    drop.style.display = 'none';
}

function toggleInputs() {
    const type = document.getElementById('media-type').value;
    document.getElementById('series-meta').style.display = (type === 'tv') ? 'grid' : 'none';
}

/** SLUG & STREAM ENGINE **/
async function bootPlayer() {
    const id = document.getElementById('id-input').value;
    const type = document.getElementById('media-type').value;
    const s = document.getElementById('s-num').value;
    const e = document.getElementById('e-num').value;

    if (!id) return alert("Please select a title.");

    // FETCH TMDB META TO FIX SLUG
    const metaRes = await fetch(`https://api.themoviedb.org/3/${type}/${id}?api_key=${TMDB_KEY}`);
    const meta = await metaRes.json();

    const title = (meta.title || meta.name).toLowerCase().replace(/[^a-z0-9\s]/gi, ' ').trim().replace(/\s+/g, '.');
    
    // THE SLUG LOGIC (Stranger Things Case)
    // Some series APIs need "stranger.things.s02.e01"
    let slug;
    if (type === 'movie') {
        const year = (meta.release_date || '2024').split('-')[0];
        slug = `${title}.${year}`;
    } else {
        const S = s.padStart(2, '0');
        const E = e.padStart(2, '0');
        slug = `${title}.s${S}.e${E}`;
    }

    // UPDATE VIDSRC URL BAR
    const cleanUrl = `https://moviesgod.vercel.app/embed/${type}/${id}${type==='tv' ? `/${s}/${e}` : ''}`;
    document.getElementById('clean-url-display').value = cleanUrl;
    document.getElementById('vidsrc-container').style.display = 'block';
    document.getElementById('dashboard').style.display = 'none';

    try {
        const streamApi = `https://u-1-1azw.onrender.com/api/get-stream?title=${encodeURIComponent(slug)}&id=${id}&season=${s}&episode=${e}`;
        const streamRes = await fetch(PROXY(streamApi)).then(r => r.json());

        // SUBTITLE LOGIC - TWO FALLBACKS
        let subApi = `https://sub.wyzie.ru/search?id=${id}`;
        if (type === 'tv') subApi += `&season=${s}&episode=${e}`;
        const subRes = await fetch(PROXY(subApi)).then(r => r.json()).catch(() => []);

        startArt(PROXY(streamRes.m3u8_url), subRes, slug);
    } catch (err) {
        alert("Failed to load stream. Ensure ID is correct.");
        closePlayer();
    }
}

/** ARTPLAYER CORE **/
function startArt(m3u8, subs, slug) {
    art = new Artplayer({
        container: '#artplayer',
        url: m3u8,
        type: 'm3u8',
        autoplay: true,
        autoPlayback: true,
        fullscreen: true,
        theme: '#e50914',
        setting: true,
        playbackRate: true,
        aspectRatio: true,
        subtitleOffset: true,
        layers: [
            {
                name: 'corner-spin',
                html: `<div class="corner-spinner"></div>`
            },
            {
                name: 'center-controls',
                html: `
                <div class="art-center-icons">
                    <div class="icon-btn" onclick="art.backward=10"><svg viewBox="0 0 24 24"><path d="M12 5V1l-5 5 5 5V7c3.31 0 6 2.69 6 6s-2.69 6-6 6-6-2.69-6-6H4c0 4.42 3.58 8 8 8s8-3.58 8-8-3.58-8-8-8z"/></svg></div>
                    <div class="icon-btn" onclick="art.toggle()"><svg viewBox="0 0 24 24"><path d="M8 5v14l11-7z"/></svg></div>
                    <div class="icon-btn" onclick="art.forward=10"><svg viewBox="0 0 24 24"><path d="M12 5V1l5 5-5 5V7c-3.31 0-6 2.69-6 6s2.69 6 6 6 6-2.69 6-6h2c0 4.42-3.58 8-8 8s-8-3.58-8-8 3.58-8 8-8z"/></svg></div>
                </div>`
            },
            {
                name: 'sub-layer',
                html: `<div id="sub-render-box"><div id="sub-text"></div></div>`
            }
        ],
        customType: {
            m3u8: function(video, url) {
                if (Hls.isSupported()) {
                    const hls = new Hls();
                    hls.loadSource(url);
                    hls.attachMedia(video);
                    hls.on(Hls.Events.MANIFEST_PARSED, () => {
                        // QUALITY SWITCHER
                        art.setting.add({
                            name: 'quality', html: 'Quality',
                            selector: [{html: 'Auto', level: -1, default: true}, ...hls.levels.map((l, i) => ({html: l.height+'p', level: i}))],
                            onSelect: (i) => { hls.currentLevel = i.level; return i.html; }
                        });

                        // AUDIO SWITCHER
                        if (hls.audioTracks.length > 1) {
                            art.setting.add({
                                name: 'audio', html: 'Audio Track',
                                selector: hls.audioTracks.map((t, i) => ({html: t.name || t.lang, index: i})),
                                onSelect: (i) => { hls.audioTrack = i.index; return i.html; }
                            });
                        }
                    });
                }
            }
        }
    });

    art.on('ready', () => {
        // RESUME PLAYBACK
        const saved = localStorage.getItem(`save_${slug}`);
        if (saved) art.currentTime = parseFloat(saved);

        // SUBTITLE SWITCHER
        if (subs && subs.length > 0) {
            art.setting.add({
                name: 'subs', html: 'Subtitles',
                selector: [{html: 'Off', url: null, default: true}, ...subs.map(s => ({html: s.lang || s.language, url: PROXY(s.url)}))],
                onSelect: async (item) => {
                    if (!item.url) { subCues = []; document.getElementById('sub-text').style.display='none'; return 'Off'; }
                    const text = await fetch(item.url).then(r => r.text());
                    subCues = parseVtt(text);
                    document.getElementById('sub-text').style.display='block';
                    return item.html;
                }
            });
        }
    });

    art.on('video:timeupdate', () => {
        localStorage.setItem(`save_${slug}`, art.currentTime);
        if (!subCues.length) return;
        const now = art.currentTime;
        const cue = subCues.find(c => now >= c.start && now <= c.end);
        const el = document.getElementById('sub-text');
        if (cue) {
            if (cue !== activeCue) { el.innerHTML = cue.text; activeCue = cue; }
        } else { el.innerHTML = ""; activeCue = null; }
    });
}

function closePlayer() {
    if (art) art.destroy();
    document.getElementById('vidsrc-container').style.display = 'none';
    document.getElementById('dashboard').style.display = 'block';
}

/** UTILS **/
function parseVtt(text) {
    const cues = [];
    const lines = text.split('\n');
    let cur = null;
    lines.forEach(l => {
        l = l.trim();
        if (l.includes('-->')) {
            const p = l.split('-->');
            cur = { start: t2s(p[0]), end: t2s(p[1]), text: [] };
        } else if (cur && l === "") {
            cues.push({ ...cur, text: cur.text.join('<br>') });
            cur = null;
        } else if (cur) {
            cur.text.push(l);
        }
    });
    return cues;
}

function t2s(t) {
    const p = t.trim().split(':');
    let h=0, m=0, s=0;
    if (p.length === 3) [h, m, s] = p; else [m, s] = p;
    return (+h)*3600 + (+m)*60 + parseFloat(s);
}
</script>

</body>
</html>
