<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Netflix Player</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<style>
body {
    margin: 0;
    background: #000;
    font-family: Helvetica, Arial, sans-serif;
}

.artplayer-app {
    width: 100%;
    max-width: 960px;
    height: 540px;
    margin: 40px auto;
    background: #000;
    position: relative;
}

.netflix-header {
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    padding: 16px;
    z-index: 20;
    color: #fff;
    pointer-events: none;
}

.netflix-overlay {
    position: absolute;
    inset: 0;
    display: flex;
    justify-content: center;
    align-items: center;
    gap: 90px;
    z-index: 15;
    opacity: 0;
    transition: opacity .3s;
}

.art-state-show .netflix-overlay {
    opacity: 1;
}

.netflix-btn {
    cursor: pointer;
    pointer-events: auto;
}

.netflix-btn img {
    width: 60px;
    height: 60px;
    filter: drop-shadow(0 0 6px rgba(0,0,0,.7));
}

.netflix-btn.play img {
    width: 95px;
    height: 95px;
}

.netflix-spinner {
    width: 60px;
    height: 60px;
    animation: spin 1.1s linear infinite;
}

@keyframes spin {
    from { transform: rotate(0deg); }
    to { transform: rotate(360deg); }
}

.art-subtitle {
    font-size: 22px !important;
    background: rgba(0,0,0,.55) !important;
    padding: 4px 10px;
    border-radius: 3px;
}
</style>
</head>

<body>

<div class="artplayer-app">
    <div class="netflix-header" id="title">Loadingâ€¦</div>
</div>

<script src="https://cdn.jsdelivr.net/npm/@swarmcloud/hls/hls.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/artplayer@5.0.9/dist/artplayer.js"></script>

<script>
(async () => {

const qs = new URLSearchParams(location.search);
const title = qs.get('title');
const imdb = qs.get('imdb');      // optional
const season = qs.get('season'); // optional
const episode = qs.get('episode');

if (!title) {
    document.getElementById('title').innerText = 'No title';
    return;
}

document.getElementById('title').innerText = title;

// ðŸ”¹ PROXY HELPER
const proxy = url =>
  'https://workingg.vercel.app/api/proxy?url=' + encodeURIComponent(url);

// ðŸ”¹ FETCH STREAM (RENDER API via PROXY)
const streamRes = await fetch(
    proxy(`https://u-1-1azw.onrender.com/api/get-stream?title=${title}`)
);
const streamJson = await streamRes.json();
if (!streamJson.m3u8_url) return;

const m3u8 = proxy(streamJson.m3u8_url);

// ðŸ”¹ FETCH SUBTITLES (MOVIE OR EPISODE)
let subtitleList = [];
if (imdb) {
    let subUrl = season && episode
        ? `https://sub.wyzie.ru/search?id=${imdb}&season=${season}&episode=${episode}`
        : `https://sub.wyzie.ru/search?id=${imdb}`;

    try {
        const subRes = await fetch(proxy(subUrl));
        subtitleList = await subRes.json();
    } catch {}
}

// ðŸ”¹ ICONS
const ICONS = {
    back: 'https://rivestream.org/images/player/backward.svg',
    play: 'https://rivestream.org/images/player/play.svg',
    forward: 'https://rivestream.org/images/player/forward.svg'
};

// ðŸ”¹ INIT PLAYER
const art = new Artplayer({
    container: '.artplayer-app',
    url: m3u8,
    type: 'm3u8',
    autoplay: true,
    setting: true,
    playbackRate: true,
    aspectRatio: true,
    fullscreen: true,
    fullscreenWeb: true,
    pip: true,
    airplay: true,
    miniProgressBar: true,
    mutex: true,
    playsInline: true,
    backdrop: true,
    theme: '#e50914',

    icons: {
        loading:
          '<img class="netflix-spinner" src="https://assets.nflxext.com/en_us/pages/wiplayer/site-spinner.png">'
    },

    layers: [{
        name: 'controls',
        html: `
        <div class="netflix-overlay">
            <div class="netflix-btn back"><img src="${ICONS.back}"></div>
            <div class="netflix-btn play"><img src="${ICONS.play}"></div>
            <div class="netflix-btn forward"><img src="${ICONS.forward}"></div>
        </div>`
    }],

    customType: {
        m3u8(video, url, art) {
            if (Hls.isSupported()) {
                const hls = new Hls({
                    maxBufferLength: 60,
                    maxMaxBufferLength: 120,
                    enableWorker: true
                });
                hls.loadSource(url);
                hls.attachMedia(video);
                art.hls = hls;

                hls.on(Hls.Events.MANIFEST_PARSED, () => {
                    art.setting.add({
                        name: 'quality',
                        html: 'Quality',
                        selector: [
                            { html: 'Auto', level: -1, default: true },
                            ...hls.levels.map((l, i) => ({
                                html: l.height + 'p',
                                level: i
                            }))
                        ],
                        onSelect: item => {
                            hls.currentLevel = item.level;
                            return item.html;
                        }
                    });
                });

                hls.on(Hls.Events.AUDIO_TRACKS_UPDATED, (_, d) => {
                    if (d.audioTracks.length > 1) {
                        art.setting.add({
                            name: 'audio',
                            html: 'Audio',
                            selector: d.audioTracks.map((t, i) => ({
                                html: t.name || t.lang || `Track ${i}`,
                                index: i,
                                default: i === hls.audioTrack
                            })),
                            onSelect: i => {
                                hls.audioTrack = i.index;
                                return i.html;
                            }
                        });
                    }
                });
            }
        }
    }
});

// ðŸ”¹ SUBTITLE SETTING
if (subtitleList.length) {
    art.setting.add({
        name: 'subtitle',
        html: 'Subtitles',
        selector: [
            { html: 'Off', url: '', default: true },
            ...subtitleList.map(s => ({
                html: s.lang || s.language || 'Subtitle',
                url: proxy(s.url)
            }))
        ],
        onSelect(item) {
            art.subtitle.url = item.url;
            return item.html;
        }
    });
}

// ðŸ”¹ CONTROLS
art.on('ready', () => {
    const play = document.querySelector('.netflix-btn.play');
    const back = document.querySelector('.netflix-btn.back');
    const forward = document.querySelector('.netflix-btn.forward');

    play.onclick = () => art.toggle();
    back.onclick = () => art.seek = art.currentTime - 10;
    forward.onclick = () => art.seek = art.currentTime + 10;
});

})();
</script>
</body>
</html>
