<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>VidSrc Pro - Ultimate Cinema Engine</title>
    
    <script src="https://cdn.jsdelivr.net/npm/@swarmcloud/hls/hls.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/artplayer@5.0.9/dist/artplayer.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <style>
        :root {
            --n-red: #e50914;
            --n-black: #050505;
            --n-grey: #141414;
            --n-text: #e5e5e5;
            --font-main: 'Helvetica Neue', Helvetica, Arial, sans-serif;
        }

        body, html {
            margin: 0; padding: 0; width: 100%; height: 100%;
            background-color: var(--n-black);
            color: white; font-family: var(--font-main);
            overflow: hidden;
        }

        /* --- LOADING LAYER --- */
        #global-loader {
            position: fixed; inset: 0; z-index: 9999;
            background: var(--n-black);
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            transition: opacity 0.5s ease;
        }

        .netflix-spinner {
            width: 100px; height: 100px;
            background-image: url('https://assets.nflxext.com/en_us/pages/wiplayer/site-spinner.png');
            background-size: contain;
            animation: n-spin 1.1s linear infinite;
        }

        @keyframes n-spin { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }

        /* --- PLAYER CONTAINER --- */
        #app-container { width: 100%; height: 100vh; position: relative; }
        .artplayer-app { width: 100%; height: 100%; }

        /* --- NETFLIX OVERLAY UI --- */
        .n-header {
            position: absolute; top: 0; left: 0; right: 0;
            padding: 45px 4%; background: linear-gradient(to bottom, rgba(0,0,0,0.9), transparent);
            z-index: 100; display: flex; align-items: center; gap: 25px;
            opacity: 0; visibility: hidden; transition: 0.4s cubic-bezier(0.4, 0, 0.2, 1);
        }
        .art-state-show .n-header { opacity: 1; visibility: visible; }

        .n-back { font-size: 30px; cursor: pointer; transition: 0.2s; }
        .n-back:hover { transform: scale(1.2); }
        .n-title-group { display: flex; flex-direction: column; }
        .n-main-title { font-size: 26px; font-weight: bold; }
        .n-sub-title { font-size: 14px; color: #aaa; margin-top: 4px; }

        /* --- CENTER CONTROLS --- */
        .n-center-controls {
            position: absolute; inset: 0; display: flex; align-items: center; justify-content: center;
            gap: 15%; pointer-events: none; z-index: 50;
            opacity: 0; transition: 0.3s ease;
        }
        .art-state-show .n-center-controls { opacity: 1; }
        .n-ctrl-item { pointer-events: auto; cursor: pointer; }
        .n-ctrl-item svg { width: 80px; height: 80px; fill: white; filter: drop-shadow(0 0 15px rgba(0,0,0,0.8)); }
        .n-ctrl-item.play-main svg { width: 120px; height: 120px; }

        /* --- ARTPLAYER CUSTOMIZATIONS --- */
        .art-progress-played { background: var(--n-red) !important; }
        .art-progress-indicator { background: var(--n-red) !important; border: 2px solid white; }
        .art-subtitle {
            font-size: 30px !important;
            text-shadow: 0 0 4px #000, 0 0 4px #000, 0 0 4px #000 !important;
            color: #ffffff !important;
            bottom: 10% !important;
        }

        /* --- SKIP BUTTON --- */
        #skip-btn {
            position: absolute; bottom: 130px; right: 0;
            background: rgba(255,255,255,0.9); color: black;
            padding: 15px 40px; font-size: 18px; font-weight: bold;
            border-radius: 4px 0 0 4px; cursor: pointer;
            z-index: 1000; display: none;
            box-shadow: 0 0 20px rgba(0,0,0,0.5);
        }
        #skip-btn:hover { background: white; padding-right: 50px; }

        /* --- SEARCH/SELECTOR OVERLAY (Dynamic Mode) --- */
        #dynamic-search {
            position: fixed; inset: 0; background: rgba(0,0,0,0.95);
            z-index: 8000; display: none; align-items: center; justify-content: center;
        }
        .search-box { width: 400px; text-align: center; }
        .search-input { 
            width: 100%; padding: 15px; background: #333; border: 2px solid transparent; 
            color: white; border-radius: 4px; font-size: 18px; outline: none;
        }
        .search-input:focus { border-color: var(--n-red); }
    </style>
</head>
<body>

    <div id="global-loader">
        <div class="netflix-spinner"></div>
        <p style="margin-top: 20px; letter-spacing: 4px; font-weight: bold; color: var(--n-red);">LOADING CONTENT</p>
    </div>

    <div id="dynamic-search">
        <div class="search-box">
            <h2>Enter TMDB ID</h2>
            <input type="text" id="tmdb-input" class="search-input" placeholder="e.g. 157336">
            <button class="search-input" style="background:var(--n-red); margin-top:10px; cursor:pointer;" onclick="manualLoad()">LAUNCH PLAYER</button>
        </div>
    </div>

    <div id="app-container">
        <div class="artplayer-app"></div>
        
        <div class="n-header">
            <i class="fas fa-arrow-left n-back" onclick="location.reload()"></i>
            <div class="n-title-group">
                <span class="n-main-title" id="m-title">Loading Stream...</span>
                <span class="n-sub-title" id="m-meta">Fetching metadata from VidSrc database...</span>
            </div>
        </div>

        <div class="n-center-controls">
            <div class="n-ctrl-item" id="c-rewind">
                <svg viewBox="0 0 24 24"><path d="M11 18V6l-8.5 6 8.5 6zm.5-6l8.5 6V6l-8.5 6z"/></svg>
            </div>
            <div class="n-ctrl-item play-main" id="c-play">
                <svg viewBox="0 0 24 24"><path d="M8 5v14l11-7z"/></svg>
            </div>
            <div class="n-ctrl-item" id="c-forward">
                <svg viewBox="0 0 24 24"><path d="M4 18l8.5-6L4 6v12zm9-12v12l8.5-6L13 6z"/></svg>
            </div>
        </div>

        <div id="skip-btn">SKIP INTRO</div>
    </div>

<script>
/**
 * VidSrc Pro Engine v2.0
 * ----------------------
 * This script handles HLS decryption, Dynamic TMDB fetching, 
 * and Netflix UI state management.
 */

const TMDB_API_KEY = 'a872655d4924c5850907f1f7d5494d6a'; // Placeholder - replace with your key
const PROXY_URL = 'https://workingg.vercel.app/api/proxy?url=';
const DEFAULT_M3U8 = 'https://workingg.vercel.app/api/proxy?url=https://185.237.106.169/v4/Lis-38MjEgUbLsw9uh2SEQ/1767968654/is3/fdtaux/master.m3u8?v=1766717457';

let art = null;

// Icons Object
const nfIcons = {
    play: `<svg viewBox="0 0 24 24"><path d="M8 5v14l11-7z"/></svg>`,
    pause: `<svg viewBox="0 0 24 24"><path d="M6 19h4V5H6v14zm8-14v14h4V5h-4z"/></svg>`
};

// 1. Initial Router
window.onload = () => {
    const params = new URLSearchParams(window.location.search);
    const id = params.get('id');
    const type = params.get('type') || 'movie';

    if (id) {
        fetchMetadata(id, type);
        initPlayer(DEFAULT_M3U8);
    } else {
        document.getElementById('global-loader').style.display = 'none';
        document.getElementById('dynamic-search').style.display = 'flex';
    }
};

async function fetchMetadata(id, type) {
    try {
        const res = await fetch(`https://api.themoviedb.org/3/${type}/${id}?api_key=${TMDB_API_KEY}`);
        const data = await res.json();
        document.getElementById('m-title').innerText = data.title || data.name;
        document.getElementById('m-meta').innerText = `${data.release_date || data.first_air_date} • ${data.vote_average} Rating • ${type.toUpperCase()}`;
        document.title = `Watching: ${data.title || data.name}`;
    } catch (e) {
        console.error("Metadata failed");
    }
}

function initPlayer(m3u8) {
    art = new Artplayer({
        container: '.artplayer-app',
        url: m3u8,
        type: 'm3u8',
        theme: '#e50914',
        fullscreen: true,
        fullscreenWeb: true,
        setting: true,
        playbackRate: true,
        aspectRatio: true,
        autoOrientation: true,
        pip: true,
        miniProgressBar: true,
        lock: true,
        fastForward: true,
        autoPlayback: true,
        autoSize: false,
        customType: {
            m3u8: function (video, url, art) {
                if (Hls.isSupported()) {
                    const hls = new Hls();
                    hls.loadSource(url);
                    hls.attachMedia(video);
                    art.hls = hls;

                    hls.on(Hls.Events.MANIFEST_PARSED, () => {
                        // Quality Switcher
                        art.setting.add({
                            name: 'quality',
                            html: 'Resolution',
                            tooltip: 'Auto',
                            selector: [
                                { default: true, html: 'Auto', level: -1 },
                                ...hls.levels.map((l, i) => ({ html: l.height + 'p', level: i }))
                            ],
                            onSelect: (item) => {
                                hls.currentLevel = item.level;
                                return item.html;
                            }
                        });

                        // Audio Switcher
                        if (hls.audioTracks.length > 1) {
                            art.setting.add({
                                name: 'audio',
                                html: 'Audio Track',
                                selector: hls.audioTracks.map((t, i) => ({
                                    html: t.name || `Language ${i}`,
                                    index: i
                                })),
                                onSelect: (item) => {
                                    hls.audioTrack = item.index;
                                    return item.html;
                                }
                            });
                        }
                        
                        document.getElementById('global-loader').style.opacity = '0';
                        setTimeout(() => document.getElementById('global-loader').style.display = 'none', 500);
                    });
                }
            }
        },
        icons: {
            loading: '<div class="netflix-spinner"></div>',
            state: '<i class="fas fa-play" style="font-size: 50px;"></i>'
        },
        settings: [
            {
                html: 'Subtitle Settings',
                icon: '<i class="fas fa-closed-captioning"></i>',
                selector: [
                    { html: 'Import URL', url: 'import' },
                    { html: 'Size: Small', size: '20px' },
                    { html: 'Size: Normal', size: '30px', default: true },
                    { html: 'Size: Large', size: '45px' }
                ],
                onSelect: (item) => {
                    if(item.url === 'import') {
                        const s = prompt("VTT Subtitle URL:");
                        if(s) art.subtitle.url = s;
                    }
                    if(item.size) {
                        document.querySelector('.art-subtitle').style.fontSize = item.size;
                    }
                    return item.html;
                }
            }
        ]
    });

    setupOverlays();
}

function setupOverlays() {
    const playBtn = document.getElementById('c-play');
    const skipBtn = document.getElementById('skip-btn');

    // Sync icons
    art.on('play', () => playBtn.innerHTML = nfIcons.pause);
    art.on('pause', () => playBtn.innerHTML = nfIcons.play);

    // Center Controls Click Logic
    playBtn.onclick = () => art.toggle();
    document.getElementById('c-rewind').onclick = () => art.currentTime -= 10;
    document.getElementById('c-forward').onclick = () => art.currentTime += 10;

    // Skip Intro Logic (Display between 10s and 90s)
    art.on('video:timeupdate', () => {
        if (art.currentTime > 10 && art.currentTime < 95) {
            skipBtn.style.display = 'block';
        } else {
            skipBtn.style.display = 'none';
        }
    });

    skipBtn.onclick = () => {
        art.currentTime = 95;
        skipBtn.style.display = 'none';
    };
}

function manualLoad() {
    const id = document.getElementById('tmdb-input').value;
    if (id) window.location.search = `?id=${id}&type=movie`;
}
</script>
</body>
</html>
