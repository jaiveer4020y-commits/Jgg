<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Netflix Ultimate | OG Engine v18.0</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <link rel="stylesheet" href="https://unpkg.com/artplayer@5.3.0/dist/artplayer.css">
    <script src="https://unpkg.com/hls.js@1.5.17/dist/hls.min.js"></script>
    <script src="https://unpkg.com/artplayer@5.3.0/dist/artplayer.js"></script>

    <style>
        :root { --n-red: #e50914; --n-black: #000; --n-dark: #141414; }
        body, html { margin: 0; padding: 0; background: var(--n-black); color: #fff; font-family: 'Helvetica Neue', Helvetica, Arial, sans-serif; height: 100%; overflow: hidden; }

        /* UI ENHANCEMENT */
        #ui-dashboard { padding: 40px 20px; display: flex; flex-direction: column; align-items: center; overflow-y: auto; height: 100vh; }
        .logo { font-size: 3rem; font-weight: 900; color: var(--n-red); margin-bottom: 30px; letter-spacing: -2px; }
        
        .search-bar { 
            width: 100%; max-width: 800px; background: var(--n-dark); padding: 10px; border-radius: 8px; 
            display: flex; gap: 10px; border: 1px solid #333;
        }
        .search-bar input { flex: 1; background: transparent; border: none; color: #fff; padding: 10px; font-size: 1.1rem; outline: none; }
        .search-bar button { background: var(--n-red); color: #fff; border: none; padding: 0 25px; border-radius: 4px; font-weight: bold; cursor: pointer; }

        #results { display: grid; grid-template-columns: repeat(auto-fill, minmax(180px, 1fr)); gap: 20px; width: 100%; max-width: 1200px; margin-top: 30px; }
        .card { background: var(--n-dark); border-radius: 4px; overflow: hidden; cursor: pointer; transition: transform 0.3s; border: 2px solid transparent; }
        .card:hover { transform: scale(1.05); border-color: var(--n-red); }
        .card img { width: 100%; aspect-ratio: 2/3; object-fit: cover; }

        /* OG LOADING SCREEN WITH POSTER */
        #loading-layer { 
            position: fixed; inset: 0; background: #000; display: none; 
            flex-direction: column; align-items: center; justify-content: center; z-index: 99999; 
        }
        #loading-poster {
            position: absolute; inset: 0; width: 100%; height: 100%; 
            object-fit: cover; opacity: 0.3; filter: blur(10px);
        }
        .spinner-container { position: relative; z-index: 10; text-align: center; }
        .og-spinner { width: 100px; height: 100px; animation: spin 1.1s linear infinite; }
        @keyframes spin { from {transform:rotate(0deg)} to {transform:rotate(360deg)} }

        /* PLAYER WRAPPER */
        #player-container { position: fixed; inset: 0; background: #000; display: none; z-index: 100000; }
        #artplayer { width: 100%; height: 100%; }

        /* LAYERED ICONS (PLAY/PAUSE/SEEK) */
        .art-layer-controls {
            display: flex; align-items: center; justify-content: center;
            gap: 80px; width: 100%; height: 100%; pointer-events: none;
            opacity: 0; transition: opacity 0.3s ease;
        }
        /* Only show icons when ArtPlayer controls are active */
        .art-state-show .art-layer-controls { opacity: 1; }
        
        .icon-btn { 
            background: rgba(0,0,0,0.5); width: 80px; height: 80px; border-radius: 50%;
            display: flex; align-items: center; justify-content: center; 
            pointer-events: auto; cursor: pointer; border: 1px solid rgba(255,255,255,0.1);
        }
        .icon-btn svg { width: 40px; height: 40px; fill: #fff; }

        /* SUBTITLE OVERLAY */
        .art-layer-subtitles {
            position: absolute; bottom: 15%; width: 100%; display: flex; 
            justify-content: center; pointer-events: none;
        }
        #sub-text {
            background: rgba(0,0,0,0.75); padding: 5px 20px; border-radius: 4px;
            color: #fff; font-size: 28px; text-align: center; display: none;
            text-shadow: 2px 2px 4px #000; max-width: 80%;
        }

        /* TV MODAL */
        .modal { position: fixed; inset: 0; background: rgba(0,0,0,0.9); display: none; align-items: center; justify-content: center; z-index: 110000; }
        .modal-ui { background: var(--n-dark); padding: 30px; border-radius: 8px; text-align: center; border: 1px solid #333; }
        .modal-ui input { width: 60px; padding: 10px; background: #000; color: #fff; border: 1px solid #444; text-align: center; margin: 10px; }
    </style>
</head>
<body>

<div id="ui-dashboard">
    <div class="logo">NETFLIX</div>
    <div class="search-bar">
        <input type="text" id="search-input" placeholder="Search Movies or Series...">
        <button onclick="startSearch()">SEARCH</button>
    </div>
    <div id="results"></div>
</div>

<div class="modal" id="tv-modal">
    <div class="modal-ui">
        <h2 id="tv-title" style="color:var(--n-red)">Select Episode</h2>
        S: <input type="number" id="s-num" value="1">
        E: <input type="number" id="e-num" value="1">
        <br><br>
        <button onclick="playTv()" style="background:var(--n-red); color:#fff; border:none; padding:10px 30px; cursor:pointer; font-weight:bold;">PLAY</button>
    </div>
</div>

<div id="loading-layer">
    <img id="loading-poster" src="">
    <div class="spinner-container">
        <img class="og-spinner" src="https://assets.nflxext.com/en_us/pages/wiplayer/site-spinner.png">
        <p id="load-msg" style="margin-top:20px; font-weight:bold; letter-spacing:2px; color:var(--n-red)">INITIALIZING...</p>
    </div>
</div>

<div id="player-container">
    <div id="artplayer"></div>
</div>

<script>
const TMDB_KEY = '463dcd7993ab31d92eb586802fdeee6a';
const PROXY = (u) => 'https://workingg.vercel.app/api/proxy?url=' + encodeURIComponent(u);

let art;
let activeItem = null;
let currentSubs = [];
let lastCue = null;

/** 1. SLUG ENGINE: DOT PROTOCOL **/
function makeSlug(title, type, s, e) {
    let base = title.toLowerCase().replace(/[^a-z0-9\s]/gi, ' ').trim().replace(/\s+/g, '.');
    if (type === 'tv') {
        base += `.s${s.toString().padStart(2, '0')}.e${e.toString().padStart(2, '0')}`;
    }
    return base;
}

/** 2. SEARCH & UI **/
async function startSearch() {
    const q = document.getElementById('search-input').value;
    if(!q) return;
    const res = await fetch(`https://api.themoviedb.org/3/search/multi?api_key=${TMDB_KEY}&query=${encodeURIComponent(q)}`);
    const data = await res.json();
    const grid = document.getElementById('results');
    grid.innerHTML = "";
    data.results.forEach(item => {
        if(!item.poster_path) return;
        const card = document.createElement('div');
        card.className = 'card';
        card.innerHTML = `<img src="https://image.tmdb.org/t/p/w300${item.poster_path}">`;
        card.onclick = () => {
            activeItem = item;
            if(item.media_type === 'tv' || item.name) {
                document.getElementById('tv-title').innerText = item.name;
                document.getElementById('tv-modal').style.display = 'flex';
            } else {
                fetchStream('movie', item.id, item.title, item.poster_path);
            }
        };
        grid.appendChild(card);
    });
}

function playTv() {
    document.getElementById('tv-modal').style.display = 'none';
    fetchStream('tv', activeItem.id, activeItem.name, activeItem.poster_path, document.getElementById('s-num').value, document.getElementById('e-num').value);
}

/** 3. STREAM & POSTER LOADING **/
async function fetchStream(type, id, title, poster, s, e) {
    const loader = document.getElementById('loading-layer');
    document.getElementById('loading-poster').src = `https://image.tmdb.org/t/p/original${poster}`;
    loader.style.display = 'flex';

    const slug = makeSlug(title, type, s, e);
    document.getElementById('load-msg').innerText = `LOADING: ${slug.toUpperCase()}`;

    try {
        const streamApi = `https://u-1-1azw.onrender.com/api/get-stream?title=${encodeURIComponent(slug)}`;
        const streamRes = await fetch(PROXY(streamApi));
        const streamData = await streamRes.json();
        if(!streamData.m3u8_url) throw new Error("Stream not found");

        let subApi = `https://sub.wyzie.ru/search?id=${id}`;
        if(type === 'tv') subApi += `&season=${s}&episode=${e}`;
        const subs = await fetch(PROXY(subApi)).then(r => r.json()).catch(() => []);

        initPlayer(PROXY(streamData.m3u8_url), subs);
    } catch(err) {
        alert("STREAM FAILED: Slug mismatch.");
        loader.style.display = 'none';
    }
}

/** 4. SUBTITLE PARSER **/
function parseVtt(t) {
    const cues = [];
    const lines = t.split('\n');
    let cur = null;
    lines.forEach(l => {
        l = l.trim();
        if(l.includes('-->')) {
            const p = l.split('-->');
            cur = { s: t2s(p[0]), e: t2s(p[1]), text: [] };
        } else if(cur && l === "") {
            cues.push({...cur, text: cur.text.join('<br>')});
            cur = null;
        } else if(cur) cur.text.push(l);
    });
    return cues;
}
function t2s(s) {
    const p = s.trim().split(':');
    let h=0, m=0, sec=0;
    if(p.length === 3) [h, m, sec] = p; else [m, sec] = p;
    return (+h)*3600 + (+m)*60 + parseFloat(sec);
}

/** 5. ARTPLAYER CORE WITH NATIVE SETTINGS & ICON LAYERS **/
function initPlayer(url, subs) {
    document.getElementById('player-container').style.display = 'block';

    art = new Artplayer({
        container: '#artplayer',
        url: url,
        type: 'm3u8',
        autoplay: true,
        autoPlayback: true, // RESUME PLAY
        fullscreen: true,
        setting: true, // ALL NATIVE SETTINGS ENABLED
        playbackRate: true,
        aspectRatio: true,
        subtitleOffset: true,
        theme: '#e50914',
        layers: [
            {
                name: 'controls',
                html: `
                <div class="art-layer-controls">
                    <div class="icon-btn" onclick="art.backward=10"><svg viewBox="0 0 24 24"><path d="M11 18V6l-8.5 6 8.5 6zm.5-6l8.5 6V6l-8.5 6z"/></svg></div>
                    <div class="icon-btn" onclick="art.toggle()">
                        <svg id="svg-play" style="display:none" viewBox="0 0 24 24"><path d="M8 5v14l11-7z"/></svg>
                        <svg id="svg-pause" viewBox="0 0 24 24"><path d="M6 19h4V5H6v14zm8-14v14h4V5h-4z"/></svg>
                    </div>
                    <div class="icon-btn" onclick="art.forward=10"><svg viewBox="0 0 24 24"><path d="M4 18l8.5-6L4 6v12zm9-12v12l8.5-6L13 6z"/></svg></div>
                </div>`
            },
            {
                name: 'subs',
                html: '<div class="art-layer-subtitles"><div id="sub-text"></div></div>'
            }
        ],
        customType: {
            m3u8: function(video, url) {
                if (Hls.isSupported()) {
                    const hls = new Hls();
                    hls.loadSource(url);
                    hls.attachMedia(video);
                    hls.on(Hls.Events.MANIFEST_PARSED, () => {
                        // QUALITY SETTINGS
                        art.setting.add({
                            name: 'quality', html: 'Quality',
                            selector: [{html: 'Auto', level: -1, default: true}, ...hls.levels.map((l, i) => ({html: l.height+'p', level: i}))],
                            onSelect: (i) => { hls.currentLevel = i.level; return i.html; }
                        });
                        // AUDIO TRACKS
                        if(hls.audioTracks.length > 1) {
                            art.setting.add({
                                name: 'audio', html: 'Audio',
                                selector: hls.audioTracks.map((t, i) => ({html: t.name || t.lang, index: i})),
                                onSelect: (i) => { hls.audioTrack = i.index; return i.html; }
                            });
                        }
                    });
                }
            }
        }
    });

    art.on('video:playing', () => {
        document.getElementById('loading-layer').style.display = 'none';
    });

    art.on('ready', () => {
        const pI = document.getElementById('svg-play');
        const sI = document.getElementById('svg-pause');
        art.on('play', () => { pI.style.display='none'; sI.style.display='block'; });
        art.on('pause', () => { pI.style.display='block'; sI.style.display='none'; });

        if(subs.length) {
            art.setting.add({
                name: 'subtitles', html: 'Subtitles',
                selector: [{html: 'Off', url: null, default: true}, ...subs.map(s=>({html: s.lang || s.language, url: PROXY(s.url)}))],
                onSelect: async i => {
                    if(!i.url) { currentSubs=[]; document.getElementById('sub-text').style.display='none'; return 'Off'; }
                    const txt = await fetch(i.url).then(r => r.text());
                    currentSubs = parseVtt(txt);
                    document.getElementById('sub-text').style.display='block';
                    return i.html;
                }
            });
        }
    });

    art.on('video:timeupdate', () => {
        if(!currentSubs.length) return;
        const now = art.currentTime;
        const cue = currentSubs.find(c => now >= c.s && now <= c.e);
        const el = document.getElementById('sub-text');
        if(cue) {
            if(cue !== lastCue) { el.innerHTML = cue.text; lastCue = cue; }
        } else { el.innerHTML = ""; lastCue = null; }
    });
}
</script>
</body>
</html>
