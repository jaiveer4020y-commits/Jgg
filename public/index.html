<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>CINEMA QUANTUM ENGINE | V11.0 ULTRA BUILD</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    
    <link rel="stylesheet" href="https://unpkg.com/artplayer@5.3.0/dist/artplayer.css">
    <script src="https://unpkg.com/hls.js@1.5.17/dist/hls.min.js"></script>
    <script src="https://unpkg.com/artplayer@5.3.0/dist/artplayer.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800;900&display=swap" rel="stylesheet">

    <style>
        /* ================================================================
        1. ADVANCED DESIGN SYSTEM (ADS)
        ================================================================
        */
        :root {
            --nf-red: #E50914;
            --nf-black: #050505;
            --nf-dark-grey: #141414;
            --nf-mid-grey: #2f2f2f;
            --nf-light-grey: #b3b3b3;
            --glass-bg: rgba(5, 5, 5, 0.85);
            --blur-heavy: blur(40px);
            --transition-smooth: cubic-bezier(0.25, 0.1, 0.25, 1);
            --shadow-red: 0 0 20px rgba(229, 9, 20, 0.4);
        }

        /* ================================================================
        2. GLOBAL RESET & SMOOTH ANIMATIONS
        ================================================================
        */
        * { box-sizing: border-box; -webkit-font-smoothing: antialiased; outline: none !important; }
        body, html {
            margin: 0; padding: 0; width: 100vw; height: 100vh;
            background-color: var(--nf-black); color: #fff;
            font-family: 'Inter', sans-serif; overflow: hidden;
            user-select: none;
        }

        /* SMOOTH NON-LAGGY SPINNER */
        @keyframes nf-spin-smooth {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        @keyframes fade-in { from { opacity: 0; transform: scale(0.95); } to { opacity: 1; transform: scale(1); } }
        @keyframes logo-float { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-10px); } }

        /* ================================================================
        3. QUANTUM DASHBOARD UI
        ================================================================
        */
        #quantum-dashboard {
            position: fixed; inset: 0; z-index: 100;
            background: radial-gradient(circle at center, #1a1a1a 0%, #000 100%);
            display: flex; align-items: center; justify-content: center;
            transition: all 0.8s var(--transition-smooth);
        }

        .dashboard-hidden { transform: scale(1.1); opacity: 0; pointer-events: none; }

        .quantum-card {
            width: 95%; max-width: 480px; padding: 40px;
            background: var(--glass-bg); backdrop-filter: var(--blur-heavy);
            border: 1px solid rgba(255,255,255,0.1); border-radius: 30px;
            box-shadow: 0 30px 60px rgba(0,0,0,0.8);
            animation: fade-in 0.8s ease-out;
        }

        .brand-logo {
            font-size: 2.5rem; font-weight: 900; color: var(--nf-red);
            text-align: center; margin-bottom: 30px; letter-spacing: -2px;
            text-transform: uppercase; text-shadow: var(--shadow-red);
        }

        .mode-selector {
            display: flex; gap: 8px; margin-bottom: 25px;
            background: #000; padding: 5px; border-radius: 15px;
        }
        .mode-btn {
            flex: 1; padding: 12px; border: none; border-radius: 12px;
            background: transparent; color: #666; font-weight: 700;
            cursor: pointer; transition: 0.3s; font-size: 13px;
        }
        .mode-btn.active { background: var(--nf-red); color: #fff; }

        .input-group { margin-bottom: 20px; }
        .input-group label {
            display: block; font-size: 10px; font-weight: 900; color: var(--nf-red);
            text-transform: uppercase; margin-bottom: 8px; letter-spacing: 2px;
        }
        .main-input {
            width: 100%; padding: 16px; background: #111; border: 1px solid #222;
            border-radius: 12px; color: #fff; font-size: 15px; transition: 0.3s;
        }
        .main-input:focus { border-color: var(--nf-red); background: #000; }

        .search-results {
            position: absolute; width: 100%; max-height: 300px; background: #111;
            z-index: 50; border-radius: 12px; overflow-y: auto; display: none;
            border: 1px solid #333; margin-top: 5px;
        }
        .result-item {
            display: flex; gap: 15px; padding: 12px; border-bottom: 1px solid #222;
            cursor: pointer; align-items: center;
        }
        .result-item:hover { background: #1a1a1a; }
        .result-item img { width: 40px; height: 60px; border-radius: 4px; object-fit: cover; }

        .launch-btn {
            width: 100%; padding: 18px; background: var(--nf-red); color: #fff;
            border: none; border-radius: 12px; font-weight: 900; cursor: pointer;
            text-transform: uppercase; letter-spacing: 2px; margin-top: 10px;
            box-shadow: var(--shadow-red); transition: 0.3s;
        }
        .launch-btn:hover { transform: translateY(-2px); filter: brightness(1.2); }

        /* ================================================================
        4. LOADING LAYER (TMDB LOGO + SMOOTH SPINNER)
        ================================================================
        */
        #quantum-loader {
            position: fixed; inset: 0; z-index: 900; background: #000;
            display: none; align-items: center; justify-content: center;
            flex-direction: column;
        }

        #loader-backdrop {
            position: absolute; inset: 0; width: 100%; height: 100%;
            object-fit: cover; opacity: 0; transition: opacity 2.5s;
            filter: brightness(0.3) blur(15px); transform: scale(1.1);
        }

        .loader-content {
            z-index: 10; text-align: center; display: flex;
            flex-direction: column; align-items: center; gap: 30px;
        }

        #tmdb-og-logo {
            max-width: 280px; max-height: 150px; object-fit: contain;
            filter: drop-shadow(0 0 20px rgba(0,0,0,0.8));
            animation: logo-float 4s ease-in-out infinite;
            display: none;
        }

        .loading-spinner-container img {
            width: 70px; height: 70px;
            animation: nf-spin-smooth 2s linear infinite; /* SMOOTH & SLOW */
        }

        #meta-status {
            font-size: 12px; color: var(--nf-red); font-weight: 800;
            text-transform: uppercase; letter-spacing: 4px;
        }

        /* ================================================================
        5. ARTPLAYER CORE STYLES & OVERRIDES
        ================================================================
        */
        #viewport { position: fixed; inset: 0; background: #000; z-index: 1000; display: none; }

        /* CENTER CONTROLS - REFINED */
        .mobileCenterControls_playerControlsInnerContainer__6MCmU {
            position: absolute; inset: 0; display: flex; align-items: center;
            justify-content: center; gap: 8vw; pointer-events: none;
            opacity: 0; transition: opacity 0.4s var(--transition-smooth);
            z-index: 20;
        }
        .art-hover .mobileCenterControls_playerControlsInnerContainer__6MCmU,
        .art-state-paused .mobileCenterControls_playerControlsInnerContainer__6MCmU { opacity: 1; }

        .videasy-scale {
            background: transparent !important; /* NO BACKGROUND */
            border: none; width: 55px; height: 55px; display: flex;
            align-items: center; justify-content: center; color: white;
            cursor: pointer; pointer-events: auto; transition: 0.2s;
            filter: drop-shadow(0 0 10px rgba(0,0,0,0.5));
        }
        .videasy-scale:hover { transform: scale(1.1); color: var(--nf-red); }
        .videasy-icon-lg { width: 32px; height: 32px; }

        #ButtonPlay { width: 80px; height: 80px; }
        #ButtonPlay .videasy-icon-lg { width: 45px; height: 45px; }

        /* HIDE DEFAULT ARTPLAYER LOADING */
        .art-loading-icon, .art-state-loading .art-loading-icon { 
            display: none !important; opacity: 0 !important; visibility: hidden !important; 
        }

        .back-nav {
            position: absolute; top: 30px; left: 30px; z-index: 10001;
            cursor: pointer; background: rgba(0,0,0,0.4); padding: 12px;
            border-radius: 50%; border: 1px solid rgba(255,255,255,0.1);
            transition: 0.3s;
        }
        .back-nav:hover { background: var(--nf-red); transform: translateX(-5px); }

    </style>
</head>
<body>

<div id="quantum-dashboard">
    <div class="quantum-card">
        <div class="brand-logo">Cinema Pro</div>
        
        <div class="mode-selector">
            <button class="mode-btn active" id="mode-tv" onclick="switchMode('tv')">Series</button>
            <button class="mode-btn" id="mode-movie" onclick="switchMode('movie')">Movie</button>
        </div>

        <div class="input-group">
            <label>Master Database Search</label>
            <input type="text" id="engine-search" class="main-input" placeholder="Search for title..." autocomplete="off">
            <div id="search-results-overlay" class="search-results"></div>
        </div>

        <div id="se-logic-container">
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                <div class="input-group">
                    <label>Season</label>
                    <input type="number" id="season-val" class="main-input" value="1" min="1">
                </div>
                <div class="input-group">
                    <label>Episode</label>
                    <input type="number" id="episode-val" class="main-input" value="1" min="1">
                </div>
            </div>
        </div>

        <button class="launch-btn" onclick="bootstrapStream()">Initialize Playback</button>
    </div>
</div>

<div id="quantum-loader">
    <img id="loader-backdrop" src="">
    <div class="loader-content">
        <img id="tmdb-og-logo" src="" alt="Title Logo">
        <div class="loading-spinner-container">
            <img src="https://assets.nflxext.com/en_us/pages/wiplayer/site-spinner.png" alt="Loading...">
        </div>
        <div id="meta-status">Initializing Quantum Tunnel...</div>
    </div>
</div>

<div id="viewport">
    <div class="back-nav" onclick="killEngine()">
        <svg viewBox="0 0 24 24" width="24" height="24" fill="white"><path d="M20 11H7.83l5.59-5.59L12 4l-8 8 8 8 1.41-1.41L7.83 13H20v-2z"/></svg>
    </div>
    <div id="art-target" style="width:100%; height:100%;"></div>
</div>

<script>
/**
 * CINEMA QUANTUM CORE ENGINE v11.0
 * Logic: Multi-Stage Resolver, Logo Fetcher, Forced Settings
 */

const CORE = {
    KEY: '463dcd7993ab31d92eb586802fdeee6a',
    PROXY: (u) => `https://workingg.vercel.app/api/proxy?url=${encodeURIComponent(u)}`,
    MODE: 'tv',
    ID: null,
    TITLE: '',
    PLAYER: null,
    HLS: null,
    SUB_OFFSET: 0
};

// 1. DYNAMIC SEARCH & LOGO PRE-FETCH
const searchInput = document.getElementById('engine-search');
const resultBox = document.getElementById('search-results-overlay');

searchInput.addEventListener('input', async (e) => {
    const query = e.target.value;
    if(query.length < 2) { resultBox.style.display = 'none'; return; }

    try {
        const resp = await fetch(`https://api.themoviedb.org/3/search/multi?api_key=${CORE.KEY}&query=${encodeURIComponent(query)}`);
        const data = await resp.json();
        
        resultBox.innerHTML = '';
        resultBox.style.display = 'block';
        
        data.results.slice(0, 8).forEach(item => {
            if(item.media_type !== 'tv' && item.media_type !== 'movie') return;
            const row = document.createElement('div');
            row.className = 'result-item';
            row.innerHTML = `
                <img src="https://image.tmdb.org/t/p/w92${item.poster_path}">
                <div>
                    <div style="font-weight:700; font-size:14px;">${item.title || item.name}</div>
                    <div style="font-size:11px; color:#888;">${item.media_type.toUpperCase()} â€¢ ${(item.release_date || item.first_air_date || '').split('-')[0]}</div>
                </div>
            `;
            row.onclick = () => {
                CORE.ID = item.id;
                CORE.TITLE = item.title || item.name;
                CORE.MODE = item.media_type;
                searchInput.value = CORE.TITLE;
                resultBox.style.display = 'none';
                updateUI(CORE.MODE);
            };
            resultBox.appendChild(row);
        });
    } catch(err) { console.error("Search Error"); }
});

function updateUI(m) {
    CORE.MODE = m;
    document.querySelectorAll('.mode-btn').forEach(b => b.classList.remove('active'));
    document.getElementById(`mode-${m}`).classList.add('active');
    document.getElementById('se-logic-container').style.display = m === 'tv' ? 'block' : 'none';
}

function switchMode(m) { updateUI(m); searchInput.value = ''; CORE.ID = null; }

// 2. BOOTSTRAP STREAM & FETCH LOGO
async function bootstrapStream() {
    if(!CORE.ID) return alert("Select a title first");

    const loader = document.getElementById('quantum-loader');
    loader.style.display = 'flex';
    document.getElementById('meta-status').innerText = "Fetching Metadata...";

    // FETCH LOGO & BACKDROP
    try {
        const [meta, images] = await Promise.all([
            fetch(`https://api.themoviedb.org/3/${CORE.MODE}/${CORE.ID}?api_key=${CORE.KEY}`).then(r=>r.json()),
            fetch(`https://api.themoviedb.org/3/${CORE.MODE}/${CORE.ID}/images?api_key=${CORE.KEY}`).then(r=>r.json())
        ]);

        if(meta.backdrop_path) {
            const bg = document.getElementById('loader-backdrop');
            bg.src = `https://image.tmdb.org/t/p/original${meta.backdrop_path}`;
            bg.style.opacity = '1';
        }

        const logoImg = document.getElementById('tmdb-og-logo');
        const logoData = images.logos.find(l => l.file_path.endsWith('.png'));
        if(logoData) {
            logoImg.src = `https://image.tmdb.org/t/p/w500${logoData.file_path}`;
            logoImg.style.display = 'block';
        } else {
            logoImg.style.display = 'none';
        }
    } catch(e) { console.warn("Metadata failed"); }

    const s = document.getElementById('season-val').value;
    const e = document.getElementById('episode-val').value;
    const sPad = s.toString().padStart(2, '0');
    const ePad = e.toString().padStart(2, '0');

    // RESOLVE SLUG: game.of.thrones.s01e01 (FIXED)
    const cleanTitle = CORE.TITLE.toLowerCase().replace(/[^a-z0-9\s]/gi, '').trim().replace(/\s+/g, '.');
    const finalSlug = CORE.MODE === 'tv' ? `${cleanTitle}.s${sPad}e${ePad}` : cleanTitle;

    document.getElementById('meta-status').innerText = `Resolving Stream: ${finalSlug}...`;

    const streamApi = `https://u-1-1azw.onrender.com/api/get-stream?title=${encodeURIComponent(finalSlug)}&id=${CORE.ID}&season=${s}&episode=${e}`;
    
    try {
        const streamData = await fetch(CORE.PROXY(streamApi)).then(r => r.json());
        if(streamData.m3u8_url) {
            initQuantumPlayer(CORE.PROXY(streamData.m3u8_url));
        } else {
            alert("No stream found for this resolution.");
            loader.style.display = 'none';
        }
    } catch(err) {
        alert("Bridge Failure");
        loader.style.display = 'none';
    }
}

// 3. PLAYER INITIALIZATION (FORCED SETTINGS)
function initQuantumPlayer(m3u8) {
    document.getElementById('viewport').style.display = 'block';
    document.getElementById('quantum-loader').style.display = 'none';
    document.getElementById('quantum-dashboard').classList.add('dashboard-hidden');

    CORE.PLAYER = new Artplayer({
        container: '#art-target',
        url: m3u8,
        type: 'm3u8',
        autoplay: true,
        fullscreen: true,
        setting: true,
        theme: '#E50914',
        loadingShow: false, // OFF AS REQUESTED
        layers: [
            {
                name: 'custom-controls',
                html: `
                    <div class="mobileCenterControls_playerControlsInnerContainer__6MCmU">
                        <button class="videasy-scale" onclick="CORE.PLAYER.backward=10">
                            <svg viewBox="0 0 24 24" fill="none" class="videasy-icon-lg"><path fill-rule="evenodd" clip-rule="evenodd" d="M11.02 2.048A10 10 0 1 1 2 12H0a12 12 0 1 0 5-9.747V1H3v4a1 1 0 0 0 1 1h4V4H6a10 10 0 0 1 5.02-1.952ZM2 4v3h3v2H1a1 1 0 0 1-1-1V4h2Zm12.125 12c-.578 0-1.086-.141-1.523-.424-.43-.29-.764-.694-.999-1.215-.235-.527-.353-1.148-.353-1.861 0-.707.118-1.324.353-1.851.236-.527.568-.932.999-1.215.437-.29.945-.434 1.523-.434s1.083.145 1.513.434c.437.283.774.688 1.009 1.215.235.527.353 1.144.353 1.851 0 .713-.118 1.334-.353 1.86-.235.522-.572.927-1.009 1.216-.43.283-.935.424-1.513.424Zm0-1.35c.39 0 .696-.186.918-.56.222-.378.333-.909.333-1.59s-.111-1.208-.333-1.581c-.222-.38-.528-.57-.918-.57s-.696.19-.918.57c-.222.373-.333.9-.333 1.581 0 .681.111 1.212.333 1.59.222.374.528.56.918.56Zm-5.521 1.205v-5.139L7 11.141V9.82l3.198-.8v6.835H8.604Z" fill="currentColor"></path></svg>
                        </button>
                        <button id="ButtonPlay" class="videasy-scale" onclick="CORE.PLAYER.toggle()">
                            <svg xmlns="http://www.w3.org/2000/svg" width="1em" height="1em" viewBox="0 0 384 512" class="videasy-icon-lg" style="transform: translateX(5%);"><path fill="currentColor" d="M73 39c-14.8-9.1-33.4-9.4-48.5-.9S0 62.6 0 80V432c0 17.4 9.4 33.4 24.5 41.9s33.7 8.1 48.5-.9L361 297c14.3-8.7 23-24.2 23-41s-8.7-32.2-23-41L73 39z"></path></svg>
                        </button>
                        <button class="videasy-scale" onclick="CORE.PLAYER.forward=10">
                            <svg viewBox="0 0 24 24" fill="none" class="videasy-icon-lg"><path fill-rule="evenodd" clip-rule="evenodd" d="M6.444 3.685A10 10 0 0 1 18 4h-2v2h4a1 1 0 0 0 1-1V1h-2v1.253A12 12 0 1 0 24 12h-2A10 10 0 1 1 6.444 3.685ZM22 4v3h-3v2h4a1 1 0 0 0 1-1V4h-2Zm-9.398 11.576c.437.283.945.424 1.523.424s1.083-.141 1.513-.424c.437-.29.774-.694 1.009-1.215.235-.527.353-1.148.353-1.861 0-.707-.118-1.324-.353-1.851-.235-.527-.572-.932-1.009-1.215-.43-.29-.935-.434-1.513-.434-.578 0-1.086.145-1.523.434-.43.283-.764.688-.999 1.215-.235.527-.353 1.144-.353 1.851 0 .713.118 1.334.353 1.86.236.522.568.927.999 1.216Zm2.441-1.485c-.222.373-.528.56-.918.56s-.696-.187-.918-.56c-.222-.38-.333-.91-.333-1.591 0-.681.111-1.208.333-1.581.222-.38.528-.57.918-.57s.696.19.918.57c.222.373.333.9.333 1.581 0 .681-.111 1.212-.333 1.59Zm-6.439-3.375v5.14h1.594V9.018L7 9.82v1.321l1.604-.424Z" fill="currentColor"></path></svg>
                        </button>
                    </div>
                `
            },
            {
                name: 'netflix-spinner-layer',
                html: `
                    <div class="art-state-loading-spinner" style="position:absolute; top:50%; left:50%; transform:translate(-50%,-50%); display:none;">
                        <div class="loading-spinner-container">
                             <img src="https://assets.nflxext.com/en_us/pages/wiplayer/site-spinner.png" style="width:70px;">
                        </div>
                    </div>
                `
            }
        ],
        customType: {
            m3u8: function(video, url) {
                if (Hls.isSupported()) {
                    const hls = new Hls();
                    hls.loadSource(url);
                    hls.attachMedia(video);
                    CORE.HLS = hls;

                    hls.on(Hls.Events.MANIFEST_PARSED, () => {
                        // FORCED AUDIO SWITCHER
                        if(hls.audioTracks.length > 0) {
                            CORE.PLAYER.setting.add({
                                name: 'audio',
                                html: 'Audio Track',
                                selector: hls.audioTracks.map((t, i) => ({
                                    html: t.name || t.lang || `Audio ${i+1}`,
                                    index: i,
                                    default: i === hls.audioTrack
                                })),
                                onSelect: (item) => { hls.audioTrack = item.index; return item.html; }
                            });
                        }

                        // SUBTITLE SWITCHER
                        CORE.PLAYER.setting.add({
                            name: 'subs',
                            html: 'Subtitles',
                            selector: [
                                {html: 'Off', url: null, default: true},
                                {html: 'English', url: 'https://example.com/en.vtt'}
                            ],
                            onSelect: (item) => item.html
                        });

                        // SUBTITLE DELAY (1-5 SEC)
                        CORE.PLAYER.setting.add({
                            name: 'sub-delay',
                            html: 'Sub Delay',
                            selector: [1, 2, 3, 4, 5].map(v => ({ html: `${v}s`, value: v })),
                            onSelect: (item) => { CORE.SUB_OFFSET = item.value; return item.html; }
                        });
                    });
                } else { video.src = url; }
            }
        }
    });

    // Handle play/pause icon swap
    CORE.PLAYER.on('play', () => {
        const btn = document.querySelector('#ButtonPlay');
        if(btn) btn.innerHTML = '<svg viewBox="0 0 320 512" class="videasy-icon-lg"><path fill="currentColor" d="M48 64C21.5 64 0 85.5 0 112V400c0 26.5 21.5 48 48 48H80c26.5 0 48-21.5 48-48V112c0-26.5-21.5-48-48-48H48zm192 0c-26.5 0-48 21.5-48 48V400c0 26.5 21.5 48 48 48h32c26.5 0 48-21.5 48-48V112c0-26.5-21.5-48-48-48H240z"/></svg>';
    });
    CORE.PLAYER.on('pause', () => {
        const btn = document.querySelector('#ButtonPlay');
        if(btn) btn.innerHTML = '<svg viewBox="0 0 384 512" class="videasy-icon-lg" style="transform: translateX(5%);"><path fill="currentColor" d="M73 39c-14.8-9.1-33.4-9.4-48.5-.9S0 62.6 0 80V432c0 17.4 9.4 33.4 24.5 41.9s33.7 8.1 48.5-.9L361 297c14.3-8.7 23-24.2 23-41s-8.7-32.2-23-41L73 39z"></path></svg>';
    });

    // Custom Loading Spinner Toggle
    CORE.PLAYER.on('loading', (show) => {
        const spin = document.querySelector('.art-state-loading-spinner');
        if(spin) spin.style.display = show ? 'block' : 'none';
    });
}

function killEngine() {
    if(CORE.PLAYER) CORE.PLAYER.destroy();
    if(CORE.HLS) CORE.HLS.destroy();
    document.getElementById('viewport').style.display = 'none';
    document.getElementById('quantum-dashboard').classList.remove('dashboard-hidden');
}

</script>
</body>
</html>
