<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta
  name="viewport"
  content="width=device-width, initial-scale=1, maximum-scale=1"
/>

<title>ArtPlayer Full</title>

<!-- ArtPlayer -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/artplayer@5/dist/artplayer.css">
<script src="https://cdn.jsdelivr.net/npm/artplayer@5/dist/artplayer.js"></script>

<!-- HLS -->
<script src="https://cdn.jsdelivr.net/npm/hls.js@1.5.15/dist/hls.min.js"></script>

<style>
html, body {
    margin: 0;
    padding: 0;
    background: #000;
    width: 100%;
    height: 100%;
    overflow: hidden;
}

#player {
    width: 100%;
    height: 100%;
    background: #000;
}

/* Netflix spinner */
.art-loading::after {
    content: '';
    position: absolute;
    width: 48px;
    height: 48px;
    border-radius: 50%;
    border: 4px solid rgba(255,255,255,.25);
    border-top-color: #fff;
    animation: spin 1s linear infinite;
}

@keyframes spin {
    to { transform: rotate(360deg); }
}

/* Jump icons */
.jump-icon {
    width: 26px;
    height: 26px;
}
</style>
</head>

<body>
<div id="player"></div>

<script>
/* =========================================================
   STRICT PARAM PARSING (NO SILENT FAIL)
========================================================= */
const params = new URLSearchParams(window.location.search);

const TITLE   = params.get('title');   // REQUIRED
const IMDB_ID = params.get('id');
const SEASON  = params.get('season');
const EPISODE = params.get('episode');

if (!TITLE) {
    document.body.innerHTML =
        '<h2 style="color:white;text-align:center;margin-top:40vh">Missing ?title</h2>';
    throw new Error('TITLE missing');
}

/* =========================================================
   ENDPOINTS
========================================================= */
const STREAM_API = `https://u-1-1azw.onrender.com/api/get-stream?title=${encodeURIComponent(TITLE)}`;
const PROXY      = 'https://workingg.vercel.app/api/proxy?url=';

/* =========================================================
   FETCH STREAM URL
========================================================= */
async function fetchStreamUrl() {
    const res = await fetch(STREAM_API);
    if (!res.ok) throw new Error('Stream API failed');

    const json = await res.json();
    if (!json || !json.url) throw new Error('Invalid stream response');

    return PROXY + encodeURIComponent(json.url);
}

/* =========================================================
   FETCH SUBTITLES
========================================================= */
async function fetchSubtitles() {
    if (!IMDB_ID) return [];

    let url;
    if (SEASON && EPISODE) {
        url = `https://sub.wyzie.ru/search?id=${IMDB_ID}&season=${SEASON}&episode=${EPISODE}`;
    } else {
        url = `https://sub.wyzie.ru/search?id=${IMDB_ID}`;
    }

    const res = await fetch(PROXY + encodeURIComponent(url));
    if (!res.ok) return [];

    const json = await res.json();
    return Array.isArray(json) ? json : [];
}

/* =========================================================
   INIT
========================================================= */
(async () => {

const STREAM_URL = await fetchStreamUrl();
const SUBS       = await fetchSubtitles();

let hlsInstance = null;

/* =========================================================
   ARTPLAYER
========================================================= */
const art = new Artplayer({
    container: '#player',
    url: STREAM_URL,
    type: 'm3u8',
    autoplay: true,
    autoSize: true,
    autoPlayback: true,
    muted: false,

    fullscreen: true,
    fullscreenWeb: true,
    pip: true,
    airplay: true,

    setting: true,
    playbackRate: true,
    aspectRatio: true,
    subtitleOffset: true,
    miniProgressBar: true,
    mutex: true,
    fastForward: true,
    lock: true,

    controls: [
        {
            name: 'backward',
            position: 'left',
            html: `<img class="jump-icon" src="https://rivestream.org/images/player/backward.svg">`,
            click: () => art.currentTime -= 10
        },
        {
            name: 'play',
            position: 'left',
            html: `<img class="jump-icon" src="https://rivestream.org/images/player/play.svg">`,
            click: () => art.toggle()
        },
        {
            name: 'forward',
            position: 'left',
            html: `<img class="jump-icon" src="https://rivestream.org/images/player/forward.svg">`,
            click: () => art.currentTime += 10
        }
    ],

    customType: {
        m3u8(video, url) {
            if (hlsInstance) {
                hlsInstance.destroy();
                hlsInstance = null;
            }

            if (Hls.isSupported()) {
                hlsInstance = new Hls({
                    enableWorker: true,
                    lowLatencyMode: false,
                    backBufferLength: 90,
                    maxBufferLength: 60,
                    maxMaxBufferLength: 120,
                });

                hlsInstance.loadSource(url);
                hlsInstance.attachMedia(video);
            } else if (video.canPlayType('application/vnd.apple.mpegurl')) {
                video.src = url;
            } else {
                console.error('HLS not supported');
            }
        }
    }
});

/* =========================================================
   SETTINGS (QUALITY / AUDIO / SUBS)
========================================================= */
art.on('ready', () => {

    /* QUALITY */
    if (hlsInstance && hlsInstance.levels?.length) {
        art.setting.add({
            name: 'Quality',
            html: 'Quality',
            selector: [
                { html: 'Auto', value: -1 },
                ...hlsInstance.levels.map((l, i) => ({
                    html: l.height ? `${l.height}p` : `Level ${i}`,
                    value: i
                }))
            ],
            onSelect(item) {
                hlsInstance.currentLevel = item.value;
                return item.html;
            }
        });
    }

    /* AUDIO (SETTINGS ONLY, NO BUTTON) */
    if (hlsInstance && hlsInstance.audioTracks?.length > 1) {
        art.setting.add({
            name: 'Audio',
            html: 'Audio',
            selector: hlsInstance.audioTracks.map((t, i) => ({
                html: t.name || t.lang || `Track ${i + 1}`,
                value: i
            })),
            onSelect(item) {
                hlsInstance.audioTrack = item.value;
                return item.html;
            }
        });
    }

    /* SUBTITLES */
    if (SUBS.length) {
        art.setting.add({
            name: 'Subtitles',
            html: 'Subtitles',
            selector: SUBS.map((s, i) => ({
                html: s.lang || s.language || `Subtitle ${i + 1}`,
                value: i
            })),
            onSelect(item) {
                const s = SUBS[item.value];
                art.subtitle = {
                    url: s.url,
                    type: s.url.endsWith('.srt') ? 'srt' : 'vtt',
                    encoding: 'utf-8'
                };
                return item.html;
            }
        });
    }
});

/* =========================================================
   ERROR LOGGING
========================================================= */
art.on('error', e => {
    console.error('ART ERROR', e);
});

})();
</script>
</body>
</html>
