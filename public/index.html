<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Stable ArtPlayer HLS</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<!-- ArtPlayer -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/artplayer@5/dist/artplayer.css">

<style>
/* ================= GLOBAL ================= */
html, body {
    margin: 0;
    padding: 0;
    background: #000;
    height: 100%;
    font-family: system-ui, -apple-system, BlinkMacSystemFont;
}

/* ================= PLAYER ================= */
#player-wrapper {
    width: 100%;
    height: 100vh;
    display: flex;
    align-items: center;
    justify-content: center;
}

#player {
    width: 100%;
    max-width: 980px;
    height: 560px;
    background: #000;
    position: relative;
}

/* ================= CENTER CONTROLS ================= */
.center-controls {
    position: absolute;
    inset: 0;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 120px;
    opacity: 0;
    transition: opacity .25s ease;
    pointer-events: none;
    z-index: 20;
}

.art-state-show .center-controls {
    opacity: 1;
    pointer-events: auto;
}

.center-controls img {
    width: 64px;
    height: 64px;
    opacity: .9;
}

.center-controls .play img {
    width: 92px;
    height: 92px;
}

/* ================= AUDIO BUTTON ================= */
.audio-btn {
    position: absolute;
    top: 14px;
    right: 14px;
    z-index: 30;
    background: rgba(0,0,0,.55);
    border-radius: 50%;
    width: 44px;
    height: 44px;
    display: flex;
    align-items: center;
    justify-content: center;
}

.audio-btn img {
    width: 24px;
    height: 24px;
}

/* ================= SUBTITLES ================= */
.art-subtitle {
    font-size: 22px !important;
    background: rgba(0,0,0,.45);
    padding: 4px 10px;
    border-radius: 4px;
    text-shadow: 2px 2px 6px #000;
}
</style>
</head>

<body>

<div id="player-wrapper">
    <div id="player"></div>
</div>

<!-- LIBS -->
<script src="https://cdn.jsdelivr.net/npm/hls.js@1.5.15"></script>
<script src="https://cdn.jsdelivr.net/npm/artplayer@5/dist/artplayer.js"></script>

<script>
/* =====================================================
   HARD GUARANTEED EXECUTION (NO SILENT FAIL)
===================================================== */
(function () {
'use strict';

/* ================= CONFIG ================= */
const PROXY = 'https://workingg.vercel.app/api/proxy?url=';
const FALLBACK_TITLE = 'wednesday.s02e05';

/* ================= TITLE DETECTION ================= */
const params = new URLSearchParams(window.location.search);
let title = params.get('title');

if (!title || title.trim() === '') {
    console.warn('Title missing – using fallback');
    title = FALLBACK_TITLE;
}

/* ================= LOG ================= */
console.log('[PLAYER] title =', title);

/* ================= FETCH STREAM ================= */
async function getStream() {
    const apiUrl = 'https://u-1-1azw.onrender.com/api/get-stream?title=' + encodeURIComponent(title);
    const proxied = PROXY + encodeURIComponent(apiUrl);

    console.log('[PLAYER] Fetch stream:', proxied);

    const res = await fetch(proxied);
    if (!res.ok) throw new Error('Stream API failed');

    return res.json();
}

/* ================= FETCH SUBTITLES ================= */
async function getSubtitle(imdb) {
    if (!imdb) return null;

    const subApi = 'https://sub.wyzie.ru/search?id=' + imdb;
    const proxied = PROXY + encodeURIComponent(subApi);

    console.log('[PLAYER] Fetch subtitles:', proxied);

    const res = await fetch(proxied);
    if (!res.ok) return null;

    const data = await res.json();
    const vtt = data?.subtitles?.find(s => s.format === 'vtt');

    return vtt ? vtt.url : null;
}

/* ================= MAIN ================= */
(async function init() {

    let stream;
    try {
        stream = await getStream();
    } catch (e) {
        alert('Stream API error');
        console.error(e);
        return;
    }

    if (!stream || !stream.m3u8_url) {
        alert('Invalid stream data');
        return;
    }

    const m3u8 = PROXY + encodeURIComponent(stream.m3u8_url);
    console.log('[PLAYER] M3U8:', m3u8);

    let subtitleUrl = null;
    try {
        subtitleUrl = await getSubtitle(stream.imdb);
    } catch (e) {
        console.warn('Subtitle error');
    }

    /* ================= ARTPLAYER ================= */
    let hls = null;

    const art = new Artplayer({
        container: '#player',
        url: m3u8,
        type: 'm3u8',

        autoplay: true,
        muted: true,   // REQUIRED FOR iOS
        volume: 1,

        setting: true,
        playbackRate: true,
        aspectRatio: true,
        fullscreen: true,
        fullscreenWeb: true,

        subtitle: subtitleUrl ? {
            url: subtitleUrl,
            type: 'vtt',
            encoding: 'utf-8'
        } : null,

        layers: [{
            name: 'center-controls',
            html: `
            <div class="center-controls">
                <div class="btn back">
                    <img src="https://rivestream.org/images/player/backward.svg">
                </div>
                <div class="btn play">
                    <img src="https://rivestream.org/images/player/play.svg">
                </div>
                <div class="btn forward">
                    <img src="https://rivestream.org/images/player/forward.svg">
                </div>
            </div>`
        }],

        customType: {
            m3u8(video, url) {

                if (hls) {
                    console.warn('HLS already attached – skip');
                    return;
                }

                if (Hls.isSupported()) {
                    hls = new Hls({
                        enableWorker: true,
                        maxBufferLength: 30,
                        maxMaxBufferLength: 60,
                        fragLoadingMaxRetry: 1,
                        levelLoadingMaxRetry: 1
                    });

                    hls.loadSource(url);
                    hls.attachMedia(video);

                    hls.on(Hls.Events.MANIFEST_PARSED, () => {
                        console.log('[PLAYER] Manifest parsed');

                        const levels = hls.levels.map((l, i) => ({
                            html: l.height + 'p',
                            level: i
                        }));

                        art.setting.add({
                            name: 'quality',
                            html: 'Quality',
                            selector: levels,
                            onSelect(item) {
                                hls.currentLevel = item.level;
                                return item.html;
                            }
                        });
                    });
                } else {
                    video.src = url;
                }
            }
        }
    });

    /* ================= AUDIO BUTTON ================= */
    const audioBtn = document.createElement('div');
    audioBtn.className = 'audio-btn';
    audioBtn.innerHTML = `<img src="https://cdn-icons-png.flaticon.com/512/727/727245.png">`;
    document.getElementById('player').appendChild(audioBtn);

    audioBtn.onclick = () => {
        art.muted = !art.muted;
        audioBtn.style.opacity = art.muted ? 0.5 : 1;
    };

    /* ================= CENTER CONTROLS ================= */
    art.on('ready', () => {
        const back = document.querySelector('.btn.back');
        const play = document.querySelector('.btn.play');
        const forward = document.querySelector('.btn.forward');

        back.onclick = () => art.seek = art.currentTime - 10;

        forward.onclick = () => art.seek = art.currentTime + 10;

        play.onclick = () => {
            art.toggle();
            art.muted = false; // unlock audio
        };
    });

})();
})();
</script>

</body>
</html>
