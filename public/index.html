<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>ArtPlayer Netflix</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<link rel="stylesheet" href="https://unpkg.com/artplayer@5.3.0/dist/artplayer.css">
<script src="https://unpkg.com/artplayer@5.3.0/dist/artplayer.js"></script>
<script src="https://unpkg.com/hls.js@1.5.17/dist/hls.min.js"></script>

<style>
html,body{
    margin:0;
    padding:0;
    width:100%;
    height:100%;
    background:#000;
}

#player{
    position:relative;
    width:100%;
    height:100%;
    background:#000;
    overflow:hidden;
}

/* ================= NETFLIX SPINNER ================= */
.netflix-spinner{
    position:absolute;
    inset:0;
    display:flex;
    align-items:center;
    justify-content:center;
    background:#000;
    z-index:9999999;
}

.netflix-spinner img{
    width:64px;
    height:64px;
}

/* ================= SUBTITLE CONTAINER ================= */
.subtitle-container{
    position:absolute;
    width:90%;
    left:50%;
    bottom:12%;
    transform:translateX(-50%);
    display:flex;
    align-items:center;
    justify-content:center;
    z-index:9999998;
    pointer-events:none;
    transition:all .3s ease;
}

.subtitle-container p{
    font-weight:500;
    text-align:center;
    color:rgb(252,244,244);
    font-size:23px;
    background:rgba(0,0,0,0);
    text-shadow:
        0 2px 4px rgba(0,0,0,.9),
        0 0 2px rgba(0,0,0,.9);
    white-space:pre-wrap;
    line-height:1.4;
}
</style>
</head>

<body>

<div id="player">

    <!-- NETFLIX SPINNER -->
    <div class="netflix-spinner" id="spinner">
        <img src="https://assets.nflxext.com/en_us/pages/wiplayer/site-spinner.png">
    </div>

    <!-- SUBTITLE -->
    <div class="subtitle-container SubtitleVideoCaption_mobileSubtitleContainer__vo_7_">
        <p id="subtitleText"></p>
    </div>

</div>

<script>
/* ================= CONFIG ================= */
const RENDER_API = "https://u-1-1azw.onrender.com/api/get-stream";
const SUB_API = "https://sub.wyzie.ru/search";
const PROXY = "https://workingg.vercel.app/api/proxy?url=";

/* ================= HELPERS ================= */
const qs = k => new URLSearchParams(location.search).get(k);
const spinner = document.getElementById("spinner");
const subtitleEl = document.getElementById("subtitleText");

function showSpinner(v){
    spinner.style.display = v ? "flex" : "none";
}

function toSec(t){
    const p = t.replace(",",".").split(":");
    return (+p[0])*3600 + (+p[1])*60 + parseFloat(p[2]);
}

function parseVTT(vtt){
    const cues=[];
    vtt.split("\n\n").forEach(b=>{
        if(!b.includes("-->")) return;
        const l=b.split("\n");
        const [s,e]=l[0].split(" --> ");
        cues.push({
            start:toSec(s),
            end:toSec(e),
            text:l.slice(1).join("\n")
        });
    });
    return cues;
}

/* ================= SLUG ================= */
const TITLE = qs("title") || qs("tittle");
const IMDB = qs("id");
const SEASON = qs("season");
const EPISODE = qs("episode");

if(!TITLE){
    alert("Missing ?title=");
    throw new Error("No title");
}

/* ================= FETCH STREAM ================= */
async function fetchStream(){
    showSpinner(true);
    const api = `${RENDER_API}?title=${encodeURIComponent(TITLE)}`;
    const r = await fetch(PROXY + encodeURIComponent(api));
    const j = await r.json();
    return PROXY + encodeURIComponent(j.m3u8_url);
}

/* ================= FETCH SUBS ================= */
async function fetchSubs(){
    if(!IMDB) return [];
    let url = `${SUB_API}?id=${IMDB}`;
    if(SEASON && EPISODE) url += `&season=${SEASON}&episode=${EPISODE}`;
    const r = await fetch(PROXY + encodeURIComponent(url));
    return await r.json();
}

/* ================= MAIN ================= */
(async()=>{
const streamUrl = await fetchStream();
const subs = await fetchSubs();

let cues=[];
let active=null;

const art = new Artplayer({
    container:"#player",
    url:streamUrl,
    type:"m3u8",
    autoplay:true,
    setting:true,
    hotkey:true,
    pip:true,
    fullscreen:true,
    playbackRate:true,
    aspectRatio:true,
    screenshot:true,
    lock:true,
    mutex:true,
    theme:"#e50914",

    customType:{
        m3u8(video,url){
            const hls=new Hls({enableWorker:true});
            hls.loadSource(url);
            hls.attachMedia(video);

            hls.on(Hls.Events.MANIFEST_PARSED,()=>{
                showSpinner(false);
            });

            hls.on(Hls.Events.ERROR,()=>{
                showSpinner(true);
            });
        }
    }
});

/* ===== SPINNER EVENTS ===== */
art.on("video:loadstart",()=>showSpinner(true));
art.on("video:waiting",()=>showSpinner(true));
art.on("video:stalled",()=>showSpinner(true));
art.on("video:playing",()=>showSpinner(false));

/* ===== SUBTITLES ===== */
if(subs.length){
    art.setting.add({
        name:"subtitle",
        html:"Subtitles",
        selector:subs.map((s,i)=>({
            html:s.language || s.lang || s.name || "Subtitle",
            url:PROXY + encodeURIComponent(s.url),
            default:i===0
        })),
        onSelect:async item=>{
            const r = await fetch(item.url);
            cues = parseVTT(await r.text());
            subtitleEl.textContent="";
            return item.html;
        }
    });

    const r = await fetch(PROXY + encodeURIComponent(subs[0].url));
    cues = parseVTT(await r.text());
}

/* ===== SUBTITLE RENDER ===== */
art.on("video:timeupdate",()=>{
    const t = art.currentTime;
    const c = cues.find(x=>t>=x.start && t<=x.end);
    if(c){
        subtitleEl.textContent = c.text;
    }else{
        subtitleEl.textContent = "";
    }
});
})();
</script>

</body>
</html>
