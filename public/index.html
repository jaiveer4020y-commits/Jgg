<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Netflix Pro Player | NextGen Engine</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <link rel="stylesheet" href="https://unpkg.com/artplayer@5.3.0/dist/artplayer.css">

    <style>
        :root { --n-red: #e50914; --bg: #000; }
        html, body { margin: 0; padding: 0; background: #000; color: #fff; font-family: sans-serif; height: 100%; overflow: hidden; }

        /* ===== HOME DASHBOARD ===== */
        #home-page {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: radial-gradient(circle, #222 0%, #000 100%);
            display: flex; align-items: center; justify-content: center; z-index: 5000;
        }
        .ui-card {
            background: #141414; padding: 40px; border-radius: 12px;
            box-shadow: 0 20px 50px rgba(0,0,0,0.9); width: 100%; max-width: 380px; text-align: center;
        }
        .ui-card h1 { color: var(--n-red); margin-bottom: 25px; letter-spacing: 2px; }
        input, select {
            width: 100%; padding: 12px; margin: 10px 0; border-radius: 4px;
            border: 1px solid #333; background: #000; color: #fff; box-sizing: border-box;
        }
        .play-btn {
            width: 100%; padding: 15px; background: var(--n-red); border: none;
            color: #fff; font-weight: bold; cursor: pointer; border-radius: 4px; margin-top: 15px;
        }

        /* ===== LOADING LAYER (POSTER + SPINNER) ===== */
        #loading-layer {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: #000 no-repeat center center; background-size: cover;
            display: none; align-items: center; justify-content: center; z-index: 9999;
        }
        #loading-layer::before {
            content: ""; position: absolute; top:0; left:0; width:100%; height:100%;
            background: rgba(0,0,0,0.7);
        }
        .net-spinner { width: 80px; height: 80px; z-index: 10000; animation: spin 1.1s linear infinite; }
        @keyframes spin { from {transform:rotate(0deg)} to {transform:rotate(360deg)} }

        /* ===== PLAYER BOX ===== */
        #player { width: 100vw; height: 100vh; background: #000; }

        /* ===== CENTER ICONS (SMART FADE) ===== */
        .custom-center-wrapper {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            display: flex; align-items: center; justify-content: center; gap: 60px;
            z-index: 100; pointer-events: none; opacity: 0; visibility: hidden;
            transition: opacity 0.3s ease;
        }
        /* Sync with Artplayer UI */
        .art-state-show .custom-center-wrapper { opacity: 1; visibility: visible; }
        .center-btn {
            background: none; border: none; color: #fff; cursor: pointer;
            pointer-events: auto; display: flex; align-items: center; justify-content: center;
        }
        .center-btn svg { width: 50px; height: 50px; filter: drop-shadow(0 0 10px #000); }

        /* ===== RESUME TOAST ===== */
        #resume-toast {
            position: absolute; bottom: 100px; left: 40px; background: #1a1a1a;
            border-left: 4px solid var(--n-red); padding: 15px 25px; border-radius: 4px;
            display: none; z-index: 1000; cursor: pointer; box-shadow: 0 10px 30px #000;
        }

        /* ===== SUBTITLES ===== */
        .custom-subtitle-container {
            position: absolute; bottom: 80px; left: 0; right: 0;
            display: flex; justify-content: center; pointer-events: none; z-index: 100;
        }
        .custom-subtitle-text {
            padding: 8px 16px; font-size: 25px; font-weight: 500; color: #fff;
            background: rgba(0, 0, 0, 0.8); text-shadow: 0 2px 4px #000;
            border-radius: 4px; text-align: center; max-width: 85%;
        }
    </style>
</head>
<body>

<div id="home-page">
    <div class="ui-card">
        <h1>NEXTGEN PRO</h1>
        <select id="m-type" onchange="document.getElementById('tv-meta').style.display=(this.value==='tv'?'block':'none')">
            <option value="movie">Movie</option>
            <option value="tv">TV Series</option>
        </select>
        <input type="text" id="m-id" placeholder="TMDB ID (e.g. 1396)">
        <div id="tv-meta" style="display:none">
            <input type="number" id="m-s" placeholder="Season">
            <input type="number" id="m-e" placeholder="Episode">
        </div>
        <button class="play-btn" onclick="initLaunch()">WATCH NOW</button>
    </div>
</div>

<div id="loading-layer">
    <img class="net-spinner" src="https://assets.nflxext.com/en_us/pages/wiplayer/site-spinner.png">
</div>

<div id="player"></div>

<div id="resume-toast" onclick="resumePlay()">
    <small style="color:var(--n-red)">CONTINUE WATCHING</small><br>
    <b id="resume-msg">Jump to 0:00?</b>
</div>

<script src="https://unpkg.com/hls.js@1.5.17/dist/hls.min.js"></script>
<script src="https://unpkg.com/artplayer@5.3.0/dist/artplayer.js"></script>

<script>
const TMDB_KEY = '463dcd7993ab31d92eb586802fdeee6a';
const proxy = u => 'https://workingg.vercel.app/api/proxy?url=' + encodeURIComponent(u);

let art;
let savedTime = 0;
let currentID = "";
let subtitleCues = [];
let activeSub = null;
let subOffset = 0;

function initLaunch() {
    const type = document.getElementById('m-type').value;
    const id = document.getElementById('m-id').value;
    if(!id) return alert("Missing ID");
    
    currentID = `progress_${type}_${id}`;
    startProcess(type, id);
}

async function startProcess(type, id) {
    const loader = document.getElementById('loading-layer');
    loader.style.display = 'flex';

    try {
        // 1. TMDB Metadata
        const metaRes = await fetch(`https://api.themoviedb.org/3/${type}/${id}?api_key=${TMDB_KEY}`);
        const meta = await metaRes.json();
        const title = meta.title || meta.name;
        if(meta.backdrop_path) loader.style.backgroundImage = `url(https://image.tmdb.org/t/p/original${meta.backdrop_path})`;

        // 2. Stream
        const streamRes = await fetch(proxy(`https://u-1-1azw.onrender.com/api/get-stream?title=${encodeURIComponent(title)}`));
        const streamData = await streamRes.json();
        
        // 3. Subtitles
        let subU = `https://sub.wyzie.ru/search?id=${meta.imdb_id || id}`;
        if(type==='tv') subU += `&season=${document.getElementById('m-s').value}&episode=${document.getElementById('m-e').value}`;
        const subs = await fetch(proxy(subU)).then(r=>r.json()).catch(()=>[]);

        launchArt(proxy(streamData.m3u8_url), subs);
    } catch(e) { alert("Error loading stream"); location.reload(); }
}

/* Restored Original Parser Logic */
function parseSub(text){
    const cues=[];
    const cleanText = text.replace(/^WEBVTT\s+/i, '').trim();
    const blocks=cleanText.replace(/\r/g,'').split('\n\n');
    for(const b of blocks){
        const lines=b.split('\n');
        const tIndex = lines.findIndex(l => l.includes('-->'));
        if(tIndex === -1) continue;
        const content = lines.slice(tIndex + 1).join('\n');
        try {
            const [s,e] = lines[tIndex].split('-->').map(t=>{
                const p = t.trim().replace(',','.');
                const pts = p.split(':');
                let h=0, m=0, sm=0;
                if(pts.length === 3) [h, m, sm] = pts; else [m, sm] = pts;
                return (+h)*3600 + (+m)*60 + parseFloat(sm);
            });
            cues.push({s, e, t: content});
        } catch(e) {}
    }
    return cues;
}

function launchArt(m3u8, subs) {
    document.getElementById('home-page').style.display = 'none';

    art = new Artplayer({
        container: '#player',
        url: m3u8,
        type: 'm3u8',
        autoplay: true,
        fullscreen: true,
        fullscreenWeb: true,
        setting: true,
        theme: '#e50914',
        layers: [
            {
                name: 'subtitle-layer',
                html: '<div class="custom-subtitle-container"><div id="sub-text" class="custom-subtitle-text"></div></div>',
            },
            {
                name: 'center-controls',
                html: `
                <div class="custom-center-wrapper">
                    <button class="center-btn" onclick="art.backward=10"><svg viewBox="0 0 24 24" fill="currentColor"><path d="M12 5V1L7 6l5 5V7c3.31 0 6 2.69 6 6s-2.69 6-6 6-6-2.69-6-6H4c0 4.42 3.58 8 8 8s8-3.58 8-8-3.58-8-8-8z"/></svg></button>
                    <button class="center-btn" onclick="art.toggle()">
                        <svg id="c-play" style="display:none" viewBox="0 0 24 24" fill="currentColor"><path d="M8 5v14l11-7z"/></svg>
                        <svg id="c-pause" viewBox="0 0 24 24" fill="currentColor"><path d="M6 19h4V5H6v14zm8-14v14h4V5h-4z"/></svg>
                    </button>
                    <button class="center-btn" onclick="art.forward=10"><svg viewBox="0 0 24 24" fill="currentColor"><path d="M6 13c0-3.31 2.69-6 6-6v4l5-5-5-5v4c-4.42 0-8 3.58-8 8s3.58 8 8 8 8-3.58 8-8h-2z"/></svg></button>
                </div>`
            }
        ],
        customType: {
            m3u8: function(video, url) {
                if (Hls.isSupported()) {
                    const hls = new Hls();
                    hls.loadSource(url);
                    hls.attachMedia(video);
                    // Quality Selector Logic
                    hls.on(Hls.Events.MANIFEST_PARSED, () => {
                        art.setting.add({
                            name: 'quality', html: 'Quality',
                            selector: [{html: 'Auto', level: -1, default: true}, ...hls.levels.map((l, i) => ({html: l.height+'p', level: i}))],
                            onSelect: i => { hls.currentLevel = i.level; return i.html; }
                        });
                    });
                }
            }
        }
    });

    art.on('ready', () => {
        document.getElementById('loading-layer').style.display = 'none';
        
        // Icon Sync
        const playI = document.getElementById('c-play');
        const pauseI = document.getElementById('c-pause');
        art.on('play', () => { playI.style.display='none'; pauseI.style.display='block'; });
        art.on('pause', () => { playI.style.display='block'; pauseI.style.display='none'; });

        // Resume Progress
        savedTime = localStorage.getItem(currentID);
        if(savedTime > 15) {
            document.getElementById('resume-msg').innerText = `Resume at ${Math.floor(savedTime/60)}m?`;
            document.getElementById('resume-toast').style.display = 'block';
            setTimeout(() => { document.getElementById('resume-toast').style.display='none'; }, 8000);
        }

        // Add Subtitle Menus
        if(subs.length) {
            art.setting.add({
                name: 'sub', html: 'Subtitles',
                selector: [{html: 'Off', url: null, default: true}, ...subs.map(s=>({html: s.lang||s.language, url: proxy(s.url)}))],
                onSelect: async i => {
                    if(!i.url) { subtitleCues=[]; document.getElementById('sub-text').innerText=''; return 'Off'; }
                    const t = await fetch(i.url).then(r=>r.text());
                    subtitleCues = parseSub(t);
                    return i.html;
                }
            });
            art.setting.add({
                name: 'sub-delay', html: 'Subtitle Sync',
                selector: [{html: 'Original', value: 0, default: true}, {html: '+1s', value: 1}, {html: '+2s', value: 2}, {html: '-1s', value: -1}, {html: '-2s', value: -2}],
                onSelect: i => { subOffset = i.value; return i.html; }
            });
        }
    });

    art.on('video:timeupdate', () => {
        if(art.currentTime > 10) localStorage.setItem(currentID, Math.floor(art.currentTime));
        
        // Subtitle Sync Engine
        if(!subtitleCues.length) return;
        const t = art.currentTime + subOffset;
        const cue = subtitleCues.find(c => t >= c.s && t <= c.e);
        const el = document.getElementById('sub-text');
        if(cue) {
            if(cue !== activeSub) { el.innerHTML = cue.t.replace(/\n/g, '<br>'); activeSub = cue; }
        } else { el.innerHTML = ''; activeSub = null; }
    });
}

function resumePlay() {
    if(art && savedTime) {
        art.currentTime = parseFloat(savedTime);
        document.getElementById('resume-toast').style.display = 'none';
    }
}
</script>
</body>
</html>
