<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>CINEMA TITAN MAGNUM OPUS | V19.0 FINAL</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    
    <link rel="stylesheet" href="https://unpkg.com/artplayer@5.1.1/dist/artplayer.css">
    <script src="https://unpkg.com/hls.js@1.5.17/dist/hls.min.js"></script>
    <script src="https://unpkg.com/artplayer@5.1.1/dist/artplayer.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700;900&family=Outfit:wght@700;900&display=swap" rel="stylesheet">

    <style>
        /* ================================================================
        1. TITAN CORE AESTHETICS (NEO-NETFLIX DARK)
        ================================================================
        */
        :root {
            --n-red: #E50914;
            --n-black: #050505;
            --glass: rgba(15, 15, 15, 0.95);
            --shadow: 0 0 30px rgba(229, 9, 20, 0.3);
        }

        * { box-sizing: border-box; -webkit-font-smoothing: antialiased; }
        
        body, html {
            margin: 0; padding: 0; width: 100vw; height: 100vh;
            background-color: #000; color: #fff;
            font-family: 'Inter', sans-serif; overflow: hidden;
            user-select: none;
        }

        /* ================================================================
        2. ADVANCED SEARCH TERMINAL UI
        ================================================================
        */
        #titan-terminal {
            position: fixed; inset: 0; z-index: 100;
            background: radial-gradient(circle at center, #1a0505 0%, #000 100%);
            display: flex; align-items: center; justify-content: center;
            transition: transform 1.2s cubic-bezier(0.8, 0, 0.2, 1), opacity 0.8s;
        }

        .terminal-exit { transform: translateY(-100%); opacity: 0; pointer-events: none; }

        .titan-pod {
            width: 95%; max-width: 550px; padding: 50px;
            background: var(--glass); border-radius: 40px;
            border: 1px solid rgba(255,255,255,0.08);
            box-shadow: 0 50px 100px rgba(0,0,0,0.9);
            animation: pod-rise 0.8s ease-out;
        }

        @keyframes pod-rise { from { opacity: 0; transform: translateY(30px); } }

        .titan-title {
            font-family: 'Outfit', sans-serif; font-size: 3rem; font-weight: 900;
            text-align: center; color: var(--n-red); margin-bottom: 35px;
            text-transform: uppercase; letter-spacing: -2px;
            text-shadow: 0 0 20px rgba(229, 9, 20, 0.5);
        }

        .mode-switch {
            display: flex; gap: 10px; margin-bottom: 30px;
            background: #000; padding: 8px; border-radius: 20px;
        }

        .mode-btn {
            flex: 1; padding: 15px; border: none; border-radius: 15px;
            background: transparent; color: #555; font-weight: 800;
            text-transform: uppercase; cursor: pointer; transition: 0.3s;
            font-size: 12px; letter-spacing: 1px;
        }

        .mode-btn.active { background: var(--n-red); color: #fff; box-shadow: var(--shadow); }

        .input-stack { margin-bottom: 25px; position: relative; }
        .input-stack label {
            display: block; font-size: 11px; font-weight: 900; color: var(--n-red);
            text-transform: uppercase; margin-bottom: 12px; letter-spacing: 3px;
        }

        .titan-input {
            width: 100%; padding: 20px; background: #000; border: 1px solid #222;
            border-radius: 18px; color: #fff; font-size: 16px; transition: 0.4s;
        }

        .titan-input:focus { border-color: var(--n-red); box-shadow: 0 0 0 5px rgba(229,9,20,0.15); }

        .portal-results {
            position: absolute; width: 100%; max-height: 350px; background: #0d0d0d;
            top: 105%; left: 0; z-index: 500; border-radius: 20px; overflow-y: auto;
            display: none; border: 1px solid #1a1a1a; box-shadow: 0 40px 80px rgba(0,0,0,1);
        }

        .portal-item {
            display: flex; gap: 15px; padding: 15px; border-bottom: 1px solid #111;
            cursor: pointer; align-items: center; transition: 0.3s;
        }
        .portal-item:hover { background: #161616; padding-left: 20px; }
        .portal-item img { width: 45px; height: 65px; border-radius: 8px; object-fit: cover; }
        .portal-item div { font-weight: 700; font-size: 14px; }

        .btn-init {
            width: 100%; padding: 25px; background: var(--n-red); color: #fff;
            border: none; border-radius: 20px; font-weight: 900; font-size: 18px;
            text-transform: uppercase; letter-spacing: 5px; cursor: pointer;
            transition: 0.4s; box-shadow: var(--shadow);
        }
        .btn-init:hover { transform: translateY(-3px); filter: brightness(1.2); }

        /* ================================================================
        3. OG NETFLIX SPINNER & LOADING HUD
        ================================================================
        */
        #titan-loading {
            position: fixed; inset: 0; z-index: 900; background: #000;
            display: none; align-items: center; justify-content: center; flex-direction: column;
        }

        #poster-bg {
            position: absolute; inset: 0; width: 100%; height: 100%;
            object-fit: cover; opacity: 0; transition: opacity 1.5s;
            filter: brightness(0.4); /* NO BLUR */
        }

        .loading-vortex {
            z-index: 10; text-align: center; display: flex;
            flex-direction: column; align-items: center; gap: 35px;
        }

        #vortex-logo { max-width: 320px; max-height: 150px; object-fit: contain; display: none; margin-bottom: 20px; }

        /* THE REAL OG NETFLIX SPINNER */
        .netflix-spinner {
            width: 100px; height: 100px; position: relative;
        }
        .netflix-spinner::before {
            content: ""; box-sizing: border-box; position: absolute;
            inset: 0; border-radius: 50%;
            border: 4px solid rgba(229, 9, 20, 0.15);
            border-top-color: var(--n-red);
            animation: netflix-rotate 0.9s cubic-bezier(0.5, 0.1, 0.5, 0.9) infinite;
        }
        @keyframes netflix-rotate {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }

        #boot-msg {
            font-size: 13px; color: var(--n-red); font-weight: 900;
            text-transform: uppercase; letter-spacing: 6px;
        }

        /* ================================================================
        4. ARTPLAYER TITAN VIEWPORT & LAYER-MATRIX
        ================================================================
        */
        #titan-viewport { position: fixed; inset: 0; background: #000; z-index: 1000; display: none; }

        /* ELYSIUM SUBTITLE LAYER (FIXES NULL ERROR) */
        .elysium-subtitle-box {
            position: absolute; bottom: 12%; left: 0; right: 0;
            pointer-events: none; z-index: 2000; text-align: center;
            display: flex; justify-content: center; padding: 0 8%;
        }

        .elysium-sub-text {
            background: rgba(0, 0, 0, 0.85);
            color: #ffffff;
            padding: 6px 16px;
            border-radius: 8px;
            font-size: clamp(20px, 4vw, 36px);
            font-weight: 600;
            line-height: 1.4;
            text-shadow: 0 2px 4px rgba(0,0,0,1);
            display: none; /* Managed via SubtitleUpdate */
        }

        /* TITAN CENTER CONTROLS - AUTO HIDDEN ON LOADING */
        .mobileCenterControls_playerControlsInnerContainer__6MCmU {
            position: absolute; inset: 0; display: flex; align-items: center;
            justify-content: center; gap: 15vw; pointer-events: none;
            opacity: 0; transition: opacity 0.4s; z-index: 150;
        }
        .art-hover .mobileCenterControls_playerControlsInnerContainer__6MCmU,
        .art-state-paused .mobileCenterControls_playerControlsInnerContainer__6MCmU { opacity: 1; }

        /* HIDE CONTROLS WHEN LOADING STATE IS ACTIVE */
        .art-state-loading .mobileCenterControls_playerControlsInnerContainer__6MCmU {
            display: none !important;
        }

        .titan-ctrl {
            background: transparent !important; border: none; width: 65px; height: 65px; 
            display: flex; align-items: center; justify-content: center; 
            color: #fff; cursor: pointer; pointer-events: auto; 
            transition: 0.25s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }
        .titan-ctrl:hover { transform: scale(1.3); color: var(--n-red); }

        #TitanPlayBtn { width: 100px; height: 100px; }
        #TitanPlayBtn svg { width: 55px; height: 55px; }

        .btn-exit-titan {
            position: absolute; top: 40px; left: 40px; z-index: 3000;
            cursor: pointer; background: rgba(0,0,0,0.5); padding: 15px;
            border-radius: 50%; border: 1px solid rgba(255,255,255,0.1);
            transition: 0.3s; backdrop-filter: blur(10px);
        }
        .btn-exit-titan:hover { background: var(--n-red); transform: translateX(-5px); }

    </style>
</head>
<body>

<div id="titan-terminal">
    <div class="titan-pod">
        <div class="titan-title">Titan Cinema</div>
        
        <div class="mode-switch">
            <button class="mode-btn active" id="m-tv" onclick="switchTitanMode('tv')">TV Episodes</button>
            <button class="mode-btn" id="m-movie" onclick="switchTitanMode('movie')">Movie Film</button>
        </div>

        <div class="input-stack">
            <label>Neuro-Search Uplink</label>
            <input type="text" id="titan-search" class="titan-input" placeholder="Enter title name..." autocomplete="off">
            <div id="portal-results" class="portal-results"></div>
        </div>

        <div id="tv-logic-grid">
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
                <div class="input-stack">
                    <label>Season</label>
                    <input type="number" id="s-val" class="titan-input" value="1" min="1">
                </div>
                <div class="input-stack">
                    <label>Episode</label>
                    <input type="number" id="e-val" class="titan-input" value="1" min="1">
                </div>
            </div>
        </div>

        <button class="btn-init" onclick="initTitanBoot()">Initialize Link</button>
    </div>
</div>

<div id="titan-loading">
    <img id="poster-bg" src="">
    <div class="loading-vortex">
        <img id="vortex-logo" src="">
        <div class="netflix-spinner"></div>
        <div id="boot-msg">Calibrating Neural Link...</div>
    </div>
</div>

<div id="titan-viewport">
    <div class="btn-exit-titan" onclick="killTitan()">
        <svg viewBox="0 0 24 24" width="28" height="28" fill="white"><path d="M20 11H7.83l5.59-5.59L12 4l-8 8 8 8 1.41-1.41L7.83 13H20v-2z"/></svg>
    </div>
    
    <div class="elysium-subtitle-box">
        <div class="elysium-sub-text" id="titan-sub-node"></div>
    </div>

    <div id="art-titan-mount" style="width:100%; height:100%;"></div>
</div>

<script>
/**
 * CINEMA TITAN MAGNUM OPUS - V19.0
 * Features: Corrected Subtitle URL, Audio Switcher Fix, Manual Layer Logic, Netflix Buffering.
 */

const TITAN = {
    TMDB: '463dcd7993ab31d92eb586802fdeee6a',
    PROXY: (u) => `https://workingg.vercel.app/api/proxy?url=${encodeURIComponent(u)}`,
    MODE: 'tv',
    ID: null,
    TITLE: '',
    YEAR: '',
    SLUG: '',
    PLAYER: null,
    HLS: null,
    SUBS: []
};

// 1. NEURO SEARCH SYSTEM
const tSearch = document.getElementById('titan-search');
const tPortal = document.getElementById('portal-results');

tSearch.addEventListener('input', async (e) => {
    const q = e.target.value;
    if(q.length < 2) { tPortal.style.display = 'none'; return; }

    try {
        const r = await fetch(`https://api.themoviedb.org/3/search/multi?api_key=${TITAN.TMDB}&query=${encodeURIComponent(q)}`);
        const d = await r.json();
        tPortal.innerHTML = '';
        if(d.results.length > 0) {
            tPortal.style.display = 'block';
            d.results.slice(0, 10).forEach(item => {
                if(item.media_type !== 'tv' && item.media_type !== 'movie') return;
                const yr = (item.release_date || item.first_air_date || '').split('-')[0];
                const div = document.createElement('div');
                div.className = 'portal-item';
                div.innerHTML = `
                    <img src="https://image.tmdb.org/t/p/w92${item.poster_path}" onerror="this.src='https://via.placeholder.com/92x138/000/fff?text=?'">
                    <div>${item.title || item.name} (${yr || 'N/A'})</div>
                `;
                div.onclick = () => {
                    TITAN.ID = item.id;
                    TITAN.TITLE = item.title || item.name;
                    TITAN.YEAR = yr;
                    TITAN.MODE = item.media_type;
                    tSearch.value = TITAN.TITLE;
                    tPortal.style.display = 'none';
                    switchTitanMode(TITAN.MODE);
                };
                tPortal.appendChild(div);
            });
        }
    } catch(err) { console.warn("Search Portal Error"); }
});

function switchTitanMode(m) {
    TITAN.MODE = m;
    document.querySelectorAll('.mode-btn').forEach(b => b.classList.remove('active'));
    document.getElementById(`m-${m}`).classList.add('active');
    document.getElementById('tv-logic-grid').style.display = m === 'tv' ? 'block' : 'none';
}

// 2. TITAN BOOT SEQUENCE (SUBTITLE URL FIX)
async function initTitanBoot() {
    if(!TITAN.ID) return alert("Titan Alert: Target not found.");

    const hub = document.getElementById('titan-loading');
    hub.style.display = 'flex';
    document.getElementById('boot-msg').innerText = "Establishing Link...";

    // Meta & Poster
    try {
        const [meta, imgs] = await Promise.all([
            fetch(`https://api.themoviedb.org/3/${TITAN.MODE}/${TITAN.ID}?api_key=${TITAN.TMDB}`).then(r=>r.json()),
            fetch(`https://api.themoviedb.org/3/${TITAN.MODE}/${TITAN.ID}/images?api_key=${TITAN.TMDB}`).then(r=>r.json())
        ]);
        if(meta.backdrop_path) {
            const bg = document.getElementById('poster-bg');
            bg.src = `https://image.tmdb.org/t/p/original${meta.backdrop_path}`;
            bg.style.opacity = '1';
        }
        const logo = document.getElementById('vortex-logo');
        const bestLogo = imgs.logos.find(l => l.file_path.endsWith('.png'));
        if(bestLogo) {
            logo.src = `https://image.tmdb.org/t/p/w500${bestLogo.file_path}`;
            logo.style.display = 'block';
        }
    } catch(e) { }

    const s = document.getElementById('s-val').value;
    const e = document.getElementById('e-val').value;
    const cleanT = TITAN.TITLE.toLowerCase().replace(/[^a-z0-9\s]/gi, '').trim().replace(/\s+/g, '.');
    
    TITAN.SLUG = TITAN.MODE === 'tv' ? `${cleanT}.s${s.padStart(2, '0')}e${e.padStart(2, '0')}` : `${cleanT}.${TITAN.YEAR}`;

    // SUBTITLE RESOLVER - FIXING THE MAPPING
    document.getElementById('boot-msg').innerText = "Resolving Subtitle Matrix...";
    try {
        let subApi = `https://sub.wyzie.ru/search?id=${TITAN.ID}`;
        if(TITAN.MODE === 'tv') subApi += `&season=${s}&episode=${e}`;
        
        const subData = await fetch(TITAN.PROXY(subApi)).then(r => r.json());
        if(subData && Array.isArray(subData)) {
            TITAN.SUBS = subData.map(item => ({
                html: item.lang || 'Subtitle',
                url: TITAN.PROXY(item.url),
                name: item.lang
            }));
        }
    } catch(err) { console.error("Subtitle Protocol Offline"); }

    document.getElementById('boot-msg').innerText = "Establishing Stream Tunnel...";
    const api = `https://u-1-1azw.onrender.com/api/get-stream?title=${encodeURIComponent(TITAN.SLUG)}&id=${TITAN.ID}&season=${s}&episode=${e}`;
    
    try {
        const res = await fetch(TITAN.PROXY(api)).then(r => r.json());
        if(res.m3u8_url) {
            bootTitanPlayer(TITAN.PROXY(res.m3u8_url));
        } else { throw new Error(); }
    } catch(err) {
        alert("Titan Error: Stream Link Down.");
        hub.style.display = 'none';
    }
}

// 3. TITAN PLAYER ARCHITECTURE (AUDIO & LAYER FIX)
function bootTitanPlayer(url) {
    document.getElementById('titan-viewport').style.display = 'block';
    document.getElementById('titan-loading').style.display = 'none';
    document.getElementById('titan-terminal').classList.add('terminal-exit');

    if(TITAN.PLAYER) TITAN.PLAYER.destroy();

    TITAN.PLAYER = new Artplayer({
        container: '#art-titan-mount',
        url: url,
        type: 'm3u8',
        autoplay: true,
        autoSize: true,
        fullscreen: true,
        setting: true,
        theme: '#E50914',
        icons: {
            loading: '<div class="netflix-spinner"></div>',
            state: '<img src="https://assets.nflxext.com/en_us/pages/wiplayer/site-spinner.png" style="width:70px; animation: netflix-rotate 1.5s linear infinite;">'
        },
        layers: [
            {
                name: 'titan-controls',
                html: `
                    <div class="mobileCenterControls_playerControlsInnerContainer__6MCmU">
                        <button class="titan-ctrl" onclick="TITAN.PLAYER.backward=10">
                            <svg viewBox="0 0 24 24" fill="currentColor" width="40"><path d="M12.5 3c-4.97 0-9 4.03-9 9H1l4 4 4-4H6.5c0-3.03 2.47-5.5 5.5-5.5s5.5 2.47 5.5 5.5-2.47 5.5-5.5 5.5c-1.51 0-2.88-.61-3.88-1.59l-1.42 1.43C8.16 18.31 9.98 19 12 19c4.97 0 9-4.03 9-9s-4.03-9-9-9z"/></svg>
                        </button>
                        <button id="TitanPlayBtn" class="titan-ctrl" onclick="TITAN.PLAYER.toggle()">
                            <svg viewBox="0 0 24 24" fill="currentColor" width="60"><path d="M8 5v14l11-7z"/></svg>
                        </button>
                        <button class="titan-ctrl" onclick="TITAN.PLAYER.forward=10">
                            <svg viewBox="0 0 24 24" fill="currentColor" width="40"><path d="M11.5 3c4.97 0 9 4.03 9 9h2.5l-4 4-4-4H17.5c0-3.03-2.47-5.5-5.5-5.5s-5.5 2.47-5.5 5.5 2.47 5.5 5.5 5.5c1.51 0 2.88-.61 3.88-1.59l1.42 1.43C15.84 18.31 14.02 19 12 19c-4.97 0-9-4.03-9-9s4.03-9 9-9z"/></svg>
                        </button>
                    </div>
                `
            }
        ],
        customType: {
            m3u8: function(video, url) {
                if (Hls.isSupported()) {
                    const hls = new Hls({
                        enableWorker: true,
                        lowLatencyMode: true
                    });
                    hls.loadSource(url);
                    hls.attachMedia(video);
                    TITAN.HLS = hls;

                    hls.on(Hls.Events.MANIFEST_PARSED, () => {
                        // 1. Resolution Matrix
                        const lvls = hls.levels.map((l, i) => ({ html: `${l.height}P`, index: i }));
                        TITAN.PLAYER.setting.add({
                            name: 'quality',
                            html: 'Resolution',
                            selector: [{html: 'Auto-Negotiate', index: -1, default: true}, ...lvls],
                            onSelect: (item) => { hls.currentLevel = item.index; return item.html; }
                        });

                        // 2. AUDIO TRACK SELECTOR (FORCED INJECTION)
                        if(hls.audioTracks.length > 0) {
                            TITAN.PLAYER.setting.add({
                                name: 'audio',
                                html: 'Audio Selection',
                                selector: hls.audioTracks.map((t, i) => ({
                                    html: t.name || t.lang || `Audio ${i+1}`,
                                    index: i,
                                    default: i === hls.audioTrack
                                })),
                                onSelect: (item) => {
                                    hls.audioTrack = item.index;
                                    return item.html;
                                }
                            });
                        }

                        // 3. SUBTITLE MATRIX (LAYER SYNC)
                        TITAN.PLAYER.setting.add({
                            name: 'subs',
                            html: 'Subtitle Matrix',
                            selector: [{html: 'Off', url: '', default: true}, ...TITAN.SUBS],
                            onSelect: (item) => {
                                if(item.url) {
                                    TITAN.PLAYER.subtitle.url = item.url;
                                    TITAN.PLAYER.subtitle.show = true;
                                    injectAppleTrack(item.url, item.html);
                                } else {
                                    TITAN.PLAYER.subtitle.show = false;
                                    document.getElementById('titan-sub-node').style.display = 'none';
                                    clearAppleTracks();
                                }
                                return item.html;
                            }
                        });

                        // 4. Advanced Playback
                        TITAN.PLAYER.setting.add({
                            name: 'speed',
                            html: 'Playback Rate',
                            selector: [{html: '0.5x', val: 0.5}, {html: '0.75x', val: 0.75}, {html: 'Normal', val: 1, default: true}, {html: '1.25x', val: 1.25}, {html: '1.5x', val: 1.5}, {html: '2x', val: 2}],
                            onSelect: (item) => { video.playbackRate = item.val; return item.html; }
                        });
                    });
                }
            }
        }
    });

    // THE "NULL" FIX: Manual Layer Observer
    TITAN.PLAYER.on('subtitleUpdate', (text) => {
        const node = document.getElementById('titan-sub-node');
        if(text) {
            node.innerHTML = text;
            node.style.display = 'inline-block';
        } else {
            node.style.display = 'none';
        }
    });

    // Control State Synchronization
    TITAN.PLAYER.on('play', () => {
        document.querySelector('#TitanPlayBtn').innerHTML = '<svg viewBox="0 0 24 24" fill="currentColor" width="60"><path d="M6 19h4V5H6v14zm8-14v14h4V5h-4z"/></svg>';
    });
    TITAN.PLAYER.on('pause', () => {
        document.querySelector('#TitanPlayBtn').innerHTML = '<svg viewBox="0 0 24 24" fill="currentColor" width="60"><path d="M8 5v14l11-7z"/></svg>';
    });
}

// APPLE NATIVE SUBTITLE BRIDGE
function injectAppleTrack(url, label) {
    const v = document.querySelector('video');
    if(!v) return;
    clearAppleTracks();
    const track = document.createElement('track');
    track.kind = 'subtitles';
    track.label = label;
    track.srclang = 'en';
    track.src = url;
    track.default = true;
    v.appendChild(track);
}

function clearAppleTracks() {
    const v = document.querySelector('video');
    if(!v) return;
    const tracks = v.querySelectorAll('track');
    tracks.forEach(t => t.remove());
}

function killTitan() {
    if(TITAN.PLAYER) TITAN.PLAYER.destroy();
    if(TITAN.HLS) TITAN.HLS.destroy();
    document.getElementById('titan-viewport').style.display = 'none';
    document.getElementById('titan-terminal').classList.remove('terminal-exit');
    document.getElementById('poster-bg').style.opacity = '0';
    document.getElementById('titan-sub-node').style.display = 'none';
}

</script>
</body>
</html>
