<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Netflix Pro Player | OG Edition</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <link rel="stylesheet" href="https://unpkg.com/artplayer@5.3.0/dist/artplayer.css">
    <script src="https://unpkg.com/hls.js@1.5.17/dist/hls.min.js"></script>
    <script src="https://unpkg.com/artplayer@5.3.0/dist/artplayer.js"></script>

    <style>
        :root { --n-red: #e50914; --bg: #000; }
        html, body { margin: 0; padding: 0; background: #000; color: #fff; font-family: 'Helvetica Neue', Helvetica, Arial, sans-serif; height: 100%; overflow: hidden; }

        /* ===== SEARCH DASHBOARD ===== */
        #home-page {
            position: fixed; inset: 0; background: #000; 
            display: flex; flex-direction: column; align-items: center; justify-content: flex-start;
            z-index: 5000; padding-top: 50px; overflow-y: auto;
        }
        .search-container { width: 90%; max-width: 600px; text-align: center; margin-bottom: 30px; }
        .search-container h1 { color: var(--n-red); font-size: 3rem; margin-bottom: 20px; font-weight: 900; }
        
        .search-bar { display: flex; gap: 10px; background: #141414; padding: 10px; border-radius: 8px; }
        .search-bar input { flex: 1; background: transparent; border: none; color: white; font-size: 1.1rem; padding: 10px; outline: none; }
        .search-bar button { background: var(--n-red); border: none; color: white; padding: 10px 20px; border-radius: 4px; cursor: pointer; font-weight: bold; }

        /* ===== SEARCH RESULTS ===== */
        #results { 
            display: grid; grid-template-columns: repeat(auto-fill, minmax(140px, 1fr)); 
            gap: 20px; width: 90%; max-width: 1000px; padding-bottom: 50px;
        }
        .movie-card { 
            background: #141414; border-radius: 4px; overflow: hidden; cursor: pointer; 
            transition: transform 0.3s; border: 1px solid #333;
        }
        .movie-card:hover { transform: scale(1.05); border-color: var(--n-red); }
        .movie-card img { width: 100%; aspect-ratio: 2/3; object-fit: cover; }
        .movie-card .info { padding: 8px; font-size: 0.8rem; text-align: center; }

        /* ===== OG NETFLIX LOADING LAYER ===== */
        #loading-layer {
            position: fixed; inset: 0; background: #000 no-repeat center center; background-size: cover;
            display: none; align-items: center; justify-content: center; z-index: 9999;
        }
        #loading-layer::before { content: ""; position: absolute; inset: 0; background: rgba(0,0,0,0.8); }
        
        .spinner-container { position: relative; z-index: 10000; text-align: center; }
        .og-spinner { 
            width: 100px; height: 100px; 
            animation: rotate 1.1s linear infinite; 
        }
        @keyframes rotate { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }

        /* ===== PLAYER BOX ===== */
        #player { width: 100vw; height: 100vh; background: #000; display: none; }

        /* ===== CENTER CONTROLS ===== */
        .custom-center-wrapper {
            position: absolute; inset: 0; display: flex; align-items: center; justify-content: center;
            gap: 80px; z-index: 100; pointer-events: none; opacity: 0; visibility: hidden;
            transition: opacity 0.3s ease;
        }
        .art-state-show .custom-center-wrapper { opacity: 1; visibility: visible; }
        .center-btn { background: none; border: none; color: #fff; cursor: pointer; pointer-events: auto; }
        .center-btn svg { width: 60px; height: 60px; filter: drop-shadow(0 0 10px #000); }

        /* ===== SUBTITLES ===== */
        .custom-subtitle-container {
            position: absolute; bottom: 80px; left: 0; right: 0;
            display: flex; justify-content: center; pointer-events: none; z-index: 100;
        }
        .custom-subtitle-text {
            padding: 8px 16px; font-size: 26px; font-weight: 500; color: #fff;
            background: rgba(0, 0, 0, 0.75); text-shadow: 0 2px 4px #000; border-radius: 4px; text-align: center;
        }
    </style>
</head>
<body>

<div id="home-page">
    <div class="search-container">
        <h1>NETFLIX</h1>
        <div class="search-bar">
            <input type="text" id="search-input" placeholder="Search for a movie or TV show...">
            <button onclick="searchTMDB()">SEARCH</button>
        </div>
    </div>
    <div id="results"></div>
</div>

<div id="loading-layer">
    <div class="spinner-container">
        <img class="og-spinner" src="https://assets.nflxext.com/en_us/pages/wiplayer/site-spinner.png">
        <p style="margin-top:20px; font-weight:bold; letter-spacing:2px;">LOADING...</p>
    </div>
</div>

<div id="player"></div>

<script>
const TMDB_KEY = '463dcd7993ab31d92eb586802fdeee6a';
const proxy = u => 'https://workingg.vercel.app/api/proxy?url=' + encodeURIComponent(u);

let art;
let subtitleCues = [];
let subOffset = 0;
let activeSub = null;

/* TMDB SEARCH LOGIC */
async function searchTMDB() {
    const query = document.getElementById('search-input').value;
    if(!query) return;
    const res = await fetch(`https://api.themoviedb.org/3/search/multi?api_key=${TMDB_KEY}&query=${encodeURIComponent(query)}`);
    const data = await res.json();
    const resultsDiv = document.getElementById('results');
    resultsDiv.innerHTML = "";

    data.results.forEach(item => {
        if(!item.poster_path) return;
        const card = document.createElement('div');
        card.className = 'movie-card';
        card.innerHTML = `
            <img src="https://image.tmdb.org/t/p/w300${item.poster_path}">
            <div class="info">
                <b>${item.title || item.name}</b><br>
                <span>${(item.release_date || item.first_air_date || "").split('-')[0]}</span>
            </div>
        `;
        card.onclick = () => prepareStream(item);
        resultsDiv.appendChild(card);
    });
}

async function prepareStream(item) {
    const type = item.media_type || (item.title ? 'movie' : 'tv');
    const id = item.id;
    const title = item.title || item.name;
    
    const loader = document.getElementById('loading-layer');
    loader.style.display = 'flex';
    if(item.backdrop_path) loader.style.backgroundImage = `url(https://image.tmdb.org/t/p/original${item.backdrop_path})`;

    try {
        const streamRes = await fetch(proxy(`https://u-1-1azw.onrender.com/api/get-stream?title=${encodeURIComponent(title)}`));
        const streamData = await streamRes.json();
        
        let subU = `https://sub.wyzie.ru/search?id=${id}`;
        if(type === 'tv') subU += `&season=1&episode=1`; // Default to S1E1
        const subs = await fetch(proxy(subU)).then(r=>r.json()).catch(()=>[]);

        initArt(proxy(streamData.m3u8_url), subs);
    } catch(e) { 
        alert("Stream not found"); 
        loader.style.display = 'none';
    }
}

/* OG SUBTITLE PARSER */
function parseSub(text){
    const cues=[];
    const cleanText = text.replace(/^WEBVTT\s+/i, '').trim();
    const blocks=cleanText.replace(/\r/g,'').split('\n\n');
    for(const b of blocks){
        const lines=b.split('\n');
        const tIndex = lines.findIndex(l => l.includes('-->'));
        if(tIndex === -1) continue;
        const content = lines.slice(tIndex + 1).join('\n');
        try {
            const [s,e] = lines[tIndex].split('-->').map(t=>{
                const p = t.trim().replace(',','.');
                const pts = p.split(':');
                let h=0, m=0, sm=0;
                if(pts.length === 3) [h, m, sm] = pts; else [m, sm] = pts;
                return (+h)*3600 + (+m)*60 + parseFloat(sm);
            });
            cues.push({s, e, t: content});
        } catch(e) {}
    }
    return cues;
}

function initArt(m3u8, subs) {
    document.getElementById('home-page').style.display = 'none';
    document.getElementById('player').style.display = 'block';

    art = new Artplayer({
        container: '#player',
        url: m3u8,
        type: 'm3u8',
        autoplay: true,
        fullscreen: true,
        fullscreenWeb: true,
        theme: '#e50914',
        setting: true,
        layers: [
            {
                name: 'subtitle-layer',
                html: '<div class="custom-subtitle-container"><div id="sub-text" class="custom-subtitle-text"></div></div>',
            },
            {
                name: 'center-controls',
                html: `
                <div class="custom-center-wrapper">
                    <button class="center-btn" onclick="art.backward=10"><svg viewBox="0 0 24 24" fill="currentColor"><path d="M12 5V1L7 6l5 5V7c3.31 0 6 2.69 6 6s-2.69 6-6 6-6-2.69-6-6H4c0 4.42 3.58 8 8 8s8-3.58 8-8-3.58-8-8-8z"/></svg></button>
                    <button class="center-btn" onclick="art.toggle()">
                        <svg id="c-play" style="display:none" viewBox="0 0 24 24" fill="currentColor"><path d="M8 5v14l11-7z"/></svg>
                        <svg id="c-pause" viewBox="0 0 24 24" fill="currentColor"><path d="M6 19h4V5H6v14zm8-14v14h4V5h-4z"/></svg>
                    </button>
                    <button class="center-btn" onclick="art.forward=10"><svg viewBox="0 0 24 24" fill="currentColor"><path d="M6 13c0-3.31 2.69-6 6-6v4l5-5-5-5v4c-4.42 0-8 3.58-8 8s3.58 8 8 8 8-3.58 8-8h-2z"/></svg></button>
                </div>`
            }
        ],
        customType: {
            m3u8: function(video, url) {
                if (Hls.isSupported()) {
                    const hls = new Hls();
                    hls.loadSource(url);
                    hls.attachMedia(video);
                    hls.on(Hls.Events.MANIFEST_PARSED, () => {
                        art.setting.add({
                            name: 'quality', html: 'Quality',
                            selector: [{html: 'Auto', level: -1, default: true}, ...hls.levels.map((l, i) => ({html: l.height+'p', level: i}))],
                            onSelect: i => { hls.currentLevel = i.level; return i.html; }
                        });
                    });
                }
            }
        }
    });

    /* THE FIX: Remove loading layer ONLY when video actually plays */
    art.on('video:playing', () => {
        const loader = document.getElementById('loading-layer');
        if(loader) {
            loader.style.opacity = '0';
            setTimeout(() => loader.remove(), 500); 
        }
    });

    art.on('ready', () => {
        const pI = document.getElementById('c-play');
        const sI = document.getElementById('c-pause');
        art.on('play', () => { pI.style.display='none'; sI.style.display='block'; });
        art.on('pause', () => { pI.style.display='block'; sI.style.display='none'; });

        if(subs.length) {
            art.setting.add({
                name: 'sub', html: 'Subtitles',
                selector: [{html: 'Off', url: null, default: true}, ...subs.map(s=>({html: s.lang||s.language, url: proxy(s.url)}))],
                onSelect: async i => {
                    if(!i.url) { subtitleCues=[]; document.getElementById('sub-text').innerText=''; return 'Off'; }
                    const t = await fetch(i.url).then(r=>r.text());
                    subtitleCues = parseSub(t);
                    return i.html;
                }
            });
        }
    });

    art.on('video:timeupdate', () => {
        if(!subtitleCues.length) return;
        const t = art.currentTime + subOffset;
        const cue = subtitleCues.find(c => t >= c.s && t <= c.e);
        const el = document.getElementById('sub-text');
        if(cue) {
            if(cue !== activeSub) { el.innerHTML = cue.t.replace(/\n/g, '<br>'); activeSub = cue; }
        } else { el.innerHTML = ''; activeSub = null; }
    });
}
</script>
</body>
</html>
