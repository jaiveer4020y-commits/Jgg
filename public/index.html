<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Netflix Player</title>

<!-- ArtPlayer 5.3.0 -->
<link rel="stylesheet" href="https://unpkg.com/artplayer@5.3.0/dist/artplayer.css">

<style>
html, body {
    margin: 0;
    padding: 0;
    background: #000;
    height: 100%;
    width: 100%;
    font-family: Arial, Helvetica, sans-serif;
}

/* Player container */
#player {
    width: 100%;
    max-width: 980px;
    height: 560px;
    margin: 40px auto;
    background: #000;
    position: relative;
}

/* ===== NETFLIX SPINNER ===== */
.loading-spinner-container {
    display: flex;
    align-items: center;
    justify-content: center;
    width: 64px;
    height: 64px;
}
.loading-spinner-container img {
    width: 64px;
    height: 64px;
    animation: netflix-spin 1.1s linear infinite;
}
@keyframes netflix-spin {
    from { transform: rotate(0deg); }
    to { transform: rotate(360deg); }
}

/* ===== SUBTITLES (VISIBLE FIX) ===== */
.art-subtitle {
    position: absolute !important;
    bottom: 12% !important;
    left: 50% !important;
    transform: translateX(-50%);
    width: 90%;
    text-align: center;
    font-size: 23px !important;
    line-height: 1.4;
    color: rgb(252, 244, 244) !important;
    background-color: rgba(0,0,0,0);
    text-shadow: 0 2px 6px rgba(0,0,0,0.9);
    white-space: pre-wrap;
    z-index: 999999;
}
</style>
</head>

<body>

<div id="player"></div>

<!-- Scripts -->
<script src="https://unpkg.com/hls.js@1.5.17/dist/hls.min.js"></script>
<script src="https://unpkg.com/artplayer@5.3.0/dist/artplayer.js"></script>

<script>
/* =======================
   URL PARAMS (SLUG)
======================= */
const params = new URLSearchParams(location.search);
const TITLE   = params.get('title');
const IMDB_ID = params.get('id');
const SEASON  = params.get('season');
const EPISODE = params.get('episode');

if (!TITLE) {
    alert("Missing title in URL");
    throw new Error("Title missing");
}

/* =======================
   PROXY HELPERS
======================= */
const proxy = url =>
    'https://workingg.vercel.app/api/proxy?url=' + encodeURIComponent(url);

/* =======================
   FETCH STREAM
======================= */
async function fetchStream() {
    const res = await fetch(
        proxy(`https://u-1-1azw.onrender.com/api/get-stream?title=${TITLE}`)
    );
    const json = await res.json();
    if (!json || !json.m3u8_url) throw new Error("Stream not found");
    return proxy(json.m3u8_url);
}

/* =======================
   FETCH SUBTITLES
======================= */
async function fetchSubtitles() {
    if (!IMDB_ID) return [];
    let url = `https://sub.wyzie.ru/search?id=${IMDB_ID}`;
    if (SEASON && EPISODE) {
        url += `&season=${SEASON}&episode=${EPISODE}`;
    }

    const res = await fetch(proxy(url));
    const subs = await res.json();

    return subs.map(s => ({
        html: s.lang || s.language || "Subtitle",
        url: proxy(s.url)
    }));
}

/* =======================
   INIT PLAYER
======================= */
(async () => {

const m3u8 = await fetchStream();
const subtitles = await fetchSubtitles();

const art = new Artplayer({
    container: '#player',
    url: m3u8,
    type: 'm3u8',
    autoplay: true,
    autoSize: true,
    fullscreen: true,
    fullscreenWeb: true,
    pip: true,
    screenshot: true,
    playbackRate: true,
    aspectRatio: true,
    miniProgressBar: true,
    mutex: true,
    backdrop: true,
    playsInline: true,
    lock: true,
    fastForward: true,
    subtitleOffset: true,
    resume: true,
    setting: true,
    theme: '#e50914',

    icons: {
        loading: `
        <div class="loading-spinner-container">
            <img src="https://assets.nflxext.com/en_us/pages/wiplayer/site-spinner.png"
                 onerror="this.onerror=null;
                 this.src='https://placehold.co/64x64/cccccc/333333?text=Loading';">
        </div>`
    },

    customType: {
        m3u8(video, url) {
            if (Hls.isSupported()) {
                const hls = new Hls({
                    enableWorker: true,
                    lowLatencyMode: false
                });
                hls.loadSource(url);
                hls.attachMedia(video);
                art.hls = hls;

                /* QUALITY */
                hls.on(Hls.Events.MANIFEST_PARSED, () => {
                    art.setting.add({
                        name: 'quality',
                        html: 'Quality',
                        selector: [
                            { html: 'Auto', level: -1, default: true },
                            ...hls.levels.map((l, i) => ({
                                html: l.height + 'p',
                                level: i
                            }))
                        ],
                        onSelect: item => {
                            hls.currentLevel = item.level;
                            return item.html;
                        }
                    });
                });

                /* AUDIO */
                hls.on(Hls.Events.AUDIO_TRACKS_UPDATED, (_, data) => {
                    if (data.audioTracks.length > 1) {
                        art.setting.add({
                            name: 'audio',
                            html: 'Audio',
                            selector: data.audioTracks.map((t, i) => ({
                                html: t.name || t.lang || `Track ${i}`,
                                index: i,
                                default: i === hls.audioTrack
                            })),
                            onSelect: item => {
                                hls.audioTrack = item.index;
                                return item.html;
                            }
                        });
                    }
                });
            }
        }
    }
});

/* =======================
   SUBTITLE SETTINGS
======================= */
if (subtitles.length) {
    art.setting.add({
        name: 'subtitle',
        html: 'Subtitles',
        selector: [
            { html: 'Off', url: '', default: true },
            ...subtitles
        ],
        onSelect: item => {
            art.subtitle.url = item.url || '';
            art.subtitle.show = !!item.url;
            return item.html;
        }
    });
}

})();
</script>
</body>
</html>
