<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<title>Netflix Style Player</title>

<style>
html, body {
    margin: 0;
    padding: 0;
    background: #000;
    height: 100%;
    font-family: Helvetica, Arial, sans-serif;
}

.artplayer-app {
    width: 100%;
    max-width: 960px;
    height: 540px;
    margin: 40px auto;
    background: #000;
    position: relative;
}

/* Netflix Header */
.netflix-header {
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    padding: 20px;
    z-index: 20;
    display: flex;
    align-items: center;
    gap: 12px;
    opacity: 0;
    transition: opacity .3s;
}
.art-state-show .netflix-header {
    opacity: 1;
}

.movie-title {
    color: #fff;
    font-size: 18px;
    font-weight: 500;
}

/* Center overlay buttons */
.netflix-overlay {
    position: absolute;
    inset: 0;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 120px;
    pointer-events: none;
    opacity: 0;
    transition: opacity .3s;
    z-index: 15;
}
.art-state-show .netflix-overlay {
    opacity: 1;
}

.netflix-btn {
    pointer-events: auto;
    cursor: pointer;
}
.netflix-btn img {
    width: 60px;
    height: 60px;
    opacity: .85;
    transition: transform .15s, opacity .2s;
}
.netflix-btn:active img {
    transform: scale(.9);
}
.play-center img {
    width: 90px;
    height: 90px;
}

/* Spinner */
.netflix-spinner {
    width: 64px;
    height: 64px;
    animation: spin 1.2s linear infinite;
}
@keyframes spin {
    to { transform: rotate(360deg); }
}

/* Subtitle style */
.art-subtitle {
    font-size: 22px !important;
    background: rgba(0,0,0,.55) !important;
    padding: 6px 12px;
    border-radius: 4px;
}
</style>
</head>

<body>

<div class="artplayer-app">
    <div class="netflix-header">
        <div class="movie-title" id="movieTitle">Loadingâ€¦</div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/@swarmcloud/hls/hls.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/artplayer@5.0.9/dist/artplayer.js"></script>

<script>
/* ===============================
   1ï¸âƒ£ READ QUERY PARAMS (FINAL)
================================ */
const params = new URLSearchParams(location.search);
const title   = params.get('title');
const imdbId  = params.get('id');
const season  = params.get('season');
const episode = params.get('episode');

if (!title || !imdbId) {
    alert('Missing title or imdb id');
    throw new Error('Missing params');
}

document.getElementById('movieTitle').textContent = title;

/* ===============================
   2ï¸âƒ£ FETCH STREAM FROM RENDER
================================ */
async function fetchStream() {
    const api = `https://u-1-1azw.onrender.com/api/get-stream?title=${encodeURIComponent(title)}`;
    const res = await fetch(api);
    const data = await res.json();
    return data.url;
}

/* ===============================
   3ï¸âƒ£ FETCH SUBTITLES (PROXY)
================================ */
async function fetchSubtitles() {
    let subApi;
    if (season && episode) {
        subApi = `https://sub.wyzie.ru/search?id=${imdbId}&season=${season}&episode=${episode}`;
    } else {
        subApi = `https://sub.wyzie.ru/search?id=${imdbId}`;
    }

    const res = await fetch(
        `https://workingg.vercel.app/api/proxy?url=${encodeURIComponent(subApi)}`
    );
    return res.json();
}

/* ===============================
   4ï¸âƒ£ INIT PLAYER (ONCE ONLY)
================================ */
(async () => {
    const rawM3u8 = await fetchStream();

    const m3u8Url =
        `https://workingg.vercel.app/api/proxy?url=${encodeURIComponent(rawM3u8)}`;

    const art = new Artplayer({
        container: '.artplayer-app',
        url: m3u8Url,
        type: 'm3u8',
        autoplay: true,
        playsInline: true,
        fullscreen: true,
        fullscreenWeb: true,
        autoSize: true,
        theme: '#e50914',
        setting: true,
        pip: true,
        mutex: true,
        lock: true,
        fastForward: true,
        playbackRate: true,
        aspectRatio: true,
        subtitleOffset: true,
        icons: {
            loading:
                '<img class="netflix-spinner" src="https://assets.nflxext.com/en_us/pages/wiplayer/site-spinner.png">'
        },
        layers: [
            {
                html: `
                <div class="netflix-overlay">
                    <div class="netflix-btn back-10">
                        <img src="https://rivestream.org/images/player/backward.svg">
                    </div>
                    <div class="netflix-btn play-center">
                        <img src="https://rivestream.org/images/player/play.svg">
                    </div>
                    <div class="netflix-btn forward-10">
                        <img src="https://rivestream.org/images/player/forward.svg">
                    </div>
                </div>`
            }
        ],
        customType: {
            m3u8: (video, url, art) => {
                if (art.hls) return; // ðŸ”´ NO RECONNECT LOOP

                const hls = new Hls({
                    enableWorker: true,
                    backBufferLength: 90
                });

                art.hls = hls;
                hls.loadSource(url);
                hls.attachMedia(video);

                /* QUALITY */
                hls.on(Hls.Events.MANIFEST_PARSED, () => {
                    art.setting.add({
                        name: 'quality',
                        html: 'Quality',
                        selector: [
                            { html: 'Auto', level: -1, default: true },
                            ...hls.levels.map((l, i) => ({
                                html: l.height + 'p',
                                level: i
                            }))
                        ],
                        onSelect: item => {
                            hls.currentLevel = item.level;
                            return item.html;
                        }
                    });
                });

                /* AUDIO */
                hls.on(Hls.Events.AUDIO_TRACKS_UPDATED, (_, data) => {
                    if (data.audioTracks.length > 1) {
                        art.setting.add({
                            name: 'audio',
                            html: 'Audio',
                            selector: data.audioTracks.map((t, i) => ({
                                html: t.name || t.lang || `Track ${i}`,
                                index: i,
                                default: i === hls.audioTrack
                            })),
                            onSelect: item => {
                                hls.audioTrack = item.index;
                                return item.html;
                            }
                        });
                    }
                });
            }
        }
    });

    /* ===============================
       5ï¸âƒ£ SUBTITLES INTO SETTINGS
    ================================ */
    const subs = await fetchSubtitles();
    if (subs && subs.length) {
        art.setting.add({
            name: 'subtitle',
            html: 'Subtitles',
            selector: subs.map((s, i) => ({
                html: s.lang || `Sub ${i}`,
                url: s.url
            })),
            onSelect: item => {
                art.subtitle.url = item.url;
                art.subtitle.show = true;
                return item.html;
            }
        });
    }

    /* ===============================
       6ï¸âƒ£ OVERLAY CONTROLS
    ================================ */
    const playBtn = document.querySelector('.play-center img');
    document.querySelector('.back-10').onclick = () => art.seek -= 10;
    document.querySelector('.forward-10').onclick = () => art.seek += 10;

    art.on('play', () => {
        playBtn.src = 'https://rivestream.org/images/player/play.svg';
    });
    art.on('pause', () => {
        playBtn.src = 'https://rivestream.org/images/player/play.svg';
    });
})();
</script>

</body>
</html>
