<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Netflix Player</title>

<!-- ArtPlayer 5.3.0 -->
<link rel="stylesheet" href="https://unpkg.com/artplayer@5.3.0/dist/artplayer.css">
<script src="https://unpkg.com/artplayer@5.3.0/dist/artplayer.js"></script>
<script src="https://unpkg.com/hls.js@1.5.17/dist/hls.min.js"></script>

<style>
html, body {
    margin: 0;
    padding: 0;
    background: black;
    height: 100%;
    overflow: hidden;
}

#player {
    width: 100%;
    height: 100%;
}

/* ===========================
   ✅ OG NETFLIX SPINNER ONLY
=========================== */
.netflix-spinner {
    position: fixed;
    inset: 0;
    display: flex;
    align-items: center;
    justify-content: center;
    background: black;
    z-index: 9999;
}
.netflix-spinner::after {
    content: "";
    width: 64px;
    height: 64px;
    border-radius: 50%;
    border: 5px solid rgba(255,255,255,0.2);
    border-top-color: #e50914;
    animation: spin 1s linear infinite;
}
@keyframes spin {
    to { transform: rotate(360deg); }
}

/* ===========================
   ✅ SUBTITLE FIX (IMPORTANT)
=========================== */
.art-subtitle {
    position: absolute !important;
    bottom: 10% !important;
    width: 90% !important;
    left: 50% !important;
    transform: translateX(-50%) !important;

    display: flex !important;
    justify-content: center !important;

    z-index: 10000 !important;
    pointer-events: none !important;

    font-size: 23px !important;
    font-weight: 500 !important;
    line-height: 1.4 !important;
    color: rgb(252, 244, 244) !important;

    text-align: center !important;
    text-shadow: 0 2px 4px rgba(0,0,0,0.8) !important;
    background: transparent !important;
}
</style>
</head>

<body>

<div id="player"></div>
<div id="spinner" class="netflix-spinner"></div>

<script>
/* ===========================
   CONFIG
=========================== */
const RENDER_API = "https://u-1-1azw.onrender.com/api/get-stream";
const PROXY = "https://workingg.vercel.app/api/proxy?url=";
const SUB_API = "https://sub.wyzie.ru/search";

/* ===========================
   HELPERS
=========================== */
const qs = k => new URLSearchParams(location.search).get(k);
const spinner = document.getElementById("spinner");

function showSpinner(v) {
    spinner.style.display = v ? "flex" : "none";
}

/* ===========================
   SLUG DETECTION
=========================== */
const title = qs("title");
const imdb = qs("id");
const season = qs("season");
const episode = qs("episode");

if (!title) {
    alert("Missing ?title=");
    throw new Error("No title");
}

/* ===========================
   FETCH STREAM
=========================== */
async function getStream() {
    showSpinner(true);
    const api = `${RENDER_API}?title=${encodeURIComponent(title)}`;
    const res = await fetch(PROXY + encodeURIComponent(api));
    const json = await res.json();
    if (!json?.m3u8_url) throw "Stream error";
    return PROXY + encodeURIComponent(json.m3u8_url);
}

/* ===========================
   FETCH SUBTITLES
=========================== */
async function getSubs() {
    if (!imdb) return [];
    let url = `${SUB_API}?id=${imdb}`;
    if (season && episode) url += `&season=${season}&episode=${episode}`;
    const res = await fetch(PROXY + encodeURIComponent(url));
    const data = await res.json();
    return Array.isArray(data) ? data : [];
}

/* ===========================
   INIT PLAYER
=========================== */
(async () => {
    const stream = await getStream();
    const subs = await getSubs();

    const art = new Artplayer({
        container: "#player",
        url: stream,
        type: "m3u8",
        autoplay: true,
        fullscreen: true,
        setting: true,
        playbackRate: true,
        aspectRatio: true,
        hotkey: true,
        mutex: true,
        theme: "#e50914",
        subtitle: {
            show: true,
            url: subs[0]?.url ? PROXY + encodeURIComponent(subs[0].url) : "",
            type: "vtt",
        },
        customType: {
            m3u8(video, url) {
                const hls = new Hls({ enableWorker: true });
                hls.loadSource(url);
                hls.attachMedia(video);

                hls.on(Hls.Events.MANIFEST_PARSED, () => {
                    showSpinner(false);

                    /* QUALITY */
                    art.setting.add({
                        name: "quality",
                        html: "Quality",
                        selector: [
                            { html: "Auto", level: -1, default: true },
                            ...hls.levels.map((l, i) => ({
                                html: l.height + "p",
                                level: i
                            }))
                        ],
                        onSelect: i => {
                            hls.currentLevel = i.level;
                            return i.html;
                        }
                    });
                });

                /* AUDIO */
                hls.on(Hls.Events.AUDIO_TRACKS_UPDATED, (_, d) => {
                    if (d.audioTracks.length > 1) {
                        art.setting.add({
                            name: "audio",
                            html: "Audio",
                            selector: d.audioTracks.map((t, i) => ({
                                html: t.name || t.lang || `Track ${i}`,
                                index: i,
                                default: i === hls.audioTrack
                            })),
                            onSelect: i => {
                                hls.audioTrack = i.index;
                                return i.html;
                            }
                        });
                    }
                });
            }
        }
    });

    /* ===========================
       SUBTITLE SWITCHER (FIXED)
    ============================ */
    if (subs.length > 0) {
        art.setting.add({
            name: "subtitle",
            html: "Subtitles",
            selector: subs.map((s, i) => ({
                html: s.lang || `Subtitle ${i+1}`,
                url: PROXY + encodeURIComponent(s.url),
                default: i === 0
            })),
            onSelect(item) {
                art.subtitle.switch(item.url);
                art.subtitle.show = true;
                return item.html;
            }
        });
    }

    art.on("play", () => showSpinner(false));
    art.on("video:loadeddata", () => showSpinner(false));
})();
</script>

</body>
</html>
