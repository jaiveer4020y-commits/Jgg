<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta
  name="viewport"
  content="width=device-width, initial-scale=1, maximum-scale=1"
/>
<title>Player</title>

<!-- ================= ArtPlayer 5.3.0 ================= -->
<link
  rel="stylesheet"
  href="https://unpkg.com/artplayer@5.3.0/dist/artplayer.css"
/>

<script src="https://unpkg.com/hls.js@1.5.17/dist/hls.min.js"></script>
<script src="https://unpkg.com/artplayer@5.3.0/dist/artplayer.js"></script>

<style>
html, body {
  margin: 0;
  padding: 0;
  background: #000;
  width: 100%;
  height: 100%;
  overflow: hidden;
}

#player {
  width: 100%;
  height: 100%;
  background: #000;
}

/* Netflix-style spinner */
.netflix-spinner {
  position: absolute;
  top: 50%;
  left: 50%;
  width: 60px;
  height: 60px;
  border: 5px solid rgba(255,255,255,0.2);
  border-top-color: red;
  border-radius: 50%;
  transform: translate(-50%, -50%);
  animation: spin 1s linear infinite;
  z-index: 9999;
}

@keyframes spin {
  to { transform: translate(-50%, -50%) rotate(360deg); }
}
</style>
</head>

<body>

<div id="player"></div>
<div id="spinner" class="netflix-spinner"></div>

<script>
/* ================== CONFIG ================== */
const RENDER_API =
  "https://u-1-1azw.onrender.com/api/get-stream";

const PROXY =
  "https://workingg.vercel.app/api/proxy?url=";

const SUB_API =
  "https://sub.wyzie.ru/search";

/* ================== UTIL ================== */
function qs(name) {
  const u = new URLSearchParams(location.search);
  return u.get(name) || u.get(name?.toLowerCase());
}

function showSpinner(show) {
  document.getElementById("spinner").style.display =
    show ? "block" : "none";
}

/* ================== SLUG DETECTION ================== */
const title =
  qs("title") || qs("tittle");

const imdb =
  qs("id");

const season =
  qs("season");

const episode =
  qs("episode");

if (!title) {
  alert("Missing title in URL");
  throw new Error("Title not found");
}

/* ================== FETCH STREAM ================== */
async function fetchStream() {
  showSpinner(true);

  const apiUrl =
    `${RENDER_API}?title=${encodeURIComponent(title)}`;

  const res = await fetch(PROXY + encodeURIComponent(apiUrl));
  const data = await res.json();

  if (!data || !data.success || !data.m3u8_url) {
    throw new Error("Stream not found");
  }

  return PROXY + encodeURIComponent(data.m3u8_url);
}

/* ================== FETCH SUBTITLES ================== */
async function fetchSubtitles() {
  if (!imdb) return [];

  let url = `${SUB_API}?id=${imdb}`;
  if (season && episode) {
    url += `&season=${season}&episode=${episode}`;
  }

  const res = await fetch(PROXY + encodeURIComponent(url));
  const data = await res.json();

  if (!Array.isArray(data)) return [];

  return data.map((s) => ({
    name: s.lang || "Subtitle",
    url: PROXY + encodeURIComponent(s.url),
    type: "vtt",
  }));
}

/* ================== INIT PLAYER ================== */
(async () => {
  const videoUrl = await fetchStream();
  const subtitles = await fetchSubtitles();

  const art = new Artplayer({
    container: "#player",
    url: videoUrl,
    autoplay: true,
    muted: false,
    pip: true,
    airplay: true,
    fullscreen: true,
    fullscreenWeb: true,
    playbackRate: true,
    aspectRatio: true,
    setting: true,
    hotkey: true,
    mutex: true,
    autoSize: true,
    fastForward: true,
    autoPlayback: true,
    volume: 0.8,
    subtitle: {
      url: subtitles[0]?.url || "",
      type: "vtt",
      style: {
        color: "#fff",
        fontSize: "20px",
        background: "rgba(0,0,0,0.4)",
      },
    },
    settings: [
      {
        name: "Subtitles",
        html: "Select",
        selector: subtitles.map((s) => ({
          name: s.name,
          value: s.url,
        })),
        onSelect(item) {
          art.subtitle.switch(item.value);
          return item.name;
        },
      },
    ],
    customType: {
      m3u8(video, url) {
        if (Hls.isSupported()) {
          const hls = new Hls({
            enableWorker: true,
            lowLatencyMode: false,
            backBufferLength: 90,
          });
          hls.loadSource(url);
          hls.attachMedia(video);

          hls.on(Hls.Events.MANIFEST_PARSED, () => {
            showSpinner(false);
          });

          art.hls = hls;
        } else if (video.canPlayType("application/vnd.apple.mpegurl")) {
          video.src = url;
        }
      },
    },
  });

  art.on("ready", () => {
    showSpinner(false);
  });

  art.on("error", () => {
    showSpinner(false);
  });

})();
</script>

</body>
</html>
