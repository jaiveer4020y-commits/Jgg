<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Netflix ArtPlayer</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<link rel="stylesheet" href="https://unpkg.com/artplayer@5.3.0/dist/artplayer.css">
<script src="https://unpkg.com/artplayer@5.3.0/dist/artplayer.js"></script>
<script src="https://unpkg.com/hls.js@1.5.17/dist/hls.min.js"></script>

<style>
html,body{
    margin:0;
    background:#000;
    height:100%;
    overflow:hidden;
}

/* PLAYER */
#player{
    width:100%;
    height:100%;
    position:relative;
}

/* NETFLIX OG SPINNER */
.loading-spinner-container{
    position:absolute;
    inset:0;
    display:flex;
    align-items:center;
    justify-content:center;
    background:#000;
    z-index:9999;
}
.loading-spinner-container img{
    width:64px;
    height:64px;
}

/* SUBTITLE CONTAINER (NETFLIX STYLE) */
#subtitle-layer{
    position:absolute;
    bottom:10%;
    left:50%;
    transform:translateX(-50%);
    width:90%;
    text-align:center;
    pointer-events:none;
    z-index:10000;
}
#subtitle-layer span{
    display:inline-block;
    font-size:23px;
    font-weight:500;
    color:#fcf4f4;
    line-height:1.4;
    text-shadow:0 2px 4px rgba(0,0,0,.8);
    white-space:pre-wrap;
}
</style>
</head>

<body>

<div id="player"></div>

<div id="subtitle-layer">
    <span></span>
</div>

<div class="loading-spinner-container" id="spinner">
    <img src="https://assets.nflxext.com/en_us/pages/wiplayer/site-spinner.png">
</div>

<script>
/* ================= CONFIG ================= */
const RENDER_API = "https://u-1-1azw.onrender.com/api/get-stream";
const SUB_API = "https://sub.wyzie.ru/search";
const PROXY = "https://workingg.vercel.app/api/proxy?url=";

const qs = k => new URLSearchParams(location.search).get(k);
const spinner = document.getElementById("spinner");
const subtitleSpan = document.querySelector("#subtitle-layer span");

/* ================= SLUG ================= */
const TITLE = qs("title");
const IMDB = qs("id");
const SEASON = qs("season");
const EPISODE = qs("episode");

if(!TITLE){
    alert("Missing ?title=");
    throw new Error("No title");
}

/* ================= HELPERS ================= */
function showSpinner(v){ spinner.style.display = v ? "flex" : "none"; }

function toSeconds(t){
    const p=t.replace(",",".").split(":");
    return (+p[0])*3600+(+p[1])*60+parseFloat(p[2]);
}

function parseVTT(vtt){
    const cues=[];
    vtt.split("\n\n").forEach(b=>{
        if(!b.includes("-->"))return;
        const l=b.split("\n");
        const [s,e]=l[0].split(" --> ");
        cues.push({start:toSeconds(s),end:toSeconds(e),text:l.slice(1).join("\n")});
    });
    return cues;
}

/* ================= FETCH STREAM ================= */
async function getStream(){
    showSpinner(true);
    const api = `${RENDER_API}?title=${encodeURIComponent(TITLE)}`;
    const r = await fetch(PROXY + encodeURIComponent(api));
    const j = await r.json();
    return PROXY + encodeURIComponent(j.m3u8_url);
}

/* ================= FETCH SUBS ================= */
async function getSubs(){
    if(!IMDB) return [];
    let u = `${SUB_API}?id=${IMDB}`;
    if(SEASON && EPISODE) u += `&season=${SEASON}&episode=${EPISODE}`;
    const r = await fetch(PROXY + encodeURIComponent(u));
    const j = await r.json();

    return j.map(s=>{
        const name =
            s.language ||
            s.lang ||
            s.label ||
            s.name ||
            "Subtitle";

        return {
            name,
            url: PROXY + encodeURIComponent(s.url)
        };
    });
}

/* ================= MAIN ================= */
(async()=>{
const stream = await getStream();
const subs = await getSubs();
let cues=[], activeCue=null;

const art = new Artplayer({
    container:"#player",
    url:stream,
    type:"m3u8",
    autoplay:true,
    setting:true,
    hotkey:true,
    pip:true,
    fullscreen:true,
    playbackRate:true,
    aspectRatio:true,
    screenshot:true,
    lock:true,
    mutex:true,
    autoPlayback:true,
    theme:"#e50914",
    icons:{ loading:"" },   // disable default spinner

    customType:{
        m3u8(video,url){
            const hls = new Hls();
            hls.loadSource(url);
            hls.attachMedia(video);

            hls.on(Hls.Events.MANIFEST_PARSED,()=>{
                showSpinner(false);

                art.setting.add({
                    name:"quality",
                    html:"Quality",
                    selector:[
                        {html:"Auto",level:-1,default:true},
                        ...hls.levels.map((l,i)=>({html:l.height+"p",level:i}))
                    ],
                    onSelect:i=>{hls.currentLevel=i.level;return i.html;}
                });
            });

            hls.on(Hls.Events.AUDIO_TRACKS_UPDATED,(_,d)=>{
                if(d.audioTracks.length>1){
                    art.setting.add({
                        name:"audio",
                        html:"Audio",
                        selector:d.audioTracks.map((t,i)=>({
                            html:t.name||t.lang||`Track ${i}`,
                            index:i,
                            default:i===hls.audioTrack
                        })),
                        onSelect:i=>{hls.audioTrack=i.index;return i.html;}
                    });
                }
            });
        }
    }
});

/* ===== SUBTITLE SETTING ===== */
if(subs.length){
    art.setting.add({
        name:"subtitle",
        html:"Subtitles",
        selector:subs.map((s,i)=>({
            html:s.name,
            url:s.url,
            default:i===0
        })),
        onSelect:async i=>{
            const r = await fetch(i.url);
            cues = parseVTT(await r.text());
            subtitleSpan.textContent="";
            return i.html;
        }
    });

    // auto load first
    const r = await fetch(subs[0].url);
    cues = parseVTT(await r.text());
}

/* ===== SYNC SUBTITLE ===== */
art.on("video:timeupdate",()=>{
    const t=art.currentTime;
    const c=cues.find(x=>t>=x.start && t<=x.end);
    if(c && c!==activeCue){
        subtitleSpan.textContent=c.text;
        activeCue=c;
    }else if(!c){
        subtitleSpan.textContent="";
        activeCue=null;
    }
});
})();
</script>
</body>
</html>
