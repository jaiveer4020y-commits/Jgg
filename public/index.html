<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>CINEMA QUANTUM ENGINE | V13.0 TITAN EDITION</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    
    <link rel="stylesheet" href="https://unpkg.com/artplayer@5.3.0/dist/artplayer.css">
    <script src="https://unpkg.com/hls.js@1.5.17/dist/hls.min.js"></script>
    <script src="https://unpkg.com/artplayer@5.3.0/dist/artplayer.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800;900&family=Outfit:wght@300;400;600;800&display=swap" rel="stylesheet">

    <style>
        /* ================================================================
        1. TITAN DESIGN SYSTEM (TDS) - CINEMATIC GLASSMORPHISM
        ================================================================
        */
        :root {
            --nf-red: #E50914;
            --nf-black: #050505;
            --nf-dark-grey: #141414;
            --accent-glow: rgba(229, 9, 20, 0.5);
            --glass: rgba(10, 10, 10, 0.85);
            --blur: blur(40px);
            --font-main: 'Inter', sans-serif;
            --font-display: 'Outfit', sans-serif;
            --transition-fluid: cubic-bezier(0.23, 1, 0.32, 1);
        }

        /* RESET & SCROLLBARS */
        * { box-sizing: border-box; -webkit-font-smoothing: antialiased; outline: none !important; }
        ::-webkit-scrollbar { width: 5px; }
        ::-webkit-scrollbar-track { background: #000; }
        ::-webkit-scrollbar-thumb { background: var(--nf-red); border-radius: 10px; }

        body, html {
            margin: 0; padding: 0; width: 100vw; height: 100vh;
            background-color: var(--nf-black); color: #fff;
            font-family: var(--font-main); overflow: hidden;
            user-select: none;
        }

        /* ================================================================
        2. KINETIC ANIMATIONS
        ================================================================
        */
        @keyframes netflix-spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        @keyframes titan-fade-in {
            from { opacity: 0; transform: scale(1.05); }
            to { opacity: 1; transform: scale(1); }
        }

        @keyframes slide-up-ui {
            from { transform: translateY(50px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }

        @keyframes pulse-red {
            0% { text-shadow: 0 0 10px rgba(229, 9, 20, 0.4); }
            50% { text-shadow: 0 0 25px rgba(229, 9, 20, 0.8); }
            100% { text-shadow: 0 0 10px rgba(229, 9, 20, 0.4); }
        }

        /* ================================================================
        3. QUANTUM DASHBOARD ARCHITECTURE
        ================================================================
        */
        #dashboard-layer {
            position: fixed; inset: 0; z-index: 100;
            background: radial-gradient(circle at 50% -20%, #2a0505 0%, #050505 100%);
            display: flex; align-items: center; justify-content: center;
            transition: transform 1.2s var(--transition-fluid), opacity 0.8s;
        }

        .dashboard-exit { transform: translateY(-100%) scale(1.1); opacity: 0; pointer-events: none; }

        .titan-container {
            width: 90%; max-width: 550px; padding: 60px;
            background: var(--glass); backdrop-filter: var(--blur);
            border: 1px solid rgba(255,255,255,0.08); border-radius: 40px;
            box-shadow: 0 50px 100px rgba(0,0,0,0.9);
            animation: titan-fade-in 1s ease-out;
        }

        .titan-brand {
            text-align: center; margin-bottom: 45px;
        }

        .titan-brand h1 {
            font-family: var(--font-display); font-size: 3.2rem; font-weight: 900;
            color: var(--nf-red); letter-spacing: -4px; text-transform: uppercase;
            margin: 0; animation: pulse-red 3s infinite;
        }

        .mode-switcher {
            display: flex; gap: 10px; margin-bottom: 35px;
            background: rgba(0,0,0,0.6); padding: 8px; border-radius: 20px;
        }

        .mode-opt {
            flex: 1; padding: 15px; border: none; border-radius: 15px;
            background: transparent; color: #555; font-weight: 800;
            text-transform: uppercase; letter-spacing: 2px; cursor: pointer;
            transition: all 0.4s var(--transition-fluid); font-size: 12px;
        }

        .mode-opt.active { background: var(--nf-red); color: #fff; box-shadow: 0 10px 20px rgba(229, 9, 20, 0.3); }

        .form-group { margin-bottom: 30px; position: relative; }
        .form-group label {
            display: block; font-size: 11px; font-weight: 900; color: var(--nf-red);
            text-transform: uppercase; margin-bottom: 15px; letter-spacing: 3px;
        }

        .titan-input {
            width: 100%; padding: 20px; background: #000; border: 1px solid #222;
            border-radius: 18px; color: #fff; font-size: 17px; font-family: var(--font-main);
            transition: all 0.3s;
        }

        .titan-input:focus { border-color: var(--nf-red); box-shadow: 0 0 0 5px rgba(229, 9, 20, 0.15); }

        .search-bridge {
            position: absolute; top: 100%; left: 0; right: 0;
            background: #080808; border: 1px solid #1a1a1a; border-radius: 20px;
            margin-top: 15px; max-height: 350px; overflow-y: auto;
            z-index: 1000; display: none; box-shadow: 0 30px 60px rgba(0,0,0,0.9);
        }

        .search-node {
            display: flex; gap: 20px; padding: 15px; border-bottom: 1px solid #111;
            cursor: pointer; align-items: center; transition: background 0.2s;
        }

        .search-node:hover { background: #111; }
        .search-node img { width: 50px; height: 75px; border-radius: 8px; object-fit: cover; }
        .search-meta h5 { margin: 0; font-size: 16px; font-family: var(--font-display); }
        .search-meta p { margin: 5px 0 0; font-size: 13px; color: #666; font-weight: 600; }

        .launch-trigger {
            width: 100%; padding: 24px; background: var(--nf-red); color: #fff;
            border: none; border-radius: 18px; font-weight: 900; font-size: 18px;
            text-transform: uppercase; letter-spacing: 4px; cursor: pointer;
            transition: all 0.3s; box-shadow: 0 15px 30px rgba(229, 9, 20, 0.4);
        }

        .launch-trigger:active { transform: scale(0.96); }

        /* ================================================================
        4. LOADING HUB (TMDB LOGO + SMOOTH SPINNER)
        ================================================================
        */
        #loading-overlay {
            position: fixed; inset: 0; z-index: 900; background: #000;
            display: none; align-items: center; justify-content: center;
            flex-direction: column;
        }

        #loading-backdrop {
            position: absolute; inset: 0; width: 100%; height: 100%;
            object-fit: cover; opacity: 0; transition: opacity 2.5s ease-in-out;
            filter: brightness(0.2) blur(30px); transform: scale(1.15);
        }

        .loading-stack {
            z-index: 10; text-align: center; display: flex;
            flex-direction: column; align-items: center; gap: 50px;
            animation: titan-fade-in 1.2s forwards;
        }

        #tmdb-brand-logo {
            max-width: 350px; max-height: 180px; object-fit: contain;
            filter: drop-shadow(0 0 30px rgba(0,0,0,1));
            display: none;
        }

        .nf-spinner-wrap img {
            width: 85px; height: 85px;
            animation: netflix-spin 2s linear infinite;
        }

        #loading-status {
            font-size: 13px; color: var(--nf-red); font-weight: 900;
            text-transform: uppercase; letter-spacing: 6px;
        }

        /* ================================================================
        5. ARTPLAYER TITAN VIEWPORT & CUSTOM UI
        ================================================================
        */
        #player-viewport { 
            position: fixed; inset: 0; background: #000; 
            z-index: 1000; display: none; 
        }

        /* FORCED ICON STYLING - NO BG, MINIATURIZED */
        .mobileCenterControls_playerControlsInnerContainer__6MCmU {
            position: absolute; inset: 0; display: flex; align-items: center;
            justify-content: center; gap: 15vw; pointer-events: none;
            opacity: 0; transition: opacity 0.5s var(--transition-fluid);
            z-index: 60;
        }

        .art-hover .mobileCenterControls_playerControlsInnerContainer__6MCmU,
        .art-state-paused .mobileCenterControls_playerControlsInnerContainer__6MCmU { opacity: 1; }

        .btn-icon-logic {
            background: transparent !important;
            border: none; width: 40px; height: 40px; 
            display: flex; align-items: center; justify-content: center; 
            color: #fff; cursor: pointer; pointer-events: auto; 
            transition: 0.3s; filter: drop-shadow(0 0 10px rgba(0,0,0,0.8));
        }

        .btn-icon-logic:hover { transform: scale(1.3); color: var(--nf-red); }
        .btn-icon-logic svg { width: 28px; height: 28px; }
        
        #MainPlayBtn { width: 65px; height: 65px; }
        #MainPlayBtn svg { width: 40px; height: 40px; }

        /* EXIT BUTTON */
        .exit-nav {
            position: absolute; top: 40px; left: 40px; z-index: 10001;
            cursor: pointer; background: rgba(0,0,0,0.6); padding: 18px;
            border-radius: 50%; border: 1px solid rgba(255,255,255,0.1);
            transition: 0.4s var(--transition-fluid);
        }
        .exit-nav:hover { background: var(--nf-red); transform: translateX(-10px); }

        /* SETTINGS OVERRIDE */
        .art-settings { 
            background: rgba(5,5,5,0.96) !important; 
            backdrop-filter: blur(25px) !important; 
            border: 1px solid rgba(255,255,255,0.05) !important;
            border-radius: 20px !important;
        }
        .art-setting-item { height: 45px !important; font-size: 14px !important; font-weight: 700 !important; }
        .art-setting-item:hover { background: var(--nf-red) !important; }

    </style>
</head>
<body>

<div id="dashboard-layer">
    <div class="titan-container">
        <div class="titan-brand">
            <h1>Cinema Titan</h1>
        </div>
        
        <div class="mode-switcher">
            <button class="mode-opt active" id="opt-tv" onclick="handleMode('tv')">TV Series</button>
            <button class="mode-opt" id="opt-movie" onclick="handleMode('movie')">Feature Film</button>
        </div>

        <div class="form-group">
            <label>Master Search Interface</label>
            <input type="text" id="quantum-search" class="titan-input" placeholder="Enter title to begin..." autocomplete="off">
            <div id="bridge-results" class="search-bridge"></div>
        </div>

        <div id="tv-logic-gate">
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
                <div class="form-group">
                    <label>Season</label>
                    <input type="number" id="inp-s" class="titan-input" value="1" min="1">
                </div>
                <div class="form-group">
                    <label>Episode</label>
                    <input type="number" id="inp-e" class="titan-input" value="1" min="1">
                </div>
            </div>
        </div>

        <button class="launch-trigger" onclick="initializeTitanSequence()">Engage Playback</button>
    </div>
</div>

<div id="loading-overlay">
    <img id="loading-backdrop" src="">
    <div class="loading-stack">
        <img id="tmdb-brand-logo" src="">
        <div class="nf-spinner-wrap">
            <img src="https://assets.nflxext.com/en_us/pages/wiplayer/site-spinner.png" alt="Loading">
        </div>
        <div id="loading-status">Syncing Quantum Nodes...</div>
    </div>
</div>

<div id="player-viewport">
    <div class="exit-nav" onclick="killTitanEngine()">
        <svg viewBox="0 0 24 24" width="28" height="28" fill="white"><path d="M20 11H7.83l5.59-5.59L12 4l-8 8 8 8 1.41-1.41L7.83 13H20v-2z"/></svg>
    </div>
    <div id="artplayer-target" style="width:100%; height:100%;"></div>
</div>

<script>
/**
 * CINEMA QUANTUM ENGINE V13.0 - TITAN CORE
 * Logic: HLS Resolver, Wyzie Subtitle Scraper, Strict Settings Force
 */

const ENGINE = {
    TMDB_KEY: '463dcd7993ab31d92eb586802fdeee6a',
    PROXY: (u) => `https://workingg.vercel.app/api/proxy?url=${encodeURIComponent(u)}`,
    MODE: 'tv',
    ID: null,
    TITLE: '',
    YEAR: '',
    PLAYER: null,
    HLS: null,
    SLUG: '',
    SUBS: []
};

// 1. SEARCH INTELLIGENCE
const qSearch = document.getElementById('quantum-search');
const qBridge = document.getElementById('bridge-results');

qSearch.addEventListener('input', async (e) => {
    const val = e.target.value;
    if(val.length < 2) { qBridge.style.display = 'none'; return; }

    try {
        const r = await fetch(`https://api.themoviedb.org/3/search/multi?api_key=${ENGINE.TMDB_KEY}&query=${encodeURIComponent(val)}`);
        const data = await r.json();
        
        qBridge.innerHTML = '';
        if(data.results.length > 0) {
            qBridge.style.display = 'block';
            data.results.slice(0, 10).forEach(m => {
                if(m.media_type !== 'tv' && m.media_type !== 'movie') return;
                
                const yr = (m.release_date || m.first_air_date || '').split('-')[0];
                const node = document.createElement('div');
                node.className = 'search-node';
                node.innerHTML = `
                    <img src="https://image.tmdb.org/t/p/w92${m.poster_path}" onerror="this.src='https://via.placeholder.com/92x138/000/fff?text=?'">
                    <div class="search-meta">
                        <h5>${m.title || m.name}</h5>
                        <p>${m.media_type.toUpperCase()} â€¢ ${yr || 'N/A'}</p>
                    </div>
                `;
                node.onclick = () => {
                    ENGINE.ID = m.id;
                    ENGINE.TITLE = m.title || m.name;
                    ENGINE.YEAR = yr;
                    ENGINE.MODE = m.media_type;
                    qSearch.value = ENGINE.TITLE;
                    qBridge.style.display = 'none';
                    handleMode(ENGINE.MODE);
                };
                qBridge.appendChild(node);
            });
        }
    } catch(err) { console.error("Bridge Error", err); }
});

function handleMode(m) {
    ENGINE.MODE = m;
    document.querySelectorAll('.mode-opt').forEach(b => b.classList.remove('active'));
    document.getElementById(`opt-${m}`).classList.add('active');
    document.getElementById('tv-logic-gate').style.display = m === 'tv' ? 'block' : 'none';
}

// 2. QUANTUM SEQUENCE & SUBTITLE SCRAPER
async function initializeTitanSequence() {
    if(!ENGINE.ID) return alert("Identify a target title first.");

    const loader = document.getElementById('loading-overlay');
    loader.style.display = 'flex';
    document.getElementById('loading-status').innerText = "Acquiring Meta-Data...";

    // Metadata & Logo Fetching
    try {
        const [meta, imgs] = await Promise.all([
            fetch(`https://api.themoviedb.org/3/${ENGINE.MODE}/${ENGINE.ID}?api_key=${ENGINE.TMDB_KEY}`).then(r=>r.json()),
            fetch(`https://api.themoviedb.org/3/${ENGINE.MODE}/${ENGINE.ID}/images?api_key=${ENGINE.TMDB_KEY}`).then(r=>r.json())
        ]);

        if(meta.backdrop_path) {
            const bg = document.getElementById('loading-backdrop');
            bg.src = `https://image.tmdb.org/t/p/original${meta.backdrop_path}`;
            bg.style.opacity = '1';
        }

        const logoNode = document.getElementById('tmdb-brand-logo');
        const bestLogo = imgs.logos.find(l => l.file_path.endsWith('.png'));
        if(bestLogo) {
            logoNode.src = `https://image.tmdb.org/t/p/w500${bestLogo.file_path}`;
            logoNode.style.display = 'block';
        }
    } catch(e) { console.warn("Meta Fail"); }

    // SLUG LOGIC FIX
    const s = document.getElementById('inp-s').value;
    const e = document.getElementById('inp-e').value;
    const cleanTitle = ENGINE.TITLE.toLowerCase().replace(/[^a-z0-9\s]/gi, '').trim().replace(/\s+/g, '.');
    
    if(ENGINE.MODE === 'tv') {
        const sP = s.toString().padStart(2, '0');
        const eP = e.toString().padStart(2, '0');
        ENGINE.SLUG = `${cleanTitle}.s${sP}e${eP}`;
    } else {
        ENGINE.SLUG = `${cleanTitle}.${ENGINE.YEAR}`;
    }

    document.getElementById('loading-status').innerText = `Scraping Subs: ${ENGINE.SLUG}`;

    // SUBTITLE SCRAPING FROM sub.wyzie.ru
    try {
        const subRes = await fetch(ENGINE.PROXY(`https://sub.wyzie.ru/search?title=${encodeURIComponent(ENGINE.SLUG)}`)).then(r=>r.json());
        // Map wyzie results to Artplayer format
        if(subRes && Array.isArray(subRes)) {
            ENGINE.SUBS = subRes.map(sub => ({
                html: sub.lang || sub.language || 'Unknown',
                url: ENGINE.PROXY(sub.url),
                name: sub.lang
            }));
        }
    } catch(err) { console.warn("Subtitle Scrape Empty"); }

    document.getElementById('loading-status').innerText = "Connecting to Stream...";

    const streamApi = `https://u-1-1azw.onrender.com/api/get-stream?title=${encodeURIComponent(ENGINE.SLUG)}&id=${ENGINE.ID}&season=${s}&episode=${e}`;
    
    try {
        const data = await fetch(ENGINE.PROXY(streamApi)).then(r => r.json());
        if(data.m3u8_url) {
            launchTitanPlayer(ENGINE.PROXY(data.m3u8_url));
        } else {
            throw new Error();
        }
    } catch(err) {
        alert("Quantum Link Failed. Slug: " + ENGINE.SLUG);
        loader.style.display = 'none';
    }
}

// 3. ARTPLAYER TITAN BUILD (STRICT SETTINGS)
function launchTitanPlayer(m3u8) {
    document.getElementById('player-viewport').style.display = 'block';
    document.getElementById('loading-overlay').style.display = 'none';
    document.getElementById('dashboard-layer').classList.add('dashboard-exit');

    if(ENGINE.PLAYER) ENGINE.PLAYER.destroy();

    ENGINE.PLAYER = new Artplayer({
        container: '#artplayer-target',
        url: m3u8,
        type: 'm3u8',
        autoplay: true,
        autoSize: true,
        fullscreen: true,
        setting: true,
        theme: '#E50914',
        loadingShow: false, // Default loading hidden for our custom spinner
        icons: {
            loading: '<img class="netflix-spinner" src="https://assets.nflxext.com/en_us/pages/wiplayer/site-spinner.png" style="width:70px;">',
        },
        layers: [
            {
                name: 'titan-controls',
                html: `
                    <div class="mobileCenterControls_playerControlsInnerContainer__6MCmU">
                        <button class="btn-icon-logic" onclick="ENGINE.PLAYER.backward=10">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M11 17l-5-5 5-5M18 17l-5-5 5-5"/></svg>
                        </button>
                        <button id="MainPlayBtn" class="btn-icon-logic" onclick="ENGINE.PLAYER.toggle()">
                            <svg viewBox="0 0 24 24" fill="currentColor"><path d="M8 5v14l11-7z"/></svg>
                        </button>
                        <button class="btn-icon-logic" onclick="ENGINE.PLAYER.forward=10">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M13 17l5-5-5-5M6 17l5-5-5-5"/></svg>
                        </button>
                    </div>
                `
            }
        ],
        customType: {
            m3u8: function(video, url) {
                if (Hls.isSupported()) {
                    const hls = new Hls();
                    hls.loadSource(url);
                    hls.attachMedia(video);
                    ENGINE.HLS = hls;

                    hls.on(Hls.Events.MANIFEST_PARSED, () => {
                        // FORCED SETTINGS INJECTION
                        
                        // Audio Track Switcher
                        if(hls.audioTracks.length > 0) {
                            ENGINE.PLAYER.setting.add({
                                name: 'audio',
                                html: 'Audio Track',
                                selector: hls.audioTracks.map((t, i) => ({
                                    html: t.name || t.lang || `Track ${i+1}`,
                                    index: i,
                                    default: i === hls.audioTrack
                                })),
                                onSelect: (item) => { hls.audioTrack = item.index; return item.html; }
                            });
                        }

                        // Quality Switcher
                        const qLevels = hls.levels.map((l, i) => ({ html: `${l.height}P`, index: i }));
                        ENGINE.PLAYER.setting.add({
                            name: 'quality',
                            html: 'Resolution',
                            selector: [{html: 'Auto', index: -1, default: true}, ...qLevels],
                            onSelect: (item) => { hls.currentLevel = item.index; return item.html; }
                        });

                        // Subtitle Switcher (From Wyzie Scraper)
                        ENGINE.PLAYER.setting.add({
                            name: 'subtitle-switch',
                            html: 'Subtitles',
                            selector: [
                                {html: 'None', url: '', default: true},
                                ...ENGINE.SUBS
                            ],
                            onSelect: (item) => {
                                if(item.url) {
                                    ENGINE.PLAYER.subtitle.url = item.url;
                                    ENGINE.PLAYER.subtitle.show = true;
                                } else {
                                    ENGINE.PLAYER.subtitle.show = false;
                                }
                                return item.html;
                            }
                        });

                        // Subtitle Delay (Strict 1-5s)
                        ENGINE.PLAYER.setting.add({
                            name: 'sub-delay',
                            html: 'Subtitle Delay',
                            selector: [
                                {html: '-5.0s', val: -5}, {html: '-2.5s', val: -2.5},
                                {html: '0.0s', val: 0, default: true},
                                {html: '+2.5s', val: 2.5}, {html: '+5.0s', val: 5}
                            ],
                            onSelect: (item) => {
                                ENGINE.PLAYER.subtitleOffset = item.val;
                                return item.html;
                            }
                        });

                        // Aspect Ratio Logic
                        ENGINE.PLAYER.setting.add({
                            name: 'aspect',
                            html: 'Aspect Ratio',
                            selector: [
                                {html: 'Original', val: 'default', default: true},
                                {html: '16:9 Wide', val: '16:9'},
                                {html: '4:3 Classic', val: '4:3'},
                                {html: 'Zoom/Fill', val: 'fill'}
                            ],
                            onSelect: (item) => {
                                ENGINE.PLAYER.aspectRatio = item.val;
                                return item.html;
                            }
                        });
                    });
                } else if (video.canPlayType('application/vnd.apple.mpegurl')) {
                    video.src = url;
                }
            }
        }
    });

    // Play/Pause State Management for Custom Icons
    ENGINE.PLAYER.on('play', () => {
        const b = document.querySelector('#MainPlayBtn');
        if(b) b.innerHTML = '<svg viewBox="0 0 24 24" fill="currentColor"><path d="M6 19h4V5H6v14zm8-14v14h4V5h-4z"/></svg>';
    });
    ENGINE.PLAYER.on('pause', () => {
        const b = document.querySelector('#MainPlayBtn');
        if(b) b.innerHTML = '<svg viewBox="0 0 24 24" fill="currentColor"><path d="M8 5v14l11-7z"/></svg>';
    });
}

function killTitanEngine() {
    if(ENGINE.PLAYER) ENGINE.PLAYER.destroy();
    if(ENGINE.HLS) ENGINE.HLS.destroy();
    document.getElementById('player-viewport').style.display = 'none';
    document.getElementById('dashboard-layer').classList.remove('dashboard-exit');
    
    // Clear Meta
    const bg = document.getElementById('loading-backdrop');
    bg.style.opacity = '0';
    bg.src = '';
    ENGINE.SUBS = [];
}

</script>
</body>
</html>
