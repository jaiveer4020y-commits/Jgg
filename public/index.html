<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>ArtPlayer Full Working</title>

<meta name="viewport" content="width=device-width, initial-scale=1.0">

<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/artplayer@5/dist/artplayer.css">

<style>
html, body {
    margin: 0;
    padding: 0;
    background: #000;
    height: 100%;
    overflow: hidden;
    font-family: Arial, Helvetica, sans-serif;
}

#player-wrap {
    width: 100%;
    max-width: 960px;
    height: 540px;
    margin: 40px auto;
    background: #000;
    position: relative;
}

/* Center controls */
.center-controls {
    position: absolute;
    inset: 0;
    display: flex;
    justify-content: center;
    align-items: center;
    gap: 120px;
    opacity: 0;
    transition: opacity .25s;
    z-index: 20;
    pointer-events: none;
}

.art-state-show .center-controls {
    opacity: 1;
    pointer-events: auto;
}

.center-btn img {
    width: 64px;
    height: 64px;
    opacity: 0.9;
}

.center-btn.play img {
    width: 96px;
    height: 96px;
}

/* Subtitle style */
.art-subtitle {
    font-size: 22px !important;
    color: #fff !important;
    text-shadow: 2px 2px 6px #000;
    background: rgba(0,0,0,0.45);
    padding: 4px 10px;
    border-radius: 4px;
}
</style>
</head>

<body>

<div id="player-wrap"></div>

<script src="https://cdn.jsdelivr.net/npm/@swarmcloud/hls/hls.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/artplayer@5/dist/artplayer.js"></script>

<script>
(async function () {

    /* ===============================
       1. READ QUERY
    =============================== */
    const qs = new URLSearchParams(location.search);
    const title = qs.get('title');

    if (!title) {
        document.body.innerHTML = '<h2 style="color:white;text-align:center">Missing ?title=</h2>';
        return;
    }

    /* ===============================
       2. FETCH STREAM FROM RENDER
    =============================== */
    const streamApi =
        'https://workingg.vercel.app/api/proxy?url=' +
        encodeURIComponent(
            'https://u-1-1azw.onrender.com/api/get-stream?title=' + title
        );

    let streamData;
    try {
        const res = await fetch(streamApi);
        streamData = await res.json();
    } catch (e) {
        alert('Stream API failed');
        return;
    }

    if (!streamData || !streamData.m3u8_url) {
        alert('Stream not found');
        return;
    }

    const proxiedM3u8 =
        'https://workingg.vercel.app/api/proxy?url=' +
        encodeURIComponent(streamData.m3u8_url);

    /* ===============================
       3. FETCH SUBTITLES
    =============================== */
    let subtitleUrl = null;

    if (streamData.imdb) {
        try {
            const subApi =
                'https://workingg.vercel.app/api/proxy?url=' +
                encodeURIComponent(
                    'https://sub.wyzie.ru/search?id=' + streamData.imdb
                );
            const subRes = await fetch(subApi);
            const subJson = await subRes.json();
            subtitleUrl = subJson?.subtitles?.[0]?.url || null;
        } catch {}
    }

    /* ===============================
       4. INIT ARTPLAYER (FULL)
    =============================== */
    const art = new Artplayer({
        container: '#player-wrap',
        url: proxiedM3u8,
        type: 'm3u8',

        autoplay: true,
        muted: true,          // REQUIRED FOR iOS
        autoSize: true,
        autoMini: false,

        setting: true,
        playbackRate: true,
        aspectRatio: true,
        fullscreen: true,
        fullscreenWeb: true,
        pip: true,
        airplay: true,
        lock: true,

        theme: '#e50914',

        subtitle: subtitleUrl ? {
            url: subtitleUrl,
            type: 'vtt',
            encoding: 'utf-8',
            style: true
        } : null,

        layers: [{
            name: 'center-controls',
            html: `
            <div class="center-controls">
                <div class="center-btn back">
                    <img src="https://rivestream.org/images/player/backward.svg">
                </div>
                <div class="center-btn play">
                    <img src="https://rivestream.org/images/player/play.svg">
                </div>
                <div class="center-btn forward">
                    <img src="https://rivestream.org/images/player/forward.svg">
                </div>
            </div>`
        }],

        customType: {
            m3u8(video, url, art) {
                if (!Hls.isSupported()) {
                    video.src = url;
                    return;
                }

                const hls = new Hls({
                    enableWorker: true,
                    lowLatencyMode: false,
                    fragLoadingMaxRetry: 3,
                    manifestLoadingMaxRetry: 2,
                    levelLoadingMaxRetry: 3
                });

                hls.loadSource(url);
                hls.attachMedia(video);

                art.hls = hls;

                hls.once(Hls.Events.MANIFEST_PARSED, () => {
                    const levels = hls.levels.map((l, i) => ({
                        html: l.height + 'p',
                        level: i
                    }));

                    art.setting.add({
                        name: 'quality',
                        html: 'Quality',
                        selector: levels,
                        onSelect(item) {
                            hls.currentLevel = item.level;
                            return item.html;
                        }
                    });
                });
            }
        }
    });

    /* ===============================
       5. CENTER CONTROL EVENTS
    =============================== */
    art.on('ready', () => {
        const play = document.querySelector('.center-btn.play');
        const back = document.querySelector('.center-btn.back');
        const forward = document.querySelector('.center-btn.forward');

        play.onclick = () => art.toggle();
        back.onclick = () => art.seek = art.currentTime - 10;
        forward.onclick = () => art.seek = art.currentTime + 10;

        // Unmute after user gesture
        play.addEventListener('click', () => {
            art.muted = false;
        });
    });

})();
</script>

</body>
</html>
