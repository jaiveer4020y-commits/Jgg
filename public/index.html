<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Pro Stream Engine | Clean URL System</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">

    <link rel="stylesheet" href="https://unpkg.com/artplayer@5.3.0/dist/artplayer.css">
    <script src="https://unpkg.com/hls.js@1.5.17/dist/hls.min.js"></script>
    <script src="https://unpkg.com/artplayer@5.3.0/dist/artplayer.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;900&display=swap" rel="stylesheet">

    <style>
        :root {
            --red: #e50914;
            --bg: #000;
            --panel: #111;
            --text: #fff;
        }

        body, html {
            margin: 0; padding: 0; background: var(--bg);
            color: var(--text); font-family: 'Inter', sans-serif;
            height: 100vh; width: 100vw; overflow: hidden;
        }

        /* --- UI LAYER --- */
        #app-ui {
            height: 100vh; display: flex; flex-direction: column; 
            align-items: center; justify-content: center; z-index: 10;
        }

        .control-panel {
            background: var(--panel); border: 1px solid #333; padding: 40px;
            border-radius: 16px; width: 90%; max-width: 550px; text-align: center;
        }

        .clean-url-display {
            background: #000; padding: 12px; border-radius: 8px; border: 1px solid #444;
            color: #007aff; font-family: monospace; margin-bottom: 25px; word-break: break-all;
        }

        input {
            width: 100%; padding: 16px; margin-bottom: 15px; background: #080808;
            border: 1px solid #333; border-radius: 8px; color: #fff; outline: none;
            box-sizing: border-box;
        }
        input:focus { border-color: var(--red); }

        .btn-launch {
            width: 100%; padding: 18px; background: var(--red); color: #fff;
            border: none; border-radius: 8px; font-weight: 900; cursor: pointer;
            text-transform: uppercase; margin-top: 10px;
        }

        /* --- LOADING LAYER --- */
        #loading-screen {
            position: fixed; inset: 0; background: #000; z-index: 9999;
            display: none; flex-direction: column; align-items: center; justify-content: center;
        }
        #load-backdrop {
            position: absolute; inset: 0; width: 100%; height: 100%;
            object-fit: cover; opacity: 0.3;
        }
        
        .spinner-corner {
            position: absolute; top: 30px; left: 30px; width: 50px; height: 50px;
            border: 4px solid rgba(229, 9, 20, 0.2); border-top: 4px solid var(--red);
            border-radius: 50%; animation: spin 0.8s linear infinite; z-index: 10000;
        }

        /* --- PLAYER --- */
        #player-container {
            position: fixed; inset: 0; background: #000; z-index: 10000;
            display: none; width: 100%; height: 100%;
        }

        .art-video-player { width: 100%; height: 100%; }

        /* Custom Subtitle & Icon Layers */
        .layer-controls {
            display: flex; gap: 60px; pointer-events: none; opacity: 0; transition: 0.3s;
            width: 100%; height: 100%; align-items: center; justify-content: center;
        }
        .art-state-show .layer-controls { opacity: 1; }
        .circle-btn {
            width: 80px; height: 80px; background: rgba(0,0,0,0.6); border-radius: 50%;
            display: flex; align-items: center; justify-content: center; pointer-events: auto;
            cursor: pointer; border: 1px solid rgba(255,255,255,0.2);
        }
        .circle-btn svg { width: 40px; fill: #fff; }

        .sub-display {
            position: absolute; bottom: 10%; width: 100%; text-align: center; pointer-events: none;
        }
        .sub-text {
            background: rgba(0,0,0,0.8); color: #fff; padding: 4px 16px; 
            border-radius: 4px; font-size: 24px; display: none;
        }

        /* Hides default spinner, shows corner one */
        .art-loading .art-loading-icon { display: none !important; }
        .art-loading .spinner-corner { display: block !important; }

        @keyframes spin { 100% { transform: rotate(360deg); } }
    </style>
</head>
<body>

<div id="app-ui">
    <h1 style="color:var(--red); text-transform:uppercase;">Stream Engine v4.0</h1>
    <div class="control-panel">
        <div class="clean-url-display" id="url-preview">/ ...</div>
        
        <input type="text" id="tmdb-id" placeholder="TMDB ID (e.g. 66732)" oninput="updateUrl()">
        <div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px;">
            <input type="number" id="season" placeholder="S" value="1" oninput="updateUrl()">
            <input type="number" id="episode" placeholder="E" value="1" oninput="updateUrl()">
        </div>
        
        <button class="btn-launch" onclick="manualStart()">Play Stream</button>
    </div>
</div>

<div id="loading-screen">
    <div class="spinner-corner"></div>
    <img id="load-backdrop" src="">
    <h2 id="status-text" style="position:relative; z-index:2;">INITIALIZING...</h2>
</div>

<div id="player-container">
    <div style="position:absolute; top:30px; right:30px; z-index:10001; color:#fff; cursor:pointer; font-size:24px; background:rgba(0,0,0,0.5); width:50px; height:50px; border-radius:50%; display:flex; align-items:center; justify-content:center; border:2px solid #fff;" onclick="closePlayer()">âœ•</div>
    <div id="artplayer" class="art-video-player"></div>
</div>

<script>
/** * CONFIGURATION & PROXY
 */
const API_KEY = '463dcd7993ab31d92eb586802fdeee6a';
const PROXY_BASE = 'https://workingg.vercel.app/api/proxy?url=';
const PROXY = (url) => `${PROXY_BASE}${encodeURIComponent(url)}`;

let player = null;
let subtitles = [];
let activeSub = null;

// AUTO-DETECT URL ON LOAD
window.onload = () => {
    const path = window.location.pathname.split('/').filter(Boolean);
    // Format: /id/season/episode or /id (for movie)
    if (path.length >= 1 && !isNaN(path[0])) {
        const id = path[0];
        const s = path[1] || 1;
        const e = path[2] || 1;
        const type = path.length > 1 ? 'tv' : 'movie';
        
        document.getElementById('tmdb-id').value = id;
        document.getElementById('season').value = s;
        document.getElementById('episode').value = e;
        
        startEngine(id, s, e, type);
    }
};

function updateUrl() {
    const id = document.getElementById('tmdb-id').value;
    const s = document.getElementById('season').value;
    const e = document.getElementById('episode').value;
    const url = id ? `/${id}/${s}/${e}` : '/waiting-for-input';
    document.getElementById('url-preview').innerText = window.location.origin + url;
    // Optional: history.pushState({}, '', url); // Uncomment to actually change URL bar
}

function manualStart() {
    const id = document.getElementById('tmdb-id').value;
    const s = document.getElementById('season').value;
    const e = document.getElementById('episode').value;
    if(!id) return alert("Enter ID");
    startEngine(id, s, e, 'tv'); // Defaulting manual to TV for this demo
}

/** * MAIN ENGINE LOGIC 
 */
async function startEngine(id, s, e, type) {
    const loadScreen = document.getElementById('loading-screen');
    loadScreen.style.display = 'flex';
    document.getElementById('status-text').innerText = "RESOLVING METADATA...";

    try {
        // 1. Get TMDB Data
        const metaUrl = `https://api.themoviedb.org/3/${type}/${id}?api_key=${API_KEY}`;
        const meta = await fetch(metaUrl).then(r => r.json());
        
        document.getElementById('load-backdrop').src = `https://image.tmdb.org/t/p/original${meta.backdrop_path || ''}`;

        // 2. Slug Generation Strategy
        // Clean Title: "Stranger Things" -> "stranger.things"
        const rawTitle = (meta.title || meta.name || '').toLowerCase();
        const cleanTitle = rawTitle.replace(/[^a-z0-9\s]/gi, '').trim().replace(/\s+/g, '.');

        // SLUG ATTEMPT 1: stranger.things (Just title, rely on S/E params)
        // SLUG ATTEMPT 2: stranger.things.s01.e01 (Dot padded)
        // SLUG ATTEMPT 3: stranger-things (Hyphenated)

        let streamData = null;
        const slugVariants = [
            cleanTitle,                                           // Try 1: stranger.things
            `${cleanTitle}.s${pad(s)}.e${pad(e)}`,                // Try 2: stranger.things.s01.e01
            rawTitle.replace(/\s+/g, '-')                         // Try 3: stranger-things
        ];

        document.getElementById('status-text').innerText = "HANDSHAKING SOURCE...";

        for (const slug of slugVariants) {
            console.log("Trying Slug:", slug);
            try {
                const api = `https://u-1-1azw.onrender.com/api/get-stream?title=${slug}&id=${id}&season=${s}&episode=${e}`;
                const res = await fetch(PROXY(api)).then(r => r.json());
                
                if (res.success !== false && res.m3u8_url) {
                    streamData = res;
                    break; // Success!
                }
            } catch (err) { console.log(err); }
        }

        if (!streamData) throw new Error("No Stream Found");

        // 3. Fetch Subtitles (Using your TMDB Proxy Logic)
        const subApi = `https://sub.wyzie.ru/search?id=${id}&season=${s}&episode=${e}`;
        const subData = await fetch(PROXY(subApi)).then(r => r.json()).catch(() => []);

        // 4. Mount Player
        initArtPlayer(PROXY(streamData.m3u8_url), subData, `${id}_${s}_${e}`);

    } catch (error) {
        alert("Error: " + error.message);
        loadScreen.style.display = 'none';
    }
}

/** * ARTPLAYER WITH ALL FEATURES
 */
function initArtPlayer(url, subs, saveKey) {
    document.getElementById('player-container').style.display = 'block';

    player = new Artplayer({
        container: '#artplayer',
        url: url,
        type: 'm3u8',
        autoplay: true,
        autoPlayback: true,
        fullscreen: true,
        
        // ENABLING ALL REQUESTED SETTINGS
        setting: true,
        flip: true,
        playbackRate: true,
        aspectRatio: true,
        subtitleOffset: true,
        lock: true,
        fastForward: true,

        theme: '#e50914',
        
        layers: [
            {
                name: 'corner-spinner',
                html: `<div class="spinner-corner"></div>`
            },
            {
                name: 'center-ui',
                html: `
                    <div class="layer-controls">
                        <div class="circle-btn" onclick="player.backward=10"><svg viewBox="0 0 24 24"><path d="M11 18V6l-8.5 6 8.5 6zm.5-6l8.5 6V6l-8.5 6z"/></svg></div>
                        <div class="circle-btn" onclick="player.toggle()"><svg viewBox="0 0 24 24"><path d="M8 5v14l11-7z"/></svg></div>
                        <div class="circle-btn" onclick="player.forward=10"><svg viewBox="0 0 24 24"><path d="M4 18l8.5-6L4 6v12zm9-12v12l8.5-6L13 6z"/></svg></div>
                    </div>
                `
            },
            {
                name: 'sub-render',
                html: `<div class="sub-display"><div class="sub-text" id="subtitle-box"></div></div>`
            }
        ],

        customType: {
            m3u8: function(video, url) {
                if (Hls.isSupported()) {
                    const hls = new Hls();
                    hls.loadSource(url);
                    hls.attachMedia(video);
                    hls.on(Hls.Events.MANIFEST_PARSED, () => {
                        
                        // 1. QUALITY SWITCHER
                        player.setting.add({
                            name: 'quality', html: 'Quality',
                            selector: [{html:'Auto', level:-1, default:true}, ...hls.levels.map((l,i) => ({html:l.height+'p', level:i}))],
                            onSelect: (i) => { hls.currentLevel = i.level; return i.html; }
                        });

                        // 2. AUDIO SWITCHER (If available)
                        if (hls.audioTracks.length > 1) {
                            player.setting.add({
                                name: 'audio', html: 'Audio Track',
                                selector: hls.audioTracks.map((t,i) => ({html: t.name||`Track ${i+1}`, index:i})),
                                onSelect: (i) => { hls.audioTrack = i.index; return i.html; }
                            });
                        }
                    });
                }
            }
        }
    });

    // Subtitle Processing
    player.on('ready', () => {
        const savedTime = localStorage.getItem('resume_' + saveKey);
        if(savedTime) player.currentTime = parseFloat(savedTime);

        if (subs.length > 0) {
            player.setting.add({
                name: 'subs', html: 'Subtitles',
                selector: [{html:'Off', url:null, default:true}, ...subs.map(s => ({html: s.lang || s.language, url: PROXY(s.url)}))],
                onSelect: async (item) => {
                    if(!item.url) { subtitles=[]; document.getElementById('subtitle-box').style.display='none'; return 'Off'; }
                    const txt = await fetch(item.url).then(r=>r.text());
                    subtitles = parseVtt(txt);
                    document.getElementById('subtitle-box').style.display='block';
                    return item.html;
                }
            });
        }
    });

    player.on('video:timeupdate', () => {
        localStorage.setItem('resume_' + saveKey, player.currentTime);
        if(!subtitles.length) return;
        const now = player.currentTime + (player.subtitleOffset || 0); // Apply Offset
        const cue = subtitles.find(c => now >= c.start && now <= c.end);
        const box = document.getElementById('subtitle-box');
        if(cue) {
            if(cue !== activeSub) { box.innerHTML = cue.text; activeSub = cue; }
        } else {
            box.innerHTML = ''; activeSub = null;
        }
    });

    player.on('video:playing', () => {
        document.getElementById('loading-screen').style.display = 'none';
    });
}

function closePlayer() {
    if(player) player.destroy();
    document.getElementById('player-container').style.display = 'none';
    document.getElementById('app-ui').style.display = 'flex';
}

function pad(n) { return n.toString().padStart(2, '0'); }

// VTT Parser
function parseVtt(text) {
    const items = [];
    const lines = text.split('\n');
    let curr = null;
    lines.forEach(l => {
        l = l.trim();
        if(l.includes('-->')) {
            const t = l.split('-->');
            curr = { start: t2s(t[0]), end: t2s(t[1]), text: [] };
        } else if(curr && l === '') {
            items.push({ ...curr, text: curr.text.join('<br>') });
            curr = null;
        } else if(curr) curr.text.push(l);
    });
    return items;
}
function t2s(str) {
    const p = str.trim().split(':');
    let h=0, m=0, s=0;
    if(p.length===3) [h,m,s]=p; else [m,s]=p;
    return (+h)*3600 + (+m)*60 + parseFloat(s);
}
</script>

</body>
</html>
