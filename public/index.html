<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>CINEMA TITAN V23.0 | ABSOLUTE FINAL</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    
    <link rel="stylesheet" href="https://unpkg.com/artplayer@5.1.1/dist/artplayer.css">
    <script src="https://unpkg.com/hls.js@1.5.17/dist/hls.min.js"></script>
    <script src="https://unpkg.com/artplayer@5.1.1/dist/artplayer.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;900&family=Outfit:wght@700;900&display=swap" rel="stylesheet">

    <style>
        :root {
            --n-red: #E50914;
            --text-primary: #fcf4f4;
        }

        body, html {
            margin: 0; padding: 0; width: 100vw; height: 100vh;
            background-color: #000; color: #fff;
            font-family: 'Inter', sans-serif; overflow: hidden;
            user-select: none;
        }

        /* 1. DASHBOARD & SEARCH UI */
        #titan-dashboard {
            position: fixed; inset: 0; z-index: 500;
            background: radial-gradient(circle at center, #220707 0%, #000 100%);
            display: flex; align-items: center; justify-content: center;
            transition: 0.8s cubic-bezier(0.7, 0, 0.3, 1);
        }
        .dashboard-inactive { transform: scale(1.1); opacity: 0; pointer-events: none; }

        .overlord-card {
            width: 95%; max-width: 580px; padding: 35px;
            background: rgba(15, 15, 15, 0.98); border-radius: 25px;
            border: 1px solid rgba(255,255,255,0.1);
            box-shadow: 0 40px 100px rgba(0,0,0,1);
        }

        .brand-logo {
            font-family: 'Outfit', sans-serif; font-size: 2.4rem; font-weight: 900;
            text-align: center; color: var(--n-red); margin-bottom: 25px;
            text-transform: uppercase; letter-spacing: -1px;
        }

        .mode-selector { display: flex; background: #000; padding: 6px; border-radius: 12px; margin-bottom: 20px; }
        .mode-btn {
            flex: 1; padding: 10px; border: none; background: transparent;
            color: #555; font-weight: 900; cursor: pointer; border-radius: 8px;
            transition: 0.3s; text-transform: uppercase; font-size: 11px;
        }
        .mode-btn.active { background: var(--n-red); color: #fff; }

        .search-container { position: relative; margin-bottom: 20px; }
        .titan-field {
            width: 100%; padding: 16px; background: #000; border: 1px solid #333;
            border-radius: 12px; color: #fff; font-size: 15px; outline: none;
        }
        .titan-field:focus { border-color: var(--n-red); }

        .results-panel {
            position: absolute; top: 105%; left: 0; right: 0; background: #0a0a0a;
            border-radius: 12px; max-height: 280px; overflow-y: auto; z-index: 600;
            display: none; border: 1px solid #222;
        }
        .result-row {
            display: flex; align-items: center; gap: 12px; padding: 10px;
            cursor: pointer; border-bottom: 1px solid #111;
        }
        .result-row:hover { background: #161616; }
        .result-row img { width: 35px; height: 50px; border-radius: 4px; object-fit: cover; }

        .meta-inputs { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 25px; }
        .label-hint { display: block; font-size: 10px; font-weight: 800; color: #555; text-transform: uppercase; margin-bottom: 6px; letter-spacing: 1px; }

        .init-btn {
            width: 100%; padding: 18px; background: var(--n-red); color: #fff;
            border: none; border-radius: 12px; font-weight: 900; cursor: pointer;
            text-transform: uppercase; letter-spacing: 1px;
        }

        /* 2. LOADING SCREEN */
        #loading-screen {
            position: fixed; inset: 0; z-index: 1000; background: #000;
            display: none; align-items: center; justify-content: center;
        }
        #loading-art { position: absolute; inset: 0; width: 100%; height: 100%; object-fit: cover; opacity: 0.3; filter: brightness(0.5); }
        @keyframes n-spin { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }

        /* 3. PLAYER VIEWPORT */
        #player-view { position: fixed; inset: 0; background: #000; z-index: 1500; display: none; }

        /* THE REQUESTED SUBTITLE CONTAINER */
        .SubtitleVideoCaption_mobileSubtitleContainer__vo_7_ {
            position: absolute; bottom: 12%; left: 50%; width: 90%;
            transform: translateX(-50%); display: flex; align-items: center;
            justify-content: space-evenly; transition: all 0.3s;
            pointer-events: none; z-index: 200;
        }
        .SubtitleVideoCaption_mobileSubtitleContainer__vo_7_ p {
            font-weight: 500; text-align: center; border-radius: 2px;
            white-space: pre-wrap; width: fit-content; line-height: normal;
            color: var(--text-primary); background-color: rgba(0, 0, 0, 0);
            font-size: 23px; text-shadow: 1px 1px 4px rgba(0,0,0,1), -1px -1px 4px rgba(0,0,0,1);
            display: none; /* Controlled by JS */
        }

        /* ORIGINAL ICON CENTER SYSTEM */
        .mobileCenterControls_playerControlsInnerContainer__6MCmU {
            position: absolute; inset: 0; display: flex; align-items: center;
            justify-content: center; gap: 15vw; pointer-events: none;
            opacity: 0; transition: opacity 0.3s; z-index: 150;
        }
        .art-hover .mobileCenterControls_playerControlsInnerContainer__6MCmU,
        .art-state-paused .mobileCenterControls_playerControlsInnerContainer__6MCmU { opacity: 1; }
        .art-state-loading .mobileCenterControls_playerControlsInnerContainer__6MCmU { display: none !important; }

        .og-ctrl { background: transparent; border: none; width: 60px; height: 60px; color: #fff; cursor: pointer; pointer-events: auto; }

        .top-back {
            position: absolute; top: 30px; left: 30px; z-index: 2000;
            cursor: pointer; background: rgba(0,0,0,0.4); padding: 10px; border-radius: 50%;
        }

    </style>
</head>
<body>

<div id="titan-dashboard">
    <div class="overlord-card">
        <div class="brand-logo">Titan Overlord</div>
        
        <div class="mode-selector">
            <button class="mode-btn active" id="m-tv" onclick="switchMode('tv')">Series</button>
            <button class="mode-btn" id="m-movie" onclick="switchMode('movie')">Movie</button>
        </div>

        <div class="search-container">
            <label class="label-hint">Neural Search</label>
            <input type="text" id="titan-query" class="titan-field" placeholder="Enter title name..." autocomplete="off">
            <div id="results-panel" class="results-panel"></div>
        </div>

        <div id="tv-logic" class="meta-inputs">
            <div>
                <label class="label-hint">Season</label>
                <input type="number" id="s-input" class="titan-field" value="1">
            </div>
            <div>
                <label class="label-hint">Episode</label>
                <input type="number" id="e-input" class="titan-field" value="1">
            </div>
        </div>

        <button class="init-btn" onclick="igniteOverlord()">Launch Stream</button>
    </div>
</div>

<div id="loading-screen">
    <img id="loading-art" src="">
    <img src="https://assets.nflxext.com/en_us/pages/wiplayer/site-spinner.png" style="width:75px; z-index:10; animation: n-spin 1.2s linear infinite;">
</div>

<div id="player-view">
    <div class="top-back" onclick="killOverlord()">
        <svg viewBox="0 0 24 24" width="28" height="28" fill="white"><path d="M20 11H7.83l5.59-5.59L12 4l-8 8 8 8 1.41-1.41L7.83 13H20v-2z"/></svg>
    </div>
    
    <div id="art-mount" style="width:100%; height:100%;"></div>
</div>

<script>
/**
 * TITAN V23.0 - OVERLORD
 * Fixed: Language Labels, Subtitle Container Structure, Logic Expansion.
 */

const OVERLORD = {
    TMDB: '463dcd7993ab31d92eb586802fdeee6a',
    PROXY: (u) => `https://workingg.vercel.app/api/proxy?url=${encodeURIComponent(u)}`,
    DATA: { mode: 'tv', id: null, title: '', year: '' },
    PLAYER: null,
    HLS: null,
    SUBS: []
};

// 1. SEARCH LOGIC
const qInput = document.getElementById('titan-query');
const rPanel = document.getElementById('results-panel');

qInput.addEventListener('input', async (e) => {
    const v = e.target.value;
    if(v.length < 2) { rPanel.style.display = 'none'; return; }
    try {
        const r = await fetch(`https://api.themoviedb.org/3/search/multi?api_key=${OVERLORD.TMDB}&query=${encodeURIComponent(v)}`);
        const d = await r.json();
        rPanel.innerHTML = '';
        if(d.results.length > 0) {
            rPanel.style.display = 'block';
            d.results.slice(0, 8).forEach(item => {
                if(item.media_type !== 'tv' && item.media_type !== 'movie') return;
                const row = document.createElement('div');
                row.className = 'result-row';
                row.innerHTML = `
                    <img src="https://image.tmdb.org/t/p/w92${item.poster_path}" onerror="this.src='https://via.placeholder.com/92x50/000/fff?text=?'">
                    <div>
                        <div style="font-weight:700; font-size:14px;">${item.title || item.name}</div>
                        <div style="font-size:11px; color:#555;">${(item.release_date || item.first_air_date || 'N/A').split('-')[0]}</div>
                    </div>
                `;
                row.onclick = () => {
                    OVERLORD.DATA.id = item.id;
                    OVERLORD.DATA.title = item.title || item.name;
                    OVERLORD.DATA.mode = item.media_type;
                    OVERLORD.DATA.year = (item.release_date || item.first_air_date || '').split('-')[0];
                    qInput.value = OVERLORD.DATA.title;
                    rPanel.style.display = 'none';
                    switchMode(OVERLORD.DATA.mode);
                };
                rPanel.appendChild(row);
            });
        }
    } catch(e) {}
});

function switchMode(m) {
    OVERLORD.DATA.mode = m;
    document.querySelectorAll('.mode-btn').forEach(b => b.classList.remove('active'));
    document.getElementById(`m-${m}`).classList.add('active');
    document.getElementById('tv-logic').style.display = m === 'tv' ? 'grid' : 'none';
}

// 2. BOOT SEQUENCE
async function igniteOverlord() {
    if(!OVERLORD.DATA.id) return alert("Overlord Alert: No target defined.");
    const veil = document.getElementById('loading-screen');
    veil.style.display = 'flex';

    try {
        const meta = await fetch(`https://api.themoviedb.org/3/${OVERLORD.DATA.mode}/${OVERLORD.DATA.id}?api_key=${OVERLORD.TMDB}`).then(r=>r.json());
        if(meta.backdrop_path) document.getElementById('loading-art').src = `https://image.tmdb.org/t/p/original${meta.backdrop_path}`;

        const s = document.getElementById('s-input').value;
        const e = document.getElementById('e-input').value;
        const slug = `${OVERLORD.DATA.title.toLowerCase().replace(/[^a-z0-9]/g,'.')}.${OVERLORD.DATA.mode === 'tv' ? `s${s.padStart(2,'0')}e${e.padStart(2,'0')}` : OVERLORD.DATA.year}`;

        // Subtitle Matrix (Language Mapping)
        try {
            let subApi = `https://sub.wyzie.ru/search?id=${OVERLORD.DATA.id}`;
            if(OVERLORD.DATA.mode === 'tv') subApi += `&season=${s}&episode=${e}`;
            const subRes = await fetch(OVERLORD.PROXY(subApi)).then(r => r.json());
            if(Array.isArray(subRes)) {
                OVERLORD.SUBS = subRes.map(i => ({ 
                    html: i.lang || 'Unknown Language', 
                    url: OVERLORD.PROXY(i.url),
                    label: i.lang 
                }));
            }
        } catch(e) {}

        const api = `https://u-1-1azw.onrender.com/api/get-stream?title=${encodeURIComponent(slug)}&id=${OVERLORD.DATA.id}&season=${s}&episode=${e}`;
        const sRes = await fetch(OVERLORD.PROXY(api)).then(r => r.json());
        
        if(sRes.m3u8_url) {
            bootPlayer(OVERLORD.PROXY(sRes.m3u8_url));
        } else {
            alert("Overlord: Stream Link Unresponsive.");
            veil.style.display = 'none';
        }
    } catch(err) {
        veil.style.display = 'none';
    }
}

// 3. PLAYER SYSTEM
function bootPlayer(m3u8) {
    document.getElementById('player-view').style.display = 'block';
    document.getElementById('loading-screen').style.display = 'none';
    document.getElementById('titan-dashboard').classList.add('dashboard-inactive');

    if(OVERLORD.PLAYER) OVERLORD.PLAYER.destroy();

    OVERLORD.PLAYER = new Artplayer({
        container: '#art-mount',
        url: m3u8,
        type: 'm3u8',
        autoplay: true,
        fullscreen: true,
        setting: true,
        theme: '#E50914',
        icons: {
            loading: '<img src="https://assets.nflxext.com/en_us/pages/wiplayer/site-spinner.png" style="width:70px; animation: n-spin 1.2s linear infinite;">'
        },
        layers: [
            {
                name: 'manual-sub-layer',
                html: `
                    <div class="SubtitleVideoCaption_mobileSubtitleContainer__vo_7_">
                        <p id="sub-p-node"></p>
                    </div>
                `
            },
            {
                name: 'og-controls',
                html: `
                    <div class="mobileCenterControls_playerControlsInnerContainer__6MCmU">
                        <button class="og-ctrl" onclick="OVERLORD.PLAYER.backward=10">
                            <svg viewBox="0 0 24 24" width="45" fill="white"><path d="M12.5 3c-4.97 0-9 4.03-9 9H1l4 4 4-4H6.5c0-3.03 2.47-5.5 5.5-5.5s5.5 2.47 5.5 5.5-2.47 5.5-5.5 5.5c-1.51 0-2.88-.61-3.88-1.59l-1.42 1.43C8.16 18.31 9.98 19 12 19c4.97 0 9-4.03 9-9s-4.03-9-9-9z"/></svg>
                        </button>
                        <button id="OverlordPlay" class="og-ctrl" style="width:100px; height:100px;" onclick="OVERLORD.PLAYER.toggle()">
                            <svg viewBox="0 0 24 24" width="70" fill="white"><path d="M8 5v14l11-7z"/></svg>
                        </button>
                        <button class="og-ctrl" onclick="OVERLORD.PLAYER.forward=10">
                            <svg viewBox="0 0 24 24" width="45" fill="white"><path d="M11.5 3c4.97 0 9 4.03 9 9h2.5l-4 4-4-4H17.5c0-3.03-2.47-5.5-5.5-5.5s-5.5 2.47-5.5 5.5 2.47 5.5 5.5 5.5c1.51 0 2.88-.61 3.88-1.59l1.42 1.43C15.84 18.31 14.02 19 12 19c-4.97 0-9-4.03-9-9s4.03-9 9-9z"/></svg>
                        </button>
                    </div>
                `
            }
        ],
        customType: {
            m3u8: function(video, url) {
                if (Hls.isSupported()) {
                    const hls = new Hls();
                    hls.loadSource(url);
                    hls.attachMedia(video);
                    OVERLORD.HLS = hls;

                    hls.on(Hls.Events.MANIFEST_PARSED, () => {
                        // 1. QUALITY MENU
                        if(hls.levels.length > 0) {
                            OVERLORD.PLAYER.setting.add({
                                name: 'quality',
                                html: 'Quality',
                                selector: [{html: 'Auto', index: -1, default: true}, ...hls.levels.map((l, i) => ({ html: `${l.height}P`, index: i }))],
                                onSelect: (item) => { hls.currentLevel = item.index; return item.html; }
                            });
                        }

                        // 2. AUDIO LANGUAGE MENU (FIXED LABELS)
                        if(hls.audioTracks.length > 0) {
                            OVERLORD.PLAYER.setting.add({
                                name: 'audio',
                                html: 'Audio Language',
                                selector: hls.audioTracks.map((t, i) => ({
                                    html: t.name || t.lang || `Language ${i+1}`,
                                    index: i,
                                    default: i === hls.audioTrack
                                })),
                                onSelect: (item) => { hls.audioTrack = item.index; return item.html; }
                            });
                        }

                        // 3. SUBTITLE LANGUAGE MENU (FIXED LABELS)
                        OVERLORD.PLAYER.setting.add({
                            name: 'subs',
                            html: 'Subtitles',
                            selector: [{html: 'Off', url: '', default: true}, ...OVERLORD.SUBS],
                            onSelect: (item) => {
                                if(item.url) {
                                    OVERLORD.PLAYER.subtitle.url = item.url;
                                    OVERLORD.PLAYER.subtitle.show = true;
                                } else {
                                    OVERLORD.PLAYER.subtitle.show = false;
                                    document.getElementById('sub-p-node').style.display = 'none';
                                }
                                return item.html;
                            }
                        });
                    });
                }
            }
        }
    });

    // THE MANUAL RENDERER (INJECTS INTO YOUR PROVIDED CONTAINER)
    OVERLORD.PLAYER.on('subtitleUpdate', (text) => {
        const pNode = document.getElementById('sub-p-node');
        if(text) {
            pNode.innerHTML = text;
            pNode.style.display = 'block';
        } else {
            pNode.style.display = 'none';
        }
    });

    OVERLORD.PLAYER.on('play', () => {
        document.querySelector('#OverlordPlay').innerHTML = '<svg viewBox="0 0 24 24" width="70" fill="white"><path d="M6 19h4V5H6v14zm8-14v14h4V5h-4z"/></svg>';
    });
    OVERLORD.PLAYER.on('pause', () => {
        document.querySelector('#OverlordPlay').innerHTML = '<svg viewBox="0 0 24 24" width="70" fill="white"><path d="M8 5v14l11-7z"/></svg>';
    });
}

function killOverlord() {
    if(OVERLORD.PLAYER) OVERLORD.PLAYER.destroy();
    if(OVERLORD.HLS) OVERLORD.HLS.destroy();
    document.getElementById('player-view').style.display = 'none';
    document.getElementById('titan-dashboard').classList.remove('dashboard-inactive');
    document.getElementById('sub-p-node').style.display = 'none';
}

</script>
</body>
</html>
