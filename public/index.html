<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Netflix Player</title>

<link rel="stylesheet" href="https://unpkg.com/artplayer@5.3.0/dist/artplayer.css">

<style>
html, body {
    margin: 0;
    padding: 0;
    background: #000;
    height: 100%;
}

/* PLAYER */
#player {
    width: 100%;
    max-width: 980px;
    height: 560px;
    margin: 40px auto;
    background: #000;
    position: relative;
}

/* NETFLIX SPINNER */
.loading-spinner-container {
    display: flex;
    align-items: center;
    justify-content: center;
    width: 64px;
    height: 64px;
}
.loading-spinner-container img {
    width: 64px;
    height: 64px;
    animation: spin 1.1s linear infinite;
}
@keyframes spin {
    from { transform: rotate(0deg); }
    to { transform: rotate(360deg); }
}

/* ===== SUBTITLE FIX (CRITICAL) ===== */
.art-subtitle {
    position: absolute !important;
    left: 50% !important;
    bottom: 12% !important;
    transform: translateX(-50%);
    width: 90%;
    text-align: center;
    z-index: 9999999 !important;
    pointer-events: none;
}

.art-subtitle-line {
    display: block !important;
}

.art-subtitle-line div {
    display: inline-block;
    padding: 4px 10px;
    font-size: 23px !important;
    line-height: 1.4;
    color: rgb(252, 244, 244) !important;
    background: rgba(0, 0, 0, 0.15);
    text-shadow: 0 2px 6px rgba(0,0,0,0.9);
    border-radius: 3px;
}
</style>
</head>

<body>

<div id="player"></div>

<script src="https://unpkg.com/hls.js@1.5.17/dist/hls.min.js"></script>
<script src="https://unpkg.com/artplayer@5.3.0/dist/artplayer.js"></script>

<script>
/* =========================
   URL PARAMS (SLUG)
========================= */
const q = new URLSearchParams(location.search);
const TITLE   = q.get('title');
const IMDB_ID = q.get('id');
const SEASON  = q.get('season');
const EPISODE = q.get('episode');

if (!TITLE) {
    alert("Missing title param");
    throw new Error("Title missing");
}

/* =========================
   PROXY
========================= */
const proxy = url =>
  'https://workingg.vercel.app/api/proxy?url=' + encodeURIComponent(url);

/* =========================
   STREAM
========================= */
async function getStream() {
    const r = await fetch(
        proxy(`https://u-1-1azw.onrender.com/api/get-stream?title=${TITLE}`)
    );
    const j = await r.json();
    if (!j.m3u8_url) throw new Error("No stream");
    return proxy(j.m3u8_url);
}

/* =========================
   SUBTITLES
========================= */
async function getSubs() {
    if (!IMDB_ID) return [];
    let url = `https://sub.wyzie.ru/search?id=${IMDB_ID}`;
    if (SEASON && EPISODE) {
        url += `&season=${SEASON}&episode=${EPISODE}`;
    }
    const r = await fetch(proxy(url));
    const s = await r.json();
    return s.map(x => ({
        html: x.lang || x.language || 'Subtitle',
        url: proxy(x.url),
        type: x.url.endsWith('.srt') ? 'srt' : 'vtt'
    }));
}

/* =========================
   INIT
========================= */
(async () => {

const m3u8 = await getStream();
const subtitles = await getSubs();

const art = new Artplayer({
    container: '#player',
    url: m3u8,
    type: 'm3u8',
    autoplay: true,
    setting: true,
    fullscreen: true,
    fullscreenWeb: true,
    pip: true,
    playbackRate: true,
    aspectRatio: true,
    screenshot: true,
    miniProgressBar: true,
    mutex: true,
    backdrop: true,
    playsInline: true,
    resume: true,
    lock: true,
    fastForward: true,
    subtitleOffset: true,
    theme: '#e50914',

    subtitle: {
        show: true,
        type: 'vtt',
        style: {
            fontSize: '23px',
            color: '#fcf4f4'
        }
    },

    icons: {
        loading: `
        <div class="loading-spinner-container">
            <img src="https://assets.nflxext.com/en_us/pages/wiplayer/site-spinner.png">
        </div>`
    },

    customType: {
        m3u8(video, url) {
            if (Hls.isSupported()) {
                const hls = new Hls({ enableWorker: true });
                hls.loadSource(url);
                hls.attachMedia(video);
                art.hls = hls;

                hls.on(Hls.Events.MANIFEST_PARSED, () => {
                    art.setting.add({
                        name: 'quality',
                        html: 'Quality',
                        selector: [
                            { html: 'Auto', level: -1, default: true },
                            ...hls.levels.map((l, i) => ({
                                html: l.height + 'p',
                                level: i
                            }))
                        ],
                        onSelect: i => {
                            hls.currentLevel = i.level;
                            return i.html;
                        }
                    });
                });

                hls.on(Hls.Events.AUDIO_TRACKS_UPDATED, (_, d) => {
                    if (d.audioTracks.length > 1) {
                        art.setting.add({
                            name: 'audio',
                            html: 'Audio',
                            selector: d.audioTracks.map((t, i) => ({
                                html: t.name || t.lang || `Track ${i}`,
                                index: i,
                                default: i === hls.audioTrack
                            })),
                            onSelect: s => {
                                hls.audioTrack = s.index;
                                return s.html;
                            }
                        });
                    }
                });
            }
        }
    }
});

/* ===== SUBTITLE MENU ===== */
if (subtitles.length) {
    art.setting.add({
        name: 'subtitle',
        html: 'Subtitles',
        selector: [
            { html: 'Off', url: '', default: true },
            ...subtitles
        ],
        onSelect: item => {
            if (!item.url) {
                art.subtitle.show = false;
                art.subtitle.url = '';
                return 'Off';
            }
            art.subtitle.type = item.type;
            art.subtitle.url = item.url;
            art.subtitle.show = true;
            return item.html;
        }
    });
}

})();
</script>
</body>
</html>
