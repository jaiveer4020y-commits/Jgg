<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta
  name="viewport"
  content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"
/>

<title>Player</title>

<!-- ArtPlayer -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/artplayer/dist/artplayer.css">
<script src="https://cdn.jsdelivr.net/npm/artplayer/dist/artplayer.js"></script>

<!-- HLS -->
<script src="https://cdn.jsdelivr.net/npm/hls.js@1.5.8/dist/hls.min.js"></script>

<style>
html, body {
  margin: 0;
  padding: 0;
  background: black;
  width: 100%;
  height: 100%;
  overflow: hidden;
}

#player {
  width: 100vw;
  height: 100vh;
  background: black;
}

/* Netflix spinner */
.netflix-spinner {
  position: absolute;
  width: 80px;
  height: 80px;
  border: 6px solid rgba(255,255,255,.2);
  border-top-color: red;
  border-radius: 50%;
  animation: spin 1s linear infinite;
  top: 50%;
  left: 50%;
  transform: translate(-50%, -50%);
  z-index: 9999;
}

@keyframes spin {
  to { transform: rotate(360deg) translate(-50%, -50%); }
}

/* Jump buttons */
.jump-btn {
  position: absolute;
  top: 50%;
  width: 70px;
  height: 70px;
  transform: translateY(-50%);
  z-index: 20;
  opacity: 0.85;
}

.jump-left { left: 10%; }
.jump-right { right: 10%; }

.jump-btn img {
  width: 100%;
  height: 100%;
}
</style>
</head>

<body>

<div id="player"></div>
<div id="spinner" class="netflix-spinner"></div>

<!-- Jump Buttons -->
<div class="jump-btn jump-left" id="backward">
  <img src="https://rivestream.org/images/player/backward.svg">
</div>

<div class="jump-btn jump-right" id="forward">
  <img src="https://rivestream.org/images/player/forward.svg">
</div>

<script>
/* --------------------------------------------------
   PARAMS (title / tittle FIX)
-------------------------------------------------- */

const params = new URLSearchParams(location.search);

const title =
  params.get('title') ||
  params.get('tittle') ||
  '';

const imdbId = params.get('id') || '';
const season = params.get('season');
const episode = params.get('episode');

if (!title || !imdbId) {
  alert('Missing title or IMDB id');
  throw new Error('Missing parameters');
}

/* --------------------------------------------------
   API ENDPOINTS
-------------------------------------------------- */

const RENDER_API = 'https://u-1-1azw.onrender.com/api/get-stream';
const PROXY = 'https://workingg.vercel.app/api/proxy?url=';

/* --------------------------------------------------
   FETCH STREAM
-------------------------------------------------- */

async function fetchStream() {
  const url = `${RENDER_API}?title=${encodeURIComponent(title)}`;
  const res = await fetch(url);
  const data = await res.json();

  if (!data || !data.url) {
    throw new Error('Stream not found');
  }

  return data.url;
}

/* --------------------------------------------------
   FETCH SUBTITLES
-------------------------------------------------- */

async function fetchSubtitles() {
  let url = `https://sub.wyzie.ru/search?id=${imdbId}`;
  if (season && episode) {
    url += `&season=${season}&episode=${episode}`;
  }

  const res = await fetch(PROXY + encodeURIComponent(url));
  const data = await res.json();

  if (!Array.isArray(data)) return [];

  return data.map(s => ({
    html: s.lang,
    url: PROXY + encodeURIComponent(s.url),
    default: s.lang.toLowerCase().includes('english'),
  }));
}

/* --------------------------------------------------
   INIT PLAYER
-------------------------------------------------- */

(async () => {
  const streamUrl = await fetchStream();
  const subtitles = await fetchSubtitles();

  const art = new Artplayer({
    container: '#player',
    url: streamUrl,
    type: 'm3u8',
    autoplay: true,
    muted: false,
    autoSize: true,
    autoMini: false,
    loop: false,
    flip: true,
    playbackRate: true,
    aspectRatio: true,
    fullscreen: true,
    fullscreenWeb: true,
    pip: true,
    mutex: true,
    backdrop: true,
    hotkey: true,
    setting: true,
    airplay: true,
    fastForward: true,

    subtitle: {
      url: subtitles.find(s => s.default)?.url || '',
      type: 'vtt',
      style: {
        color: '#fff',
        fontSize: '20px',
        textShadow: '0 0 4px #000',
      },
    },

    settings: [
      {
        name: 'Subtitles',
        selector: subtitles,
        onSelect: item => {
          art.subtitle.switch(item.url);
          return item.html;
        }
      }
    ],

    customType: {
      m3u8(video, url) {
        if (window.hls) window.hls.destroy();

        if (Hls.isSupported()) {
          const hls = new Hls({
            enableWorker: true,
            backBufferLength: 90,
            xhrSetup(xhr, requestUrl) {
              if (!requestUrl.startsWith(PROXY)) {
                xhr.open(
                  'GET',
                  PROXY + encodeURIComponent(requestUrl),
                  true
                );
              }
            },
          });

          window.hls = hls;
          hls.loadSource(url);
          hls.attachMedia(video);
        } else if (video.canPlayType('application/vnd.apple.mpegurl')) {
          video.src = PROXY + encodeURIComponent(url);
        }
      }
    },
  });

  art.on('ready', () => {
    document.getElementById('spinner').style.display = 'none';
  });

  // Jump buttons
  backward.onclick = () => art.currentTime -= 10;
  forward.onclick = () => art.currentTime += 10;
})();
</script>

</body>
</html>
