<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<title>Netflix ArtPlayer</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<style>
html, body {
    margin: 0;
    background: #000;
    height: 100%;
    font-family: Helvetica, Arial, sans-serif;
}

.artplayer-app {
    width: 100%;
    max-width: 980px;
    height: 552px;
    margin: 40px auto;
    background: #000;
    position: relative;
}

/* Netflix spinner */
.netflix-spinner {
    width: 64px;
    height: 64px;
    animation: spin 1.1s linear infinite;
}
@keyframes spin {
    to { transform: rotate(360deg); }
}

/* Subtitle style */
.art-subtitle {
    font-size: 24px !important;
    color: #fff !important;
    background: rgba(0,0,0,.55);
    padding: 4px 12px;
    border-radius: 4px;
}
</style>
</head>

<body>

<div class="artplayer-app"></div>

<script src="https://cdn.jsdelivr.net/npm/@swarmcloud/hls/hls.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/artplayer@5.0.9/dist/artplayer.js"></script>

<script>
(async () => {

const params = new URLSearchParams(location.search);

// FIX title / tittle
const title =
    params.get('title') ||
    params.get('tittle') ||
    '';

const imdbId  = params.get('id');
const season  = params.get('season');
const episode = params.get('episode');

if (!title) {
    alert('Missing title');
    return;
}

/* ================= FETCH STREAM ================= */

const streamApi =
    `https://u-1-1azw.onrender.com/api/get-stream?title=${encodeURIComponent(title)}`;

const streamRes = await fetch(
    `https://workingg.vercel.app/api/proxy?url=${encodeURIComponent(streamApi)}`
);
const streamData = await streamRes.json();

if (!streamData.m3u8_url) {
    alert('Stream not found');
    return;
}

const STREAM_URL =
    `https://workingg.vercel.app/api/proxy?url=${encodeURIComponent(streamData.m3u8_url)}`;

/* ================= INIT PLAYER ================= */

let hlsInstance = null;

const art = new Artplayer({
    container: '.artplayer-app',
    url: STREAM_URL,
    type: 'm3u8',

    // KEEP ALL DEFAULT FEATURES
    autoplay: true,
    pip: true,
    screenshot: true,
    setting: true,
    playbackRate: true,
    aspectRatio: true,
    fullscreen: true,
    fullscreenWeb: true,
    miniProgressBar: true,
    mutex: true,
    backdrop: true,
    playsInline: true,
    airplay: true,
    lock: true,

    icons: {
        loading:
            '<img class="netflix-spinner" src="https://assets.nflxext.com/en_us/pages/wiplayer/site-spinner.png">'
    },

    customType: {
        m3u8(video, url) {
            if (hlsInstance) return;

            hlsInstance = new Hls({
                enableWorker: true,
                backBufferLength: 120,
                maxBufferLength: 60,
                maxMaxBufferLength: 120
            });

            hlsInstance.loadSource(url);
            hlsInstance.attachMedia(video);

            // QUALITY
            hlsInstance.on(Hls.Events.MANIFEST_PARSED, () => {
                art.setting.add({
                    name: 'quality',
                    html: 'Quality',
                    selector: [
                        { html: 'Auto', level: -1, default: true },
                        ...hlsInstance.levels.map((l, i) => ({
                            html: l.height + 'p',
                            level: i
                        }))
                    ],
                    onSelect: item => {
                        hlsInstance.currentLevel = item.level;
                        return item.html;
                    }
                });
            });

            // AUDIO
            hlsInstance.on(Hls.Events.AUDIO_TRACKS_UPDATED, (_, data) => {
                if (data.audioTracks.length > 1) {
                    art.setting.add({
                        name: 'audio',
                        html: 'Audio',
                        selector: data.audioTracks.map((t, i) => ({
                            html: t.name || t.lang || `Track ${i}`,
                            index: i,
                            default: i === hlsInstance.audioTrack
                        })),
                        onSelect: item => {
                            hlsInstance.audioTrack = item.index;
                            return item.html;
                        }
                    });
                }
            });
        }
    }
});

/* ================= SUBTITLES ================= */

if (imdbId) {
    const subApi = season && episode
        ? `https://sub.wyzie.ru/search?id=${imdbId}&season=${season}&episode=${episode}`
        : `https://sub.wyzie.ru/search?id=${imdbId}`;

    try {
        const subRes = await fetch(
            `https://workingg.vercel.app/api/proxy?url=${encodeURIComponent(subApi)}`
        );
        const subs = await subRes.json();

        const subtitleTracks = subs
            .filter(s => s.url && s.url.endsWith('.vtt'))
            .map(s => ({
                html: s.lang || 'Subtitle',
                url: `https://workingg.vercel.app/api/proxy?url=${encodeURIComponent(s.url)}`
            }));

        if (subtitleTracks.length) {
            art.setting.add({
                name: 'subtitle',
                html: 'Subtitles',
                selector: [
                    { html: 'Off', url: '', default: true },
                    ...subtitleTracks
                ],
                onSelect: item => {
                    art.subtitle.url = item.url;
                    return item.html;
                }
            });
        }
    } catch (e) {
        console.warn('Subtitle load failed');
    }
}

})();
</script>

</body>
</html>
